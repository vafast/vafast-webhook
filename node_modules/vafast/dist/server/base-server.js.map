{"version":3,"sources":["../../src/server/base-server.ts"],"sourcesContent":["import type { Middleware } from \"../types\";\n\n/**\n * æœåŠ¡å™¨åŸºç±»\n * åŒ…å«æ‰€æœ‰æœåŠ¡å™¨ç±»å‹çš„å…¬å…±é€»è¾‘\n */\nexport abstract class BaseServer {\n  protected globalMiddleware: Middleware[] = [];\n\n  use(mw: Middleware) {\n    this.globalMiddleware.push(mw);\n  }\n\n  /**\n   * æ‰“å°æ‰å¹³åŒ–åçš„è·¯ç”±ä¿¡æ¯ï¼Œç”¨äºè°ƒè¯•\n   */\n  protected logFlattenedRoutes(routes: any[], type: string = \"è·¯ç”±\"): void {\n    console.log(`ğŸš€ æ‰å¹³åŒ–åçš„${type}:`);\n    for (const route of routes) {\n      const method = route.method || \"GET\";\n      const path = route.fullPath || route.path;\n      console.log(`  ${method} ${path}`);\n      if (route.middlewareChain && route.middlewareChain.length > 0) {\n        console.log(`    ä¸­é—´ä»¶é“¾: ${route.middlewareChain.length} ä¸ª`);\n      }\n    }\n    console.log(\"\");\n  }\n\n  /**\n   * æ£€æµ‹è·¯ç”±å†²çª\n   * æ£€æŸ¥æ˜¯å¦æœ‰è·¯å¾„ç›¸åŒä½†æ–¹æ³•ä¸åŒçš„è·¯ç”±ï¼Œä»¥åŠæ½œåœ¨çš„è·¯å¾„å†²çª\n   */\n  protected detectRouteConflicts(routes: any[]): void {\n    const pathGroups = new Map<string, any[]>();\n\n    // æŒ‰è·¯å¾„åˆ†ç»„\n    for (const route of routes) {\n      const path = route.fullPath || route.path;\n      const method = route.method || \"GET\";\n      if (!pathGroups.has(path)) {\n        pathGroups.set(path, []);\n      }\n      pathGroups.get(path)!.push({ ...route, method });\n    }\n\n    // æ£€æŸ¥å†²çª\n    for (const [path, routeList] of pathGroups) {\n      if (routeList.length > 1) {\n        const methods = routeList.map((r) => r.method);\n        const uniqueMethods = [...new Set(methods)];\n\n        if (uniqueMethods.length === 1) {\n          // ç›¸åŒè·¯å¾„ã€ç›¸åŒæ–¹æ³• - è¿™æ˜¯å†²çªï¼\n          console.warn(\n            `âš ï¸  è·¯ç”±å†²çª: ${uniqueMethods[0]} ${path} å®šä¹‰äº† ${routeList.length} æ¬¡`,\n          );\n          routeList.forEach((route, index) => {\n            console.warn(`   ${index + 1}. ${route.method} ${path}`);\n          });\n        } else {\n          // ç›¸åŒè·¯å¾„ã€ä¸åŒæ–¹æ³• - è¿™æ˜¯æ­£å¸¸çš„\n          console.log(`â„¹ï¸  è·¯å¾„ ${path} æ”¯æŒæ–¹æ³•: ${uniqueMethods.join(\", \")}`);\n        }\n      }\n    }\n\n    // æ£€æŸ¥æ½œåœ¨çš„è·¯å¾„å†²çªï¼ˆåŠ¨æ€è·¯ç”±å¯èƒ½å†²çªï¼‰\n    this.detectDynamicRouteConflicts(routes);\n  }\n\n  /**\n   * æ£€æµ‹åŠ¨æ€è·¯ç”±çš„æ½œåœ¨å†²çª\n   */\n  private detectDynamicRouteConflicts(routes: any[]): void {\n    const dynamicRoutes = routes.filter((r) => {\n      const path = r.fullPath || r.path;\n      return path.includes(\":\") || path.includes(\"*\");\n    });\n\n    for (let i = 0; i < dynamicRoutes.length; i++) {\n      for (let j = i + 1; j < dynamicRoutes.length; j++) {\n        const route1 = dynamicRoutes[i];\n        const route2 = dynamicRoutes[j];\n        const method1 = route1.method || \"GET\";\n        const method2 = route2.method || \"GET\";\n\n        if (method1 === method2) {\n          const path1 = route1.fullPath || route1.path;\n          const path2 = route2.fullPath || route2.path;\n          // æ£€æŸ¥è·¯å¾„æ˜¯å¦å¯èƒ½å†²çª\n          if (this.pathsMayConflict(path1, path2)) {\n            console.warn(\n              `âš ï¸  æ½œåœ¨è·¯ç”±å†²çª: ${method1} ${path1} å¯èƒ½ä¸ ${path2} å†²çª`,\n            );\n          }\n        }\n      }\n    }\n  }\n\n  /**\n   * åˆ¤æ–­ä¸¤ä¸ªè·¯å¾„æ˜¯å¦å¯èƒ½å†²çª\n   */\n  private pathsMayConflict(path1: string, path2: string): boolean {\n    const parts1 = path1.split(\"/\").filter(Boolean);\n    const parts2 = path2.split(\"/\").filter(Boolean);\n\n    if (parts1.length !== parts2.length) return false;\n\n    for (let i = 0; i < parts1.length; i++) {\n      const p1 = parts1[i];\n      const p2 = parts2[i];\n\n      // å¦‚æœä¸¤ä¸ªéƒ¨åˆ†éƒ½æ˜¯é™æ€çš„ä¸”ä¸åŒï¼Œåˆ™ä¸ä¼šå†²çª\n      if (\n        !p1.startsWith(\":\") &&\n        !p1.startsWith(\"*\") &&\n        !p2.startsWith(\":\") &&\n        !p2.startsWith(\"*\") &&\n        p1 !== p2\n      ) {\n        return false;\n      }\n\n      // å¦‚æœä¸€ä¸ªæ˜¯é€šé…ç¬¦ï¼Œå¦ä¸€ä¸ªæ˜¯åŠ¨æ€å‚æ•°ï¼Œå¯èƒ½å†²çª\n      if (\n        (p1 === \"*\" && p2.startsWith(\":\")) ||\n        (p2 === \"*\" && p1.startsWith(\":\"))\n      ) {\n        return true;\n      }\n    }\n\n    return false;\n  }\n\n  /**\n   * è·¯å¾„åŒ¹é…\n   */\n  protected matchPath(pattern: string, path: string): boolean {\n    const patternParts = pattern.split(\"/\").filter(Boolean);\n    const pathParts = path.split(\"/\").filter(Boolean);\n\n    if (patternParts.length !== pathParts.length) {\n      return false;\n    }\n\n    for (let i = 0; i < patternParts.length; i++) {\n      if (\n        patternParts[i] !== pathParts[i] &&\n        !patternParts[i].startsWith(\":\")\n      ) {\n        return false;\n      }\n    }\n\n    return true;\n  }\n\n  /**\n   * æå–è·¯å¾„å‚æ•°\n   */\n  protected extractParams(\n    pattern: string,\n    path: string,\n  ): Record<string, string> {\n    const params: Record<string, string> = {};\n    const patternParts = pattern.split(\"/\").filter(Boolean);\n    const pathParts = path.split(\"/\").filter(Boolean);\n\n    for (let i = 0; i < patternParts.length; i++) {\n      if (patternParts[i].startsWith(\":\")) {\n        const paramName = patternParts[i].slice(1);\n        params[paramName] = pathParts[i];\n      }\n    }\n\n    return params;\n  }\n}\n"],"mappings":"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","names":[]}