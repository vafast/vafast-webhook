{"version":3,"sources":["../src/utils/response.ts","../src/middleware.ts"],"sourcesContent":["// src/response.ts\n\n/** 生成 JSON 响应 */\nexport function json(\n  data: unknown,\n  status = 200,\n  headers: HeadersInit = {},\n): Response {\n  const body = JSON.stringify(data);\n\n  // 优化：只在有自定义 headers 时才创建 Headers 对象\n  if (Object.keys(headers).length === 0) {\n    return new Response(body, {\n      status,\n      headers: { \"Content-Type\": \"application/json\" },\n    });\n  }\n\n  // 有自定义 headers 时才创建 Headers 对象\n  const h = new Headers({\n    \"Content-Type\": \"application/json\",\n    ...headers,\n  });\n\n  return new Response(body, {\n    status,\n    headers: h,\n  });\n}\n\n// JSON 响应的预创建 headers（避免每次创建）\nconst JSON_HEADERS = { \"Content-Type\": \"application/json\" };\nconst TEXT_HEADERS = { \"Content-Type\": \"text/plain\" };\n\n/**\n * 类型特化的响应映射\n * 根据返回值类型直接生成 Response，避免不必要的检查\n */\nexport function mapResponse(response: unknown): Response {\n  // 快速路径：已经是 Response\n  if (response instanceof Response) return response;\n\n  // 使用 constructor.name 进行类型判断（比 instanceof 更快）\n  switch (response?.constructor?.name) {\n    case \"String\":\n      return new Response(response as string, { headers: TEXT_HEADERS });\n\n    case \"Object\":\n    case \"Array\":\n      return new Response(JSON.stringify(response), { headers: JSON_HEADERS });\n\n    case \"Number\":\n    case \"Boolean\":\n      return new Response(String(response), { headers: TEXT_HEADERS });\n\n    case undefined:\n      // null 或 undefined\n      return new Response(null, { status: 204 });\n\n    case \"ReadableStream\":\n      return new Response(response as ReadableStream);\n\n    case \"Blob\":\n      return new Response(response as Blob);\n\n    case \"ArrayBuffer\":\n      return new Response(response as ArrayBuffer);\n\n    case \"Uint8Array\":\n      return new Response(response as unknown as BodyInit);\n\n    default:\n      // Promise 处理\n      if (response instanceof Promise) {\n        return response.then(mapResponse) as unknown as Response;\n      }\n      // 其他情况使用 JSON 序列化\n      return new Response(JSON.stringify(response), { headers: JSON_HEADERS });\n  }\n}\n\n/** 生成重定向响应 */\nexport function redirect(location: string, status: 301 | 302 = 302): Response {\n  return new Response(null, {\n    status,\n    headers: {\n      Location: location,\n    },\n  });\n}\n\n/** 生成纯文本响应 */\nexport function text(\n  content: string,\n  status = 200,\n  headers: HeadersInit = {},\n): Response {\n  const h = new Headers({\n    \"Content-Type\": \"text/plain; charset=utf-8\",\n    ...headers,\n  });\n\n  return new Response(content, {\n    status,\n    headers: h,\n  });\n}\n\n/** 生成HTML响应 */\nexport function html(\n  content: string,\n  status = 200,\n  headers: HeadersInit = {},\n): Response {\n  const h = new Headers({\n    \"Content-Type\": \"text/html; charset=utf-8\",\n    ...headers,\n  });\n\n  return new Response(content, {\n    status,\n    headers: h,\n  });\n}\n\n/** 生成空响应（204 No Content） */\nexport function empty(status = 204, headers: HeadersInit = {}): Response {\n  return new Response(null, {\n    status,\n    headers,\n  });\n}\n\n/** 生成流式响应 */\nexport function stream(\n  stream: ReadableStream,\n  status = 200,\n  headers: HeadersInit = {},\n): Response {\n  const h = new Headers({\n    \"Content-Type\": \"application/octet-stream\",\n    ...headers,\n  });\n\n  return new Response(stream, {\n    status,\n    headers: h,\n  });\n}\n","// src/middleware.ts\n\nimport { json, mapResponse } from \"./utils/response\";\n\nimport type { Handler, Middleware } from \"./types\";\n/** 中间件类型：使用 next() 传递给下一个处理 */\n\n/** Vafast 自定义错误类型 */\nexport class VafastError extends Error {\n  status: number;\n  type: string;\n  expose: boolean;\n\n  constructor(\n    message: string,\n    options: {\n      status?: number;\n      type?: string;\n      expose?: boolean;\n      cause?: unknown;\n    } = {},\n  ) {\n    super(message);\n    this.name = \"VafastError\";\n    this.status = options.status ?? 500;\n    this.type = options.type ?? \"internal_error\";\n    this.expose = options.expose ?? false;\n    if (options.cause) (this as any).cause = options.cause;\n  }\n}\n\n/**\n * 组合类型: 自动注入错误处理器进行中间件组合\n */\nexport function composeMiddleware(\n  middleware: Middleware[],\n  finalHandler: Handler,\n): (req: Request) => Promise<Response> {\n  const all = [errorHandler, ...middleware];\n\n  return function composedHandler(req: Request): Promise<Response> {\n    let i = -1;\n\n    const dispatch = (index: number): Promise<Response> => {\n      if (index <= i)\n        return Promise.reject(new Error(\"next() called multiple times\"));\n      i = index;\n\n      // 中间件阶段\n      if (index < all.length) {\n        const mw = all[index];\n        return Promise.resolve(mw(req, () => dispatch(index + 1)));\n      }\n\n      // 最终 handler - 使用 mapResponse 转换返回值\n      return Promise.resolve(finalHandler(req)).then(mapResponse);\n    };\n\n    return dispatch(0);\n  };\n}\n\n/** 默认包含的全局错误处理器 */\nconst errorHandler: Middleware = async (req, next) => {\n  try {\n    return await next();\n  } catch (err) {\n    console.error(\"未处理的错误:\", err);\n\n    if (err instanceof VafastError) {\n      return json(\n        {\n          error: err.type,\n          message: err.expose ? err.message : \"发生了一个错误\",\n        },\n        err.status,\n      );\n    }\n\n    return json({ error: \"internal_error\", message: \"出现了一些问题\" }, 500);\n  }\n};\n"],"mappings":"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","names":[]}