{"version":3,"sources":["../../src/utils/base64url.ts","../../src/auth/token.ts"],"sourcesContent":["export function base64urlEncode(str: string): string {\n  return btoa(str)\n    .replace(/=/g, \"\") // ✅ 删除填充\n    .replace(/\\+/g, \"-\")\n    .replace(/\\//g, \"_\");\n}\n\nexport function base64urlDecode(str: string): string {\n  const pad = str.length % 4 === 0 ? \"\" : \"=\".repeat(4 - (str.length % 4));\n  const base64 = str.replace(/-/g, \"+\").replace(/_/g, \"/\") + pad;\n  return atob(base64);\n}\n","// src/auth/token.ts\nimport { base64urlEncode, base64urlDecode } from \"../utils/base64url\";\n\n// 类型定义\nexport interface TokenPayload {\n  [key: string]: any;\n  exp?: number; // 过期时间戳\n  iat?: number; // 签发时间戳\n  sub?: string; // 主题（通常是用户ID）\n  aud?: string; // 受众\n  iss?: string; // 签发者\n}\n\nexport interface TokenResult {\n  payload: TokenPayload;\n  token: string;\n  expiresAt: number;\n}\n\nexport interface TokenOptions {\n  expiresIn?: number; // 过期时间（秒）\n  issuer?: string; // 签发者\n  audience?: string; // 受众\n  subject?: string; // 主题\n}\n\nexport class TokenError extends Error {\n  constructor(\n    message: string,\n    public code:\n      | \"INVALID_TOKEN\"\n      | \"EXPIRED_TOKEN\"\n      | \"INVALID_SIGNATURE\"\n      | \"MALFORMED_TOKEN\"\n      | \"INVALID_PAYLOAD\",\n  ) {\n    super(message);\n    this.name = \"TokenError\";\n  }\n}\n\nconst encoder = new TextEncoder();\n\n/** 使用 HMAC-SHA256 进行签名 */\nasync function sign(data: string, secret: string): Promise<string> {\n  const key = await crypto.subtle.importKey(\n    \"raw\",\n    encoder.encode(secret),\n    { name: \"HMAC\", hash: \"SHA-256\" },\n    false,\n    [\"sign\"],\n  );\n\n  const signature = await crypto.subtle.sign(\"HMAC\", key, encoder.encode(data));\n  return btoa(\n    String.fromCharCode.apply(null, Array.from(new Uint8Array(signature))),\n  );\n}\n\n/** 生成令牌 */\nexport async function generateToken(\n  payload: TokenPayload,\n  secret: string,\n  options: TokenOptions = {},\n): Promise<TokenResult> {\n  const { expiresIn = 3600, issuer, audience, subject } = options;\n\n  // 创建令牌载荷，强制使用当前时间\n  const now = Math.floor(Date.now() / 1000);\n  const tokenPayload: TokenPayload = {\n    ...payload,\n    iat: now,\n    exp: now + expiresIn,\n  };\n\n  // 添加可选字段\n  if (issuer) tokenPayload.iss = issuer;\n  if (audience) tokenPayload.aud = audience;\n  if (subject) tokenPayload.sub = subject;\n\n  const data = base64urlEncode(JSON.stringify(tokenPayload));\n  const sig = await sign(data, secret);\n  const token = `${data}.${base64urlEncode(sig)}`;\n\n  return {\n    payload: tokenPayload,\n    token,\n    expiresAt: tokenPayload.exp! * 1000, // 转换为毫秒\n  };\n}\n\n/** 验证令牌 */\nexport async function verifyToken(\n  token: string,\n  secret: string,\n): Promise<TokenPayload | null> {\n  try {\n    const [data, sig] = token.split(\".\");\n    if (!data || !sig) {\n      throw new TokenError(\"令牌格式无效\", \"MALFORMED_TOKEN\");\n    }\n\n    const expectedSig = await sign(data, secret);\n    const expected = base64urlEncode(expectedSig);\n\n    if (sig !== expected) {\n      throw new TokenError(\"令牌签名无效\", \"INVALID_SIGNATURE\");\n    }\n\n    const payload = JSON.parse(base64urlDecode(data)) as TokenPayload;\n\n    // 检查过期时间\n    if (payload.exp && Date.now() / 1000 > payload.exp) {\n      throw new TokenError(\"令牌已过期\", \"EXPIRED_TOKEN\");\n    }\n\n    return payload;\n  } catch (error) {\n    if (error instanceof TokenError) {\n      throw error;\n    }\n    throw new TokenError(\"令牌验证失败\", \"INVALID_TOKEN\");\n  }\n}\n\n/** 解析令牌（不验证签名） */\nexport function parseToken(token: string): TokenPayload | null {\n  try {\n    const [data] = token.split(\".\");\n    if (!data) return null;\n\n    return JSON.parse(base64urlDecode(data));\n  } catch {\n    return null;\n  }\n}\n\n/** 检查令牌是否过期 */\nexport function isTokenExpired(token: string): boolean {\n  const payload = parseToken(token);\n  if (!payload || !payload.exp) return true;\n\n  return Date.now() / 1000 > payload.exp;\n}\n\n/** 获取令牌剩余有效时间（秒） */\nexport function getTokenTimeRemaining(token: string): number {\n  const payload = parseToken(token);\n  if (!payload || !payload.exp) return 0;\n\n  const remaining = payload.exp - Date.now() / 1000;\n  return Math.max(0, Math.floor(remaining));\n}\n\n/** 刷新令牌 */\nexport async function refreshToken(\n  token: string,\n  secret: string,\n  options: TokenOptions = {},\n): Promise<TokenResult | null> {\n  try {\n    const payload = await verifyToken(token, secret);\n    if (!payload) return null;\n\n    // 移除时间相关字段，重新生成\n    const { exp, iat, ...cleanPayload } = payload;\n\n    // 添加延迟确保时间戳不同\n    await new Promise((resolve) => setTimeout(resolve, 10));\n\n    return await generateToken(cleanPayload, secret, options);\n  } catch {\n    return null;\n  }\n}\n\n/** 创建访问令牌和刷新令牌对 */\nexport async function createTokenPair(\n  payload: TokenPayload,\n  secret: string,\n  options: TokenOptions = {},\n): Promise<{\n  accessToken: TokenResult;\n  refreshToken: TokenResult;\n}> {\n  const accessToken = await generateToken(payload, secret, {\n    ...options,\n    expiresIn: options.expiresIn || 3600, // 1小时\n  });\n\n  const refreshToken = await generateToken(payload, secret, {\n    ...options,\n    expiresIn: 7 * 24 * 3600, // 7天\n  });\n\n  return { accessToken, refreshToken };\n}\n"],"mappings":"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","names":["refreshToken"]}