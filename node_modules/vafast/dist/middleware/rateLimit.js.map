{"version":3,"sources":["../../src/middleware.ts","../../src/middleware/rateLimit.ts"],"sourcesContent":["// src/middleware.ts\n\nimport { json, mapResponse } from \"./utils/response\";\n\nimport type { Handler, Middleware } from \"./types\";\n/** 中间件类型：使用 next() 传递给下一个处理 */\n\n/** Vafast 自定义错误类型 */\nexport class VafastError extends Error {\n  status: number;\n  type: string;\n  expose: boolean;\n\n  constructor(\n    message: string,\n    options: {\n      status?: number;\n      type?: string;\n      expose?: boolean;\n      cause?: unknown;\n    } = {},\n  ) {\n    super(message);\n    this.name = \"VafastError\";\n    this.status = options.status ?? 500;\n    this.type = options.type ?? \"internal_error\";\n    this.expose = options.expose ?? false;\n    if (options.cause) (this as any).cause = options.cause;\n  }\n}\n\n/**\n * 组合类型: 自动注入错误处理器进行中间件组合\n */\nexport function composeMiddleware(\n  middleware: Middleware[],\n  finalHandler: Handler,\n): (req: Request) => Promise<Response> {\n  const all = [errorHandler, ...middleware];\n\n  return function composedHandler(req: Request): Promise<Response> {\n    let i = -1;\n\n    const dispatch = (index: number): Promise<Response> => {\n      if (index <= i)\n        return Promise.reject(new Error(\"next() called multiple times\"));\n      i = index;\n\n      // 中间件阶段\n      if (index < all.length) {\n        const mw = all[index];\n        return Promise.resolve(mw(req, () => dispatch(index + 1)));\n      }\n\n      // 最终 handler - 使用 mapResponse 转换返回值\n      return Promise.resolve(finalHandler(req)).then(mapResponse);\n    };\n\n    return dispatch(0);\n  };\n}\n\n/** 默认包含的全局错误处理器 */\nconst errorHandler: Middleware = async (req, next) => {\n  try {\n    return await next();\n  } catch (err) {\n    console.error(\"未处理的错误:\", err);\n\n    if (err instanceof VafastError) {\n      return json(\n        {\n          error: err.type,\n          message: err.expose ? err.message : \"发生了一个错误\",\n        },\n        err.status,\n      );\n    }\n\n    return json({ error: \"internal_error\", message: \"出现了一些问题\" }, 500);\n  }\n};\n","// src/middleware/rateLimit.ts\n\nimport type { Middleware } from \"../types\";\nimport { VafastError } from \"../middleware\";\n\ninterface RateLimitOptions {\n  windowMs?: number; // 限制窗口（毫秒）\n  max?: number; // 最大请求数\n  keyFn?: (req: Request) => string;\n}\n\ntype Entry = {\n  count: number;\n  expires: number;\n};\n\nconst store = new Map<string, Entry>();\n\nexport function rateLimit(options: RateLimitOptions = {}): Middleware {\n  const windowMs = options.windowMs ?? 60_000; // 默认: 1分钟\n  const max = options.max ?? 30;\n  const keyFn = options.keyFn ?? getIP;\n\n  return async (req, next) => {\n    const key = keyFn(req);\n    const now = Date.now();\n\n    const entry = store.get(key);\n    if (entry && entry.expires > now) {\n      if (entry.count >= max) {\n        throw new VafastError(\"Too many requests\", {\n          status: 429,\n          type: \"rate_limit\",\n          expose: true,\n        });\n      }\n      entry.count += 1;\n    } else {\n      store.set(key, { count: 1, expires: now + windowMs });\n    }\n\n    return next();\n  };\n}\n\n// Edge 安全的 IP 获取\nfunction getIP(req: Request): string {\n  return (\n    req.headers.get(\"cf-connecting-ip\") || // Cloudflare\n    req.headers.get(\"x-forwarded-for\")?.split(\",\")[0]?.trim() || // Vercel\n    \"unknown\"\n  );\n}\n"],"mappings":";AAQO,IAAM,cAAN,cAA0B,MAAM;AAAA,EACrC;AAAA,EACA;AAAA,EACA;AAAA,EAEA,YACE,SACA,UAKI,CAAC,GACL;AACA,UAAM,OAAO;AACb,SAAK,OAAO;AACZ,SAAK,SAAS,QAAQ,UAAU;AAChC,SAAK,OAAO,QAAQ,QAAQ;AAC5B,SAAK,SAAS,QAAQ,UAAU;AAChC,QAAI,QAAQ,MAAO,CAAC,KAAa,QAAQ,QAAQ;AAAA,EACnD;AACF;;;ACbA,IAAM,QAAQ,oBAAI,IAAmB;AAE9B,SAAS,UAAU,UAA4B,CAAC,GAAe;AACpE,QAAM,WAAW,QAAQ,YAAY;AACrC,QAAM,MAAM,QAAQ,OAAO;AAC3B,QAAM,QAAQ,QAAQ,SAAS;AAE/B,SAAO,OAAO,KAAK,SAAS;AAC1B,UAAM,MAAM,MAAM,GAAG;AACrB,UAAM,MAAM,KAAK,IAAI;AAErB,UAAM,QAAQ,MAAM,IAAI,GAAG;AAC3B,QAAI,SAAS,MAAM,UAAU,KAAK;AAChC,UAAI,MAAM,SAAS,KAAK;AACtB,cAAM,IAAI,YAAY,qBAAqB;AAAA,UACzC,QAAQ;AAAA,UACR,MAAM;AAAA,UACN,QAAQ;AAAA,QACV,CAAC;AAAA,MACH;AACA,YAAM,SAAS;AAAA,IACjB,OAAO;AACL,YAAM,IAAI,KAAK,EAAE,OAAO,GAAG,SAAS,MAAM,SAAS,CAAC;AAAA,IACtD;AAEA,WAAO,KAAK;AAAA,EACd;AACF;AAGA,SAAS,MAAM,KAAsB;AACnC,SACE,IAAI,QAAQ,IAAI,kBAAkB;AAAA,EAClC,IAAI,QAAQ,IAAI,iBAAiB,GAAG,MAAM,GAAG,EAAE,CAAC,GAAG,KAAK;AAAA,EACxD;AAEJ;","names":[]}