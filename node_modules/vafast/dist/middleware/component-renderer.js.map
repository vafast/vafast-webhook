{"version":3,"sources":["../../src/middleware/component-renderer.ts"],"sourcesContent":["/**\n * 组件渲染中间件 - 专注 SSR\n * 支持 Vue 和 React 的服务端渲染\n */\n\n// Vue SSR 渲染\nconst renderVueSSR = async (\n  componentImport: () => Promise<any>,\n  req: Request,\n  preloadedDeps?: any,\n) => {\n  try {\n    // 使用预加载的依赖或动态导入\n    const { createSSRApp, renderToString } =\n      preloadedDeps ||\n      (await Promise.all([import(\"vue\"), import(\"@vue/server-renderer\")]).then(\n        ([vue, renderer]) => ({\n          createSSRApp: vue.createSSRApp,\n          renderToString: renderer.renderToString,\n        }),\n      ));\n\n    const componentModule = await componentImport();\n    const component = componentModule.default || componentModule;\n\n    const app = createSSRApp(component);\n\n    // 提供路由信息\n    app.provide(\"routeInfo\", {\n      params: (req as any).params || {},\n      query: Object.fromEntries(new URL(req.url).searchParams),\n      pathname: new URL(req.url).pathname,\n    });\n\n    const html = await renderToString(app);\n\n    return new Response(\n      `\n      <!doctype html>\n      <html>\n        <head>\n          <meta charset=\"utf-8\">\n          <title>Vue SSR App</title>\n        </head>\n        <body>\n          <div id=\"app\">${html}</div>\n          <script>\n            window.__ROUTE_INFO__ = {\n              params: ${JSON.stringify((req as any).params || {})},\n              query: ${JSON.stringify(Object.fromEntries(new URL(req.url).searchParams))},\n              pathname: '${new URL(req.url).pathname}'\n            };\n          </script>\n          <script type=\"module\" src=\"/client.js\"></script>\n        </body>\n      </html>\n    `,\n      {\n        headers: { \"Content-Type\": \"text/html; charset=utf-8\" },\n      },\n    );\n  } catch (error) {\n    console.error(\"Vue SSR 渲染失败:\", error);\n    return new Response(\n      `\n      <!doctype html>\n      <html>\n        <head><title>渲染错误</title></head>\n        <body>\n          <h1>Vue SSR 渲染失败</h1>\n          <p>错误信息: ${error instanceof Error ? error.message : \"未知错误\"}</p>\n        </body>\n      </html>\n    `,\n      { status: 500 },\n    );\n  }\n};\n\n// React SSR 渲染\nconst renderReactSSR = async (\n  componentImport: () => Promise<any>,\n  req: Request,\n  preloadedDeps?: any,\n) => {\n  try {\n    // 使用预加载的依赖或动态导入\n    const { createElement, renderToString } =\n      preloadedDeps ||\n      (await Promise.all([import(\"react\"), import(\"react-dom/server\")]).then(\n        ([react, renderer]) => ({\n          createElement: react.createElement,\n          renderToString: renderer.renderToString,\n        }),\n      ));\n\n    const componentModule = await componentImport();\n    const Component = componentModule.default || componentModule;\n\n    const content = createElement(Component, {\n      req,\n      params: (req as any).params || {},\n      query: Object.fromEntries(new URL(req.url).searchParams),\n    });\n\n    const html = renderToString(content);\n\n    return new Response(\n      `\n      <!doctype html>\n      <html>\n        <head>\n          <meta charset=\"utf-8\">\n          <title>React SSR App</title>\n        </head>\n        <body>\n          <div id=\"root\">${html}</div>\n          <script>\n            window.__ROUTE_INFO__ = {\n              params: ${JSON.stringify((req as any).params || {})},\n              query: ${JSON.stringify(Object.fromEntries(new URL(req.url).searchParams))},\n              pathname: '${new URL(req.url).pathname}'\n            };\n          </script>\n          <script type=\"module\" src=\"/client.js\"></script>\n        </body>\n      </html>\n    `,\n      {\n        headers: { \"Content-Type\": \"text/html; charset=utf-8\" },\n      },\n    );\n  } catch (error) {\n    console.error(\"React SSR 渲染失败:\", error);\n    return new Response(\n      `\n      <!doctype html>\n      <html>\n        <head><title>渲染错误</title></head>\n        <body>\n          <h1>React SSR 渲染失败</h1>\n          <p>错误信息: ${error instanceof Error ? error.message : \"未知错误\"}</p>\n        </body>\n      </html>\n    `,\n      { status: 500 },\n    );\n  }\n};\n\n// Vue 组件渲染器 - 专注 SSR\nexport const vueRenderer = (preloadedDeps?: any) => {\n  return async (req: Request, next: () => Promise<Response>) => {\n    (req as any).renderVue = async (componentImport: () => Promise<any>) => {\n      return await renderVueSSR(componentImport, req, preloadedDeps);\n    };\n    return next();\n  };\n};\n\n// React 组件渲染器 - 专注 SSR\nexport const reactRenderer = (preloadedDeps?: any) => {\n  return async (req: Request, next: () => Promise<Response>) => {\n    (req as any).renderReact = async (componentImport: () => Promise<any>) => {\n      return await renderReactSSR(componentImport, req, preloadedDeps);\n    };\n    return next();\n  };\n};\n"],"mappings":"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","names":[]}