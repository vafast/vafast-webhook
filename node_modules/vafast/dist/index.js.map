{"version":3,"sources":["../src/router.ts","../src/utils/response.ts","../src/middleware.ts","../src/server/base-server.ts","../src/router/radix-tree.ts","../src/utils/route-registry.ts","../src/server/server.ts","../src/middleware/component-router.ts","../src/utils/path-matcher.ts","../src/utils/html-renderer.ts","../src/utils/dependency-manager.ts","../src/server/component-server.ts","../src/server/server-factory.ts","../src/utils/parsers.ts","../src/utils/go-await.ts","../src/utils/validators/validators.ts","../src/utils/create-handler.ts","../src/utils/base64url.ts","../src/utils/handle.ts","../src/utils/request-validator.ts","../src/utils/formats.ts","../src/utils/sse.ts","../src/middleware/authMiddleware.ts","../src/middleware/rateLimit.ts","../src/middleware/cors.ts","../src/auth/token.ts","../src/middleware/auth.ts","../src/defineRoute.ts","../src/types/route.ts","../src/node-server/serve.ts","../src/node-server/request.ts","../src/node-server/response.ts","../src/index.ts"],"sourcesContent":["/**\n * è·¯ç”±å·¥å…·å‡½æ•°\n *\n * æä¾›è·¯ç”±å¤„ç†çš„åŸºç¡€å·¥å…·\n */\n\nimport type { Route, NestedRoute, FlattenedRoute, Middleware } from \"./types\";\n\n/**\n * æ‰å¹³åŒ–åµŒå¥—è·¯ç”±\n *\n * å°†åµŒå¥—è·¯ç”±ç»“æ„è½¬æ¢ä¸ºæ‰å¹³æ•°ç»„ï¼Œè®¡ç®—å®Œæ•´è·¯å¾„å’Œä¸­é—´ä»¶é“¾\n *\n * @example\n * ```typescript\n * const routes = flattenNestedRoutes([\n *   {\n *     path: \"/api\",\n *     middleware: [authMiddleware],\n *     children: [\n *       { path: \"/users\", method: \"GET\", handler: getUsers },\n *       { path: \"/users/:id\", method: \"GET\", handler: getUser },\n *     ],\n *   },\n * ]);\n * // ç»“æœ:\n * // [\n * //   { fullPath: \"/api/users\", method: \"GET\", ... },\n * //   { fullPath: \"/api/users/:id\", method: \"GET\", ... },\n * // ]\n * ```\n */\nexport function flattenNestedRoutes(\n  routes: (Route | NestedRoute)[],\n): FlattenedRoute[] {\n  const flattened: FlattenedRoute[] = [];\n\n  function processRoute(\n    route: Route | NestedRoute,\n    parentPath = \"\",\n    parentMiddleware: Middleware[] = [],\n  ): void {\n    // è®¡ç®—å½“å‰å®Œæ•´è·¯å¾„\n    const currentPath = normalizePath(parentPath + route.path);\n    // åˆå¹¶ä¸­é—´ä»¶é“¾\n    const currentMiddleware = [\n      ...parentMiddleware,\n      ...(route.middleware || []),\n    ];\n\n    if (\"method\" in route && \"handler\" in route) {\n      // å¶å­è·¯ç”±ï¼ˆæœ‰å¤„ç†å‡½æ•°ï¼‰\n      const leafRoute = route as Route;\n      flattened.push({\n        ...leafRoute,\n        fullPath: currentPath,\n        middlewareChain: currentMiddleware,\n      });\n    } else if (\"children\" in route && route.children) {\n      // åˆ†ç»„è·¯ç”±ï¼Œé€’å½’å¤„ç†å­è·¯ç”±\n      for (const child of route.children) {\n        processRoute(child, currentPath, currentMiddleware);\n      }\n    }\n  }\n\n  for (const route of routes) {\n    processRoute(route);\n  }\n\n  return flattened;\n}\n\n/**\n * æ ‡å‡†åŒ–è·¯å¾„\n *\n * - è§£ç  URL ç¼–ç å­—ç¬¦\n * - å»é™¤é‡å¤æ–œæ \n * - å¤„ç†ç»“å°¾æ–œæ \n *\n * @example\n * ```typescript\n * normalizePath(\"//api//users/\")  // \"/api/users\"\n * normalizePath(\"/api/%20test\")   // \"/api/ test\"\n * ```\n */\nexport function normalizePath(path: string): string {\n  // è§£ç  URL ç¼–ç \n  let normalized = decodeURIComponent(path);\n\n  // å»é™¤é‡å¤æ–œæ \n  normalized = normalized.replace(/\\/+/g, \"/\");\n\n  // ç©ºè·¯å¾„è½¬ä¸ºæ ¹è·¯å¾„\n  if (normalized === \"\") return \"/\";\n\n  // å»é™¤ç»“å°¾æ–œæ ï¼ˆæ ¹è·¯å¾„é™¤å¤–ï¼‰\n  if (normalized !== \"/\" && normalized.endsWith(\"/\")) {\n    normalized = normalized.slice(0, -1);\n  }\n\n  return normalized;\n}\n","// src/response.ts\n\n/** ç”Ÿæˆ JSON å“åº” */\nexport function json(\n  data: unknown,\n  status = 200,\n  headers: HeadersInit = {},\n): Response {\n  const body = JSON.stringify(data);\n\n  // ä¼˜åŒ–ï¼šåªåœ¨æœ‰è‡ªå®šä¹‰ headers æ—¶æ‰åˆ›å»º Headers å¯¹è±¡\n  if (Object.keys(headers).length === 0) {\n    return new Response(body, {\n      status,\n      headers: { \"Content-Type\": \"application/json\" },\n    });\n  }\n\n  // æœ‰è‡ªå®šä¹‰ headers æ—¶æ‰åˆ›å»º Headers å¯¹è±¡\n  const h = new Headers({\n    \"Content-Type\": \"application/json\",\n    ...headers,\n  });\n\n  return new Response(body, {\n    status,\n    headers: h,\n  });\n}\n\n// JSON å“åº”çš„é¢„åˆ›å»º headersï¼ˆé¿å…æ¯æ¬¡åˆ›å»ºï¼‰\nconst JSON_HEADERS = { \"Content-Type\": \"application/json\" };\nconst TEXT_HEADERS = { \"Content-Type\": \"text/plain\" };\n\n/**\n * ç±»å‹ç‰¹åŒ–çš„å“åº”æ˜ å°„\n * æ ¹æ®è¿”å›å€¼ç±»å‹ç›´æ¥ç”Ÿæˆ Responseï¼Œé¿å…ä¸å¿…è¦çš„æ£€æŸ¥\n */\nexport function mapResponse(response: unknown): Response {\n  // å¿«é€Ÿè·¯å¾„ï¼šå·²ç»æ˜¯ Response\n  if (response instanceof Response) return response;\n\n  // ä½¿ç”¨ constructor.name è¿›è¡Œç±»å‹åˆ¤æ–­ï¼ˆæ¯” instanceof æ›´å¿«ï¼‰\n  switch (response?.constructor?.name) {\n    case \"String\":\n      return new Response(response as string, { headers: TEXT_HEADERS });\n\n    case \"Object\":\n    case \"Array\":\n      return new Response(JSON.stringify(response), { headers: JSON_HEADERS });\n\n    case \"Number\":\n    case \"Boolean\":\n      return new Response(String(response), { headers: TEXT_HEADERS });\n\n    case undefined:\n      // null æˆ– undefined\n      return new Response(null, { status: 204 });\n\n    case \"ReadableStream\":\n      return new Response(response as ReadableStream);\n\n    case \"Blob\":\n      return new Response(response as Blob);\n\n    case \"ArrayBuffer\":\n      return new Response(response as ArrayBuffer);\n\n    case \"Uint8Array\":\n      return new Response(response as unknown as BodyInit);\n\n    default:\n      // Promise å¤„ç†\n      if (response instanceof Promise) {\n        return response.then(mapResponse) as unknown as Response;\n      }\n      // å…¶ä»–æƒ…å†µä½¿ç”¨ JSON åºåˆ—åŒ–\n      return new Response(JSON.stringify(response), { headers: JSON_HEADERS });\n  }\n}\n\n/** ç”Ÿæˆé‡å®šå‘å“åº” */\nexport function redirect(location: string, status: 301 | 302 = 302): Response {\n  return new Response(null, {\n    status,\n    headers: {\n      Location: location,\n    },\n  });\n}\n\n/** ç”Ÿæˆçº¯æ–‡æœ¬å“åº” */\nexport function text(\n  content: string,\n  status = 200,\n  headers: HeadersInit = {},\n): Response {\n  const h = new Headers({\n    \"Content-Type\": \"text/plain; charset=utf-8\",\n    ...headers,\n  });\n\n  return new Response(content, {\n    status,\n    headers: h,\n  });\n}\n\n/** ç”ŸæˆHTMLå“åº” */\nexport function html(\n  content: string,\n  status = 200,\n  headers: HeadersInit = {},\n): Response {\n  const h = new Headers({\n    \"Content-Type\": \"text/html; charset=utf-8\",\n    ...headers,\n  });\n\n  return new Response(content, {\n    status,\n    headers: h,\n  });\n}\n\n/** ç”Ÿæˆç©ºå“åº”ï¼ˆ204 No Contentï¼‰ */\nexport function empty(status = 204, headers: HeadersInit = {}): Response {\n  return new Response(null, {\n    status,\n    headers,\n  });\n}\n\n/** ç”Ÿæˆæµå¼å“åº” */\nexport function stream(\n  stream: ReadableStream,\n  status = 200,\n  headers: HeadersInit = {},\n): Response {\n  const h = new Headers({\n    \"Content-Type\": \"application/octet-stream\",\n    ...headers,\n  });\n\n  return new Response(stream, {\n    status,\n    headers: h,\n  });\n}\n","// src/middleware.ts\n\nimport { json, mapResponse } from \"./utils/response\";\n\nimport type { Handler, Middleware } from \"./types\";\n/** ä¸­é—´ä»¶ç±»å‹ï¼šä½¿ç”¨ next() ä¼ é€’ç»™ä¸‹ä¸€ä¸ªå¤„ç† */\n\n/** Vafast è‡ªå®šä¹‰é”™è¯¯ç±»å‹ */\nexport class VafastError extends Error {\n  status: number;\n  type: string;\n  expose: boolean;\n\n  constructor(\n    message: string,\n    options: {\n      status?: number;\n      type?: string;\n      expose?: boolean;\n      cause?: unknown;\n    } = {},\n  ) {\n    super(message);\n    this.name = \"VafastError\";\n    this.status = options.status ?? 500;\n    this.type = options.type ?? \"internal_error\";\n    this.expose = options.expose ?? false;\n    if (options.cause) (this as any).cause = options.cause;\n  }\n}\n\n/**\n * ç»„åˆç±»å‹: è‡ªåŠ¨æ³¨å…¥é”™è¯¯å¤„ç†å™¨è¿›è¡Œä¸­é—´ä»¶ç»„åˆ\n */\nexport function composeMiddleware(\n  middleware: Middleware[],\n  finalHandler: Handler,\n): (req: Request) => Promise<Response> {\n  const all = [errorHandler, ...middleware];\n\n  return function composedHandler(req: Request): Promise<Response> {\n    let i = -1;\n\n    const dispatch = (index: number): Promise<Response> => {\n      if (index <= i)\n        return Promise.reject(new Error(\"next() called multiple times\"));\n      i = index;\n\n      // ä¸­é—´ä»¶é˜¶æ®µ\n      if (index < all.length) {\n        const mw = all[index];\n        return Promise.resolve(mw(req, () => dispatch(index + 1)));\n      }\n\n      // æœ€ç»ˆ handler - ä½¿ç”¨ mapResponse è½¬æ¢è¿”å›å€¼\n      return Promise.resolve(finalHandler(req)).then(mapResponse);\n    };\n\n    return dispatch(0);\n  };\n}\n\n/** é»˜è®¤åŒ…å«çš„å…¨å±€é”™è¯¯å¤„ç†å™¨ */\nconst errorHandler: Middleware = async (req, next) => {\n  try {\n    return await next();\n  } catch (err) {\n    console.error(\"æœªå¤„ç†çš„é”™è¯¯:\", err);\n\n    if (err instanceof VafastError) {\n      return json(\n        {\n          error: err.type,\n          message: err.expose ? err.message : \"å‘ç”Ÿäº†ä¸€ä¸ªé”™è¯¯\",\n        },\n        err.status,\n      );\n    }\n\n    return json({ error: \"internal_error\", message: \"å‡ºç°äº†ä¸€äº›é—®é¢˜\" }, 500);\n  }\n};\n","import type { Middleware } from \"../types\";\n\n/**\n * æœåŠ¡å™¨åŸºç±»\n * åŒ…å«æ‰€æœ‰æœåŠ¡å™¨ç±»å‹çš„å…¬å…±é€»è¾‘\n */\nexport abstract class BaseServer {\n  protected globalMiddleware: Middleware[] = [];\n\n  use(mw: Middleware) {\n    this.globalMiddleware.push(mw);\n  }\n\n  /**\n   * æ‰“å°æ‰å¹³åŒ–åçš„è·¯ç”±ä¿¡æ¯ï¼Œç”¨äºè°ƒè¯•\n   */\n  protected logFlattenedRoutes(routes: any[], type: string = \"è·¯ç”±\"): void {\n    console.log(`ğŸš€ æ‰å¹³åŒ–åçš„${type}:`);\n    for (const route of routes) {\n      const method = route.method || \"GET\";\n      const path = route.fullPath || route.path;\n      console.log(`  ${method} ${path}`);\n      if (route.middlewareChain && route.middlewareChain.length > 0) {\n        console.log(`    ä¸­é—´ä»¶é“¾: ${route.middlewareChain.length} ä¸ª`);\n      }\n    }\n    console.log(\"\");\n  }\n\n  /**\n   * æ£€æµ‹è·¯ç”±å†²çª\n   * æ£€æŸ¥æ˜¯å¦æœ‰è·¯å¾„ç›¸åŒä½†æ–¹æ³•ä¸åŒçš„è·¯ç”±ï¼Œä»¥åŠæ½œåœ¨çš„è·¯å¾„å†²çª\n   */\n  protected detectRouteConflicts(routes: any[]): void {\n    const pathGroups = new Map<string, any[]>();\n\n    // æŒ‰è·¯å¾„åˆ†ç»„\n    for (const route of routes) {\n      const path = route.fullPath || route.path;\n      const method = route.method || \"GET\";\n      if (!pathGroups.has(path)) {\n        pathGroups.set(path, []);\n      }\n      pathGroups.get(path)!.push({ ...route, method });\n    }\n\n    // æ£€æŸ¥å†²çª\n    for (const [path, routeList] of pathGroups) {\n      if (routeList.length > 1) {\n        const methods = routeList.map((r) => r.method);\n        const uniqueMethods = [...new Set(methods)];\n\n        if (uniqueMethods.length === 1) {\n          // ç›¸åŒè·¯å¾„ã€ç›¸åŒæ–¹æ³• - è¿™æ˜¯å†²çªï¼\n          console.warn(\n            `âš ï¸  è·¯ç”±å†²çª: ${uniqueMethods[0]} ${path} å®šä¹‰äº† ${routeList.length} æ¬¡`,\n          );\n          routeList.forEach((route, index) => {\n            console.warn(`   ${index + 1}. ${route.method} ${path}`);\n          });\n        } else {\n          // ç›¸åŒè·¯å¾„ã€ä¸åŒæ–¹æ³• - è¿™æ˜¯æ­£å¸¸çš„\n          console.log(`â„¹ï¸  è·¯å¾„ ${path} æ”¯æŒæ–¹æ³•: ${uniqueMethods.join(\", \")}`);\n        }\n      }\n    }\n\n    // æ£€æŸ¥æ½œåœ¨çš„è·¯å¾„å†²çªï¼ˆåŠ¨æ€è·¯ç”±å¯èƒ½å†²çªï¼‰\n    this.detectDynamicRouteConflicts(routes);\n  }\n\n  /**\n   * æ£€æµ‹åŠ¨æ€è·¯ç”±çš„æ½œåœ¨å†²çª\n   */\n  private detectDynamicRouteConflicts(routes: any[]): void {\n    const dynamicRoutes = routes.filter((r) => {\n      const path = r.fullPath || r.path;\n      return path.includes(\":\") || path.includes(\"*\");\n    });\n\n    for (let i = 0; i < dynamicRoutes.length; i++) {\n      for (let j = i + 1; j < dynamicRoutes.length; j++) {\n        const route1 = dynamicRoutes[i];\n        const route2 = dynamicRoutes[j];\n        const method1 = route1.method || \"GET\";\n        const method2 = route2.method || \"GET\";\n\n        if (method1 === method2) {\n          const path1 = route1.fullPath || route1.path;\n          const path2 = route2.fullPath || route2.path;\n          // æ£€æŸ¥è·¯å¾„æ˜¯å¦å¯èƒ½å†²çª\n          if (this.pathsMayConflict(path1, path2)) {\n            console.warn(\n              `âš ï¸  æ½œåœ¨è·¯ç”±å†²çª: ${method1} ${path1} å¯èƒ½ä¸ ${path2} å†²çª`,\n            );\n          }\n        }\n      }\n    }\n  }\n\n  /**\n   * åˆ¤æ–­ä¸¤ä¸ªè·¯å¾„æ˜¯å¦å¯èƒ½å†²çª\n   */\n  private pathsMayConflict(path1: string, path2: string): boolean {\n    const parts1 = path1.split(\"/\").filter(Boolean);\n    const parts2 = path2.split(\"/\").filter(Boolean);\n\n    if (parts1.length !== parts2.length) return false;\n\n    for (let i = 0; i < parts1.length; i++) {\n      const p1 = parts1[i];\n      const p2 = parts2[i];\n\n      // å¦‚æœä¸¤ä¸ªéƒ¨åˆ†éƒ½æ˜¯é™æ€çš„ä¸”ä¸åŒï¼Œåˆ™ä¸ä¼šå†²çª\n      if (\n        !p1.startsWith(\":\") &&\n        !p1.startsWith(\"*\") &&\n        !p2.startsWith(\":\") &&\n        !p2.startsWith(\"*\") &&\n        p1 !== p2\n      ) {\n        return false;\n      }\n\n      // å¦‚æœä¸€ä¸ªæ˜¯é€šé…ç¬¦ï¼Œå¦ä¸€ä¸ªæ˜¯åŠ¨æ€å‚æ•°ï¼Œå¯èƒ½å†²çª\n      if (\n        (p1 === \"*\" && p2.startsWith(\":\")) ||\n        (p2 === \"*\" && p1.startsWith(\":\"))\n      ) {\n        return true;\n      }\n    }\n\n    return false;\n  }\n\n  /**\n   * è·¯å¾„åŒ¹é…\n   */\n  protected matchPath(pattern: string, path: string): boolean {\n    const patternParts = pattern.split(\"/\").filter(Boolean);\n    const pathParts = path.split(\"/\").filter(Boolean);\n\n    if (patternParts.length !== pathParts.length) {\n      return false;\n    }\n\n    for (let i = 0; i < patternParts.length; i++) {\n      if (\n        patternParts[i] !== pathParts[i] &&\n        !patternParts[i].startsWith(\":\")\n      ) {\n        return false;\n      }\n    }\n\n    return true;\n  }\n\n  /**\n   * æå–è·¯å¾„å‚æ•°\n   */\n  protected extractParams(\n    pattern: string,\n    path: string,\n  ): Record<string, string> {\n    const params: Record<string, string> = {};\n    const patternParts = pattern.split(\"/\").filter(Boolean);\n    const pathParts = path.split(\"/\").filter(Boolean);\n\n    for (let i = 0; i < patternParts.length; i++) {\n      if (patternParts[i].startsWith(\":\")) {\n        const paramName = patternParts[i].slice(1);\n        params[paramName] = pathParts[i];\n      }\n    }\n\n    return params;\n  }\n}\n","/**\n * Radix Tree è·¯ç”±åŒ¹é…å™¨\n *\n * é«˜æ€§èƒ½è·¯ç”±åŒ¹é…å®ç°ï¼Œæ—¶é—´å¤æ‚åº¦ O(k)ï¼Œk ä¸ºè·¯å¾„æ®µæ•°\n *\n * æ”¯æŒçš„è·¯ç”±æ¨¡å¼:\n * - é™æ€è·¯å¾„: /users, /api/v1/health\n * - åŠ¨æ€å‚æ•°: /users/:id, /posts/:postId/comments/:commentId\n * - é€šé…ç¬¦: /files/*, /static/*filepath\n */\n\nimport type { Handler, Middleware, Method } from \"../types\";\n\n/** é¢„ç¼–è¯‘çš„å¤„ç†å™¨ç±»å‹ */\ntype CompiledHandler = (req: Request) => Promise<Response>;\n\n/** è·¯ç”±å¤„ç†ä¿¡æ¯ */\ninterface RouteHandler {\n  handler: Handler;\n  middleware: Middleware[];\n  /** é¢„ç¼–è¯‘åçš„å®Œæ•´å¤„ç†é“¾ï¼ˆåŒ…å«ä¸­é—´ä»¶ï¼‰ */\n  compiled?: CompiledHandler;\n}\n\n/** Radix Tree èŠ‚ç‚¹ */\ninterface RadixNode {\n  path: string;\n  children: Record<string, RadixNode>;\n  paramChild?: RadixNode;\n  wildcardChild?: RadixNode;\n  paramName?: string;\n  handlers: Record<Method, RouteHandler | undefined>;\n}\n\n/** è·¯ç”±åŒ¹é…ç»“æœ */\nexport interface MatchResult {\n  handler: Handler;\n  middleware: Middleware[];\n  params: Record<string, string>;\n  /** é¢„ç¼–è¯‘åçš„å®Œæ•´å¤„ç†é“¾ */\n  compiled?: CompiledHandler;\n}\n\n/**\n * Radix Tree è·¯ç”±å™¨\n *\n * @example\n * ```typescript\n * const router = new RadixRouter();\n * router.register(\"GET\", \"/users/:id\", handler);\n * const result = router.match(\"GET\", \"/users/123\");\n * // result.params = { id: \"123\" }\n * ```\n */\nexport class RadixRouter {\n  private root: RadixNode;\n\n  constructor() {\n    this.root = this.createNode(\"\");\n  }\n\n  private createNode(path: string): RadixNode {\n    return {\n      path,\n      children: Object.create(null),\n      handlers: Object.create(null),\n    };\n  }\n\n  /** åˆ†å‰²è·¯å¾„ */\n  private splitPath(path: string): string[] {\n    return path.split(\"/\").filter(Boolean);\n  }\n\n  /** ç¼–è¯‘å™¨å‡½æ•° - ç”¨äºé¢„ç¼–è¯‘ä¸­é—´ä»¶é“¾ */\n  private compiler?: (\n    middleware: Middleware[],\n    handler: Handler,\n  ) => CompiledHandler;\n\n  /** è®¾ç½®ä¸­é—´ä»¶ç¼–è¯‘å™¨ */\n  setCompiler(\n    compiler: (middleware: Middleware[], handler: Handler) => CompiledHandler,\n  ): void {\n    this.compiler = compiler;\n  }\n\n  /** æ³¨å†Œè·¯ç”± */\n  register(\n    method: Method,\n    pattern: string,\n    handler: Handler,\n    middleware: Middleware[] = [],\n  ): void {\n    const segments = this.splitPath(pattern);\n    let node = this.root;\n\n    for (const segment of segments) {\n      const firstChar = segment[0];\n\n      if (firstChar === \":\") {\n        // åŠ¨æ€å‚æ•°èŠ‚ç‚¹\n        if (!node.paramChild) {\n          node.paramChild = this.createNode(segment);\n          node.paramChild.paramName = segment.substring(1);\n        }\n        node = node.paramChild;\n      } else if (firstChar === \"*\") {\n        // é€šé…ç¬¦èŠ‚ç‚¹\n        if (!node.wildcardChild) {\n          node.wildcardChild = this.createNode(segment);\n          node.wildcardChild.paramName =\n            segment.length > 1 ? segment.substring(1) : \"*\";\n        }\n        node = node.wildcardChild;\n        break;\n      } else {\n        // é™æ€è·¯å¾„èŠ‚ç‚¹\n        if (!node.children[segment]) {\n          node.children[segment] = this.createNode(segment);\n        }\n        node = node.children[segment];\n      }\n    }\n\n    const routeHandler: RouteHandler = { handler, middleware };\n\n    // å¦‚æœæ²¡æœ‰å…¨å±€ä¸­é—´ä»¶ä¸”è®¾ç½®äº†ç¼–è¯‘å™¨ï¼Œé¢„ç¼–è¯‘å¤„ç†é“¾\n    if (this.compiler && middleware.length === 0) {\n      routeHandler.compiled = this.compiler([], handler);\n    }\n\n    node.handlers[method] = routeHandler;\n  }\n\n  /** é¢„ç¼–è¯‘æ‰€æœ‰è·¯ç”±ï¼ˆåœ¨æ·»åŠ å…¨å±€ä¸­é—´ä»¶åè°ƒç”¨ï¼‰ */\n  precompileAll(globalMiddleware: Middleware[]): void {\n    if (!this.compiler) return;\n    this.precompileNode(this.root, globalMiddleware);\n  }\n\n  private precompileNode(\n    node: RadixNode,\n    globalMiddleware: Middleware[],\n  ): void {\n    for (const method in node.handlers) {\n      const routeHandler = node.handlers[method as Method];\n      if (routeHandler) {\n        const allMiddleware = [...globalMiddleware, ...routeHandler.middleware];\n        routeHandler.compiled = this.compiler!(\n          allMiddleware,\n          routeHandler.handler,\n        );\n      }\n    }\n\n    for (const key in node.children) {\n      this.precompileNode(node.children[key], globalMiddleware);\n    }\n\n    if (node.paramChild) {\n      this.precompileNode(node.paramChild, globalMiddleware);\n    }\n\n    if (node.wildcardChild) {\n      this.precompileNode(node.wildcardChild, globalMiddleware);\n    }\n  }\n\n  /** åŒ¹é…è·¯ç”± */\n  match(method: Method, path: string): MatchResult | null {\n    const segments = this.splitPath(path);\n    const params: Record<string, string> = Object.create(null);\n\n    const node = this.matchNode(this.root, segments, 0, params);\n    if (!node) return null;\n\n    const routeHandler = node.handlers[method];\n    if (!routeHandler) return null;\n\n    return {\n      handler: routeHandler.handler,\n      middleware: routeHandler.middleware,\n      params,\n      compiled: routeHandler.compiled,\n    };\n  }\n\n  /** é€’å½’åŒ¹é…èŠ‚ç‚¹ (ä¼˜å…ˆçº§: é™æ€ > åŠ¨æ€å‚æ•° > é€šé…ç¬¦) */\n  private matchNode(\n    node: RadixNode,\n    segments: string[],\n    index: number,\n    params: Record<string, string>,\n  ): RadixNode | null {\n    if (index === segments.length) {\n      for (const method in node.handlers) {\n        if (node.handlers[method as Method]) return node;\n      }\n      return null;\n    }\n\n    const segment = segments[index];\n\n    // 1. é™æ€è·¯å¾„\n    const staticChild = node.children[segment];\n    if (staticChild) {\n      const result = this.matchNode(staticChild, segments, index + 1, params);\n      if (result) return result;\n    }\n\n    // 2. åŠ¨æ€å‚æ•°\n    if (node.paramChild) {\n      const paramName = node.paramChild.paramName!;\n      const oldValue = params[paramName];\n\n      params[paramName] = segment;\n      const result = this.matchNode(\n        node.paramChild,\n        segments,\n        index + 1,\n        params,\n      );\n\n      if (result) return result;\n\n      // å›æº¯\n      if (oldValue === undefined) {\n        delete params[paramName];\n      } else {\n        params[paramName] = oldValue;\n      }\n    }\n\n    // 3. é€šé…ç¬¦\n    if (node.wildcardChild) {\n      params[node.wildcardChild.paramName || \"*\"] = segments\n        .slice(index)\n        .join(\"/\");\n      return node.wildcardChild;\n    }\n\n    return null;\n  }\n\n  /** è·å–è·¯å¾„å…è®¸çš„ HTTP æ–¹æ³• */\n  getAllowedMethods(path: string): Method[] {\n    const segments = this.splitPath(path);\n    const node = this.findNode(segments);\n    if (!node) return [];\n\n    const methods: Method[] = [];\n    for (const method in node.handlers) {\n      if (node.handlers[method as Method]) {\n        methods.push(method as Method);\n      }\n    }\n    return methods;\n  }\n\n  /** æŸ¥æ‰¾èŠ‚ç‚¹ï¼ˆä¸æå–å‚æ•°ï¼‰ */\n  private findNode(segments: string[]): RadixNode | null {\n    let node = this.root;\n\n    for (const segment of segments) {\n      if (node.children[segment]) {\n        node = node.children[segment];\n      } else if (node.paramChild) {\n        node = node.paramChild;\n      } else if (node.wildcardChild) {\n        return node.wildcardChild;\n      } else {\n        return null;\n      }\n    }\n\n    return node;\n  }\n\n  /** è·å–æ‰€æœ‰å·²æ³¨å†Œçš„è·¯ç”± */\n  getRoutes(): Array<{ method: Method; path: string }> {\n    const routes: Array<{ method: Method; path: string }> = [];\n    this.collectRoutes(this.root, \"\", routes);\n    return routes;\n  }\n\n  private collectRoutes(\n    node: RadixNode,\n    prefix: string,\n    routes: Array<{ method: Method; path: string }>,\n  ): void {\n    const currentPath = prefix + (node.path ? \"/\" + node.path : \"\");\n\n    for (const method in node.handlers) {\n      if (node.handlers[method as Method]) {\n        routes.push({ method: method as Method, path: currentPath || \"/\" });\n      }\n    }\n\n    for (const key in node.children) {\n      this.collectRoutes(node.children[key], currentPath, routes);\n    }\n\n    if (node.paramChild) {\n      this.collectRoutes(node.paramChild, currentPath, routes);\n    }\n\n    if (node.wildcardChild) {\n      this.collectRoutes(node.wildcardChild, currentPath, routes);\n    }\n  }\n}\n","/**\n * è·¯ç”±æ³¨å†Œè¡¨\n *\n * æä¾›è·¯ç”±å…ƒä¿¡æ¯çš„æ”¶é›†å’ŒæŸ¥è¯¢èƒ½åŠ›\n * å¯ç”¨äºï¼šAPI æ–‡æ¡£ç”Ÿæˆã€Webhook äº‹ä»¶æ³¨å†Œã€æƒé™æ£€æŸ¥ã€å®¡è®¡æ—¥å¿—ç­‰\n *\n * @example\n * ```typescript\n * // åˆ›å»ºæ³¨å†Œè¡¨\n * const registry = createRouteRegistry(server.getRoutes())\n *\n * // æŸ¥è¯¢è·¯ç”±\n * const route = registry.get('POST', '/auth/signIn')\n *\n * // ç­›é€‰æœ‰ webhook é…ç½®çš„è·¯ç”±\n * const webhookRoutes = registry.filter('webhook')\n *\n * // æŒ‰åˆ†ç±»è·å–\n * const authRoutes = registry.getByCategory('auth')\n * ```\n */\n\nimport type { FlattenedRoute, Method } from '../types'\n\n/**\n * è·¯ç”±å…ƒä¿¡æ¯ï¼ˆä¸å« handler å’Œ middlewareï¼‰\n */\nexport interface RouteMeta {\n  method: Method\n  path: string\n  fullPath: string\n  name?: string\n  description?: string\n  /** æ‰©å±•å­—æ®µ */\n  [key: string]: unknown\n}\n\n/**\n * è·¯ç”±æ³¨å†Œè¡¨\n *\n * æ³›å‹ T ç”¨äºå®šä¹‰æ‰©å±•å­—æ®µçš„ç±»å‹\n */\nexport class RouteRegistry<T extends Record<string, unknown> = Record<string, unknown>> {\n  /** æ‰€æœ‰è·¯ç”±å…ƒä¿¡æ¯ */\n  private routes: RouteMeta[] = []\n\n  /** è·¯ç”±æ˜ å°„è¡¨ï¼šMETHOD:fullPath -> RouteMeta */\n  private routeMap = new Map<string, RouteMeta>()\n\n  /** åˆ†ç±»æ˜ å°„è¡¨ï¼šcategory -> RouteMeta[] */\n  private categoryMap = new Map<string, RouteMeta[]>()\n\n  constructor(routes: FlattenedRoute[]) {\n    this.buildRegistry(routes)\n  }\n\n  /**\n   * æ„å»ºæ³¨å†Œè¡¨\n   */\n  private buildRegistry(routes: FlattenedRoute[]): void {\n    for (const route of routes) {\n      // æå–å…ƒä¿¡æ¯ï¼ˆæ’é™¤ handler å’Œ middlewareï¼‰\n      const meta: RouteMeta = {\n        method: route.method,\n        path: route.path,\n        fullPath: route.fullPath,\n        name: route.name,\n        description: route.description,\n      }\n\n      // å¤åˆ¶æ‰©å±•å­—æ®µ\n      for (const key of Object.keys(route)) {\n        if (!['method', 'path', 'fullPath', 'name', 'description', 'handler', 'middleware', 'middlewareChain'].includes(key)) {\n          meta[key] = route[key as keyof FlattenedRoute]\n        }\n      }\n\n      this.routes.push(meta)\n      this.routeMap.set(`${route.method}:${route.fullPath}`, meta)\n\n      // æŒ‰åˆ†ç±»ç´¢å¼•\n      const category = this.extractCategory(route.fullPath)\n      if (!this.categoryMap.has(category)) {\n        this.categoryMap.set(category, [])\n      }\n      this.categoryMap.get(category)!.push(meta)\n    }\n  }\n\n  /**\n   * æå–åˆ†ç±»ï¼ˆç¬¬ä¸€æ®µè·¯å¾„ï¼‰\n   */\n  private extractCategory(path: string): string {\n    const segments = path.split('/').filter(Boolean)\n    return segments[0] || 'root'\n  }\n\n  // ============================================\n  // æŸ¥è¯¢æ¥å£\n  // ============================================\n\n  /**\n   * è·å–æ‰€æœ‰è·¯ç”±å…ƒä¿¡æ¯\n   */\n  getAll(): RouteMeta[] {\n    return [...this.routes]\n  }\n\n  /**\n   * æŒ‰ method + path æŸ¥è¯¢è·¯ç”±\n   */\n  get(method: string, path: string): (RouteMeta & T) | undefined {\n    return this.routeMap.get(`${method}:${path}`) as (RouteMeta & T) | undefined\n  }\n\n  /**\n   * æ£€æŸ¥è·¯ç”±æ˜¯å¦å­˜åœ¨\n   */\n  has(method: string, path: string): boolean {\n    return this.routeMap.has(`${method}:${path}`)\n  }\n\n  /**\n   * æŒ‰åˆ†ç±»è·å–è·¯ç”±\n   */\n  getByCategory(category: string): RouteMeta[] {\n    return this.categoryMap.get(category) || []\n  }\n\n  /**\n   * è·å–æ‰€æœ‰åˆ†ç±»\n   */\n  getCategories(): string[] {\n    return Array.from(this.categoryMap.keys()).sort()\n  }\n\n  /**\n   * ç­›é€‰æœ‰ç‰¹å®šå­—æ®µçš„è·¯ç”±\n   *\n   * @example\n   * ```typescript\n   * // è·å–æ‰€æœ‰é…ç½®äº† webhook çš„è·¯ç”±\n   * const webhookRoutes = registry.filter('webhook')\n   * ```\n   */\n  filter<K extends string>(field: K): (RouteMeta & Record<K, unknown>)[] {\n    return this.routes.filter((r) => field in r && r[field] !== undefined) as (RouteMeta & Record<K, unknown>)[]\n  }\n\n  /**\n   * æŒ‰æ¡ä»¶ç­›é€‰è·¯ç”±\n   *\n   * @example\n   * ```typescript\n   * // è·å–æ‰€æœ‰ POST è¯·æ±‚\n   * const postRoutes = registry.filterBy(r => r.method === 'POST')\n   * ```\n   */\n  filterBy(predicate: (route: RouteMeta) => boolean): RouteMeta[] {\n    return this.routes.filter(predicate)\n  }\n\n  /**\n   * è·å–è·¯ç”±æ•°é‡\n   */\n  get size(): number {\n    return this.routes.length\n  }\n\n  /**\n   * éå†æ‰€æœ‰è·¯ç”±\n   */\n  forEach(callback: (route: RouteMeta, index: number) => void): void {\n    this.routes.forEach(callback)\n  }\n\n  /**\n   * æ˜ å°„æ‰€æœ‰è·¯ç”±\n   */\n  map<R>(callback: (route: RouteMeta, index: number) => R): R[] {\n    return this.routes.map(callback)\n  }\n}\n\n/**\n * åˆ›å»ºè·¯ç”±æ³¨å†Œè¡¨\n *\n * @example\n * ```typescript\n * // å®šä¹‰æ‰©å±•å­—æ®µç±»å‹\n * interface MyRouteMeta {\n *   webhook?: { eventKey: string }\n *   permission?: string\n * }\n *\n * // åˆ›å»ºå¸¦ç±»å‹çš„æ³¨å†Œè¡¨\n * const registry = createRouteRegistry<MyRouteMeta>(server.getRoutes())\n *\n * // ç±»å‹å®‰å…¨çš„æŸ¥è¯¢\n * const route = registry.get('POST', '/auth/signIn')\n * if (route?.webhook) {\n *   console.log(route.webhook.eventKey)\n * }\n * ```\n */\nexport function createRouteRegistry<T extends Record<string, unknown> = Record<string, unknown>>(\n  routes: FlattenedRoute[]\n): RouteRegistry<T> {\n  return new RouteRegistry<T>(routes)\n}\n\n// ============================================\n// å…¨å±€ Registryï¼ˆå•ä¾‹æ¨¡å¼ï¼‰\n// ============================================\n\n/** å…¨å±€ registry å®ä¾‹ */\nlet globalRegistry: RouteRegistry | null = null\n\n/**\n * è®¾ç½®å…¨å±€ registryï¼ˆæ¡†æ¶å†…éƒ¨ä½¿ç”¨ï¼‰\n * @internal\n */\nexport function setGlobalRegistry(registry: RouteRegistry): void {\n  globalRegistry = registry\n}\n\n/**\n * è·å–å…¨å±€è·¯ç”±æ³¨å†Œè¡¨\n *\n * @example\n * ```typescript\n * // åœ¨ä»»æ„æ–‡ä»¶ä¸­\n * import { getRouteRegistry } from 'vafast'\n *\n * const registry = getRouteRegistry()\n * const webhookRoutes = registry.filter('webhook')\n * ```\n *\n * @throws å¦‚æœ Server å°šæœªåˆ›å»º\n */\nexport function getRouteRegistry<T extends Record<string, unknown> = Record<string, unknown>>(): RouteRegistry<T> {\n  if (!globalRegistry) {\n    throw new Error('RouteRegistry not initialized. Make sure Server is created first.')\n  }\n  return globalRegistry as RouteRegistry<T>\n}\n\n/**\n * æŒ‰ method + path è·å–å•ä¸ªè·¯ç”±\n *\n * ä¾¿æ·å‡½æ•°ï¼Œæ— éœ€å…ˆè·å– registry\n *\n * @example\n * ```typescript\n * // åœ¨ä¸­é—´ä»¶æˆ–æ¥å£ä¸­\n * import { getRoute } from 'vafast'\n *\n * const route = getRoute('POST', '/auth/signIn')\n * if (route?.webhook) {\n *   console.log('This route has webhook:', route.webhook)\n * }\n * ```\n */\nexport function getRoute<T extends Record<string, unknown> = Record<string, unknown>>(\n  method: string,\n  path: string\n): (RouteMeta & T) | undefined {\n  return getRouteRegistry<T>().get(method, path)\n}\n\n/**\n * è·å–æ‰€æœ‰è·¯ç”±\n *\n * @example\n * ```typescript\n * import { getAllRoutes } from 'vafast'\n *\n * const routes = getAllRoutes()\n * console.log(`Total ${routes.length} routes`)\n * ```\n */\nexport function getAllRoutes(): RouteMeta[] {\n  return getRouteRegistry().getAll()\n}\n\n/**\n * ç­›é€‰æœ‰ç‰¹å®šå­—æ®µçš„è·¯ç”±\n *\n * @example\n * ```typescript\n * import { filterRoutes } from 'vafast'\n *\n * // è·å–æ‰€æœ‰é…ç½®äº† webhook çš„è·¯ç”±\n * const webhookRoutes = filterRoutes('webhook')\n * ```\n */\nexport function filterRoutes<K extends string>(field: K): (RouteMeta & Record<K, unknown>)[] {\n  return getRouteRegistry().filter(field)\n}\n\n","/**\n * Vafast æ ¸å¿ƒæœåŠ¡å™¨\n *\n * åŸºäº Radix Tree çš„é«˜æ€§èƒ½è·¯ç”±åŒ¹é…\n * æ—¶é—´å¤æ‚åº¦: O(k)ï¼Œk ä¸ºè·¯å¾„æ®µæ•°\n */\n\nimport type { Route, NestedRoute, FlattenedRoute, Method } from \"../types\";\nimport { flattenNestedRoutes } from \"../router\";\nimport { composeMiddleware } from \"../middleware\";\nimport { json } from \"../utils/response\";\nimport { BaseServer } from \"./base-server\";\nimport { RadixRouter } from \"../router/radix-tree\";\nimport { RouteRegistry, setGlobalRegistry } from \"../utils/route-registry\";\n\n/**\n * Vafast æœåŠ¡å™¨\n *\n * @example\n * ```typescript\n * const server = new Server([\n *   { method: \"GET\", path: \"/\", handler: () => new Response(\"Hello\") },\n * ]);\n * export default { fetch: server.fetch };\n * ```\n */\nexport class Server extends BaseServer {\n  private router: RadixRouter;\n  private routes: FlattenedRoute[];\n  /** æ˜¯å¦å·²é¢„ç¼–è¯‘ */\n  private isCompiled = false;\n  /** é¢„ç¼–è¯‘æ—¶çš„å…¨å±€ä¸­é—´ä»¶æ•°é‡ */\n  private compiledWithMiddlewareCount = 0;\n\n  constructor(routes: (Route | NestedRoute)[] = []) {\n    super();\n    this.router = new RadixRouter();\n    this.routes = [];\n\n    // è®¾ç½®ä¸­é—´ä»¶ç¼–è¯‘å™¨\n    this.router.setCompiler((middleware, handler) =>\n      composeMiddleware(middleware, handler),\n    );\n\n    if (routes.length > 0) {\n      this.registerRoutes(routes);\n    }\n  }\n\n  /**\n   * é¢„ç¼–è¯‘æ‰€æœ‰è·¯ç”±å¤„ç†é“¾\n   * åœ¨æ·»åŠ æ‰€æœ‰è·¯ç”±å’Œå…¨å±€ä¸­é—´ä»¶åè°ƒç”¨ï¼Œå¯æå‡è¿è¡Œæ—¶æ€§èƒ½\n   */\n  compile(): this {\n    this.router.precompileAll(this.globalMiddleware);\n    this.isCompiled = true;\n    this.compiledWithMiddlewareCount = this.globalMiddleware.length;\n    return this;\n  }\n\n  private registerRoutes(routes: (Route | NestedRoute)[]): void {\n    const flattened = flattenNestedRoutes(routes);\n    this.routes.push(...flattened);\n\n    for (const route of flattened) {\n      this.router.register(\n        route.method as Method,\n        route.fullPath,\n        route.handler,\n        route.middlewareChain || [],\n      );\n    }\n\n    this.detectRouteConflicts(flattened);\n    this.logFlattenedRoutes(flattened);\n\n    // è‡ªåŠ¨é¢„ç¼–è¯‘ï¼ˆå¦‚æœæ²¡æœ‰å…¨å±€ä¸­é—´ä»¶ï¼‰\n    if (this.globalMiddleware.length === 0 && !this.isCompiled) {\n      this.compile();\n    }\n\n    // è‡ªåŠ¨è®¾ç½®å…¨å±€ RouteRegistryï¼ˆæ”¯æŒåœ¨ä»»æ„ä½ç½®é€šè¿‡ getRouteRegistry() è®¿é—®ï¼‰\n    setGlobalRegistry(new RouteRegistry(this.routes));\n  }\n\n  /** å¿«é€Ÿæå– pathname */\n  private extractPathname(url: string): string {\n    let start = url.indexOf(\"://\");\n    start = start === -1 ? 0 : start + 3;\n\n    const pathStart = url.indexOf(\"/\", start);\n    if (pathStart === -1) return \"/\";\n\n    let end = url.indexOf(\"?\", pathStart);\n    if (end === -1) end = url.indexOf(\"#\", pathStart);\n    if (end === -1) end = url.length;\n\n    return url.substring(pathStart, end) || \"/\";\n  }\n\n  /** ç”Ÿæˆ 404/405 å“åº” */\n  private createErrorResponse(method: string, pathname: string): Response {\n    const allowedMethods = this.router.getAllowedMethods(pathname);\n    if (allowedMethods.length > 0) {\n      return json(\n        {\n          success: false,\n          error: \"Method Not Allowed\",\n          message: `Method ${method} not allowed for this endpoint`,\n          allowedMethods,\n        },\n        405,\n        { Allow: allowedMethods.join(\", \") },\n      );\n    }\n    return json({ success: false, error: \"Not Found\" }, 404);\n  }\n\n  /** å¤„ç†è¯·æ±‚ */\n  fetch = async (req: Request): Promise<Response> => {\n    const pathname = this.extractPathname(req.url);\n    const method = req.method as Method;\n\n    const match = this.router.match(method, pathname);\n\n    if (match) {\n      (req as unknown as Record<string, unknown>).params = match.params;\n\n      // ä¼˜å…ˆä½¿ç”¨é¢„ç¼–è¯‘çš„å¤„ç†é“¾ï¼ˆä»…å½“å…¨å±€ä¸­é—´ä»¶æœªå˜åŒ–æ—¶ï¼‰\n      if (\n        match.compiled &&\n        this.globalMiddleware.length === this.compiledWithMiddlewareCount\n      ) {\n        return match.compiled(req);\n      }\n\n      // å›é€€ï¼šè¿è¡Œæ—¶ç»„åˆä¸­é—´ä»¶\n      const allMiddleware = [...this.globalMiddleware, ...match.middleware];\n      const handler = composeMiddleware(allMiddleware, match.handler);\n\n      return handler(req);\n    }\n\n    // OPTIONS é¢„æ£€è¯·æ±‚ç‰¹æ®Šå¤„ç†ï¼šæŸ¥æ‰¾åŒè·¯å¾„å…¶ä»–æ–¹æ³•çš„è·¯ç”±ï¼Œä½¿ç”¨å…¶ä¸­é—´ä»¶\n    // è¿™å…è®¸è·¯ç”±çº§ CORS ä¸­é—´ä»¶æ­£å¸¸å·¥ä½œ\n    if (method === \"OPTIONS\") {\n      const allowedMethods = this.router.getAllowedMethods(pathname);\n      if (allowedMethods.length > 0) {\n        // å°è¯•è·å–è¯¥è·¯å¾„ä»»æ„æ–¹æ³•çš„è·¯ç”±ä¸­é—´ä»¶\n        const anyMatch = this.router.match(\n          allowedMethods[0] as Method,\n          pathname,\n        );\n        const routeMiddleware = anyMatch?.middleware || [];\n        const allMiddleware = [...this.globalMiddleware, ...routeMiddleware];\n\n        // OPTIONS è¯·æ±‚é»˜è®¤è¿”å› 204ï¼ˆä¸­é—´ä»¶å¦‚ CORS å¯èƒ½ä¼šæå‰å“åº”ï¼‰\n        const optionsHandler = () =>\n          new Response(null, {\n            status: 204,\n            headers: { Allow: allowedMethods.join(\", \") },\n          });\n\n        const handler = composeMiddleware(allMiddleware, optionsHandler);\n        return handler(req);\n      }\n    }\n\n    // æœªåŒ¹é…è·¯ç”±æ—¶ï¼Œä»æ‰§è¡Œå…¨å±€ä¸­é—´ä»¶ï¼ˆå¦‚ CORS å¤„ç† OPTIONS é¢„æ£€ï¼‰\n    if (this.globalMiddleware.length > 0) {\n      const handler = composeMiddleware(this.globalMiddleware, () =>\n        this.createErrorResponse(method, pathname),\n      );\n      return handler(req);\n    }\n\n    return this.createErrorResponse(method, pathname);\n  };\n\n  addRoute(route: Route): void {\n    const flattenedRoute: FlattenedRoute = {\n      ...route,\n      fullPath: route.path,\n      middlewareChain: route.middleware || [],\n    };\n\n    this.routes.push(flattenedRoute);\n    this.router.register(\n      route.method as Method,\n      route.path,\n      route.handler,\n      route.middleware || [],\n    );\n  }\n\n  addRoutes(routes: (Route | NestedRoute)[]): void {\n    this.registerRoutes(routes);\n  }\n\n  getRoutes(): Array<{ method: Method; path: string }> {\n    return this.router.getRoutes();\n  }\n\n  /**\n   * è·å–å®Œæ•´çš„è·¯ç”±å…ƒä¿¡æ¯ï¼ˆä¸å« handler å’Œ middlewareï¼‰\n   *\n   * ç”¨äº API æ–‡æ¡£ç”Ÿæˆã€Webhook äº‹ä»¶æ³¨å†Œã€æƒé™æ£€æŸ¥ç­‰åœºæ™¯\n   *\n   * @example\n   * ```typescript\n   * const routes = server.getRoutesWithMeta()\n   * for (const route of routes) {\n   *   console.log(route.fullPath, route.name, route.description)\n   * }\n   * ```\n   */\n  getRoutesWithMeta(): FlattenedRoute[] {\n    return this.routes;\n  }\n}\n","import type {\n  ComponentRoute,\n  NestedComponentRoute,\n  FlattenedComponentRoute,\n} from \"../types/component-route\";\nimport { vueRenderer, reactRenderer } from \"./component-renderer\";\n\n/**\n * æ‰å¹³åŒ–åµŒå¥—ç»„ä»¶è·¯ç”±\n */\nexport function flattenComponentRoutes(\n  routes: (ComponentRoute | NestedComponentRoute)[],\n): FlattenedComponentRoute[] {\n  const flattened: FlattenedComponentRoute[] = [];\n\n  function processRoute(\n    route: ComponentRoute | NestedComponentRoute,\n    parentPath: string = \"\",\n    parentMiddleware: any[] = [],\n  ) {\n    const currentPath = parentPath + route.path;\n    const currentMiddleware = [\n      ...parentMiddleware,\n      ...(route.middleware || []),\n    ];\n\n    if (\"component\" in route) {\n      // è¿™æ˜¯ä¸€ä¸ªç»„ä»¶è·¯ç”±\n      flattened.push({\n        ...route,\n        fullPath: currentPath,\n        middlewareChain: currentMiddleware,\n      });\n    } else if (\"children\" in route && route.children) {\n      // è¿™æ˜¯ä¸€ä¸ªåµŒå¥—è·¯ç”±\n      for (const child of route.children) {\n        processRoute(child, currentPath, currentMiddleware);\n      }\n    }\n  }\n\n  for (const route of routes) {\n    processRoute(route);\n  }\n\n  return flattened;\n}\n\n/**\n * ç»„ä»¶è·¯ç”±å¤„ç†å™¨ä¸­é—´ä»¶\n * è‡ªåŠ¨æ£€æµ‹ç»„ä»¶ç±»å‹å¹¶åº”ç”¨ç›¸åº”çš„æ¸²æŸ“å™¨\n */\nexport const componentRouter = () => {\n  return async (req: Request, next: () => Promise<Response>) => {\n    // è¿™é‡Œå¯ä»¥æ·»åŠ ç»„ä»¶è·¯ç”±çš„è‡ªåŠ¨å¤„ç†é€»è¾‘\n    // æ¯”å¦‚è‡ªåŠ¨æ£€æµ‹ç»„ä»¶ç±»å‹ï¼Œåº”ç”¨ç›¸åº”çš„æ¸²æŸ“å™¨\n    return next();\n  };\n};\n","/**\n * è·¯å¾„åŒ¹é…å·¥å…·ç±»\n * æä¾›ç»Ÿä¸€çš„è·¯å¾„åŒ¹é…å’Œå‚æ•°æå–åŠŸèƒ½\n */\nexport class PathMatcher {\n  /**\n   * è·¯å¾„åŒ¹é…\n   */\n  static matchPath(pattern: string, path: string): boolean {\n    const patternParts = pattern.split(\"/\").filter(Boolean);\n    const pathParts = path.split(\"/\").filter(Boolean);\n\n    if (patternParts.length !== pathParts.length) {\n      return false;\n    }\n\n    for (let i = 0; i < patternParts.length; i++) {\n      if (\n        patternParts[i] !== pathParts[i] &&\n        !patternParts[i].startsWith(\":\")\n      ) {\n        return false;\n      }\n    }\n\n    return true;\n  }\n\n  /**\n   * æå–è·¯å¾„å‚æ•°\n   */\n  static extractParams(pattern: string, path: string): Record<string, string> {\n    const params: Record<string, string> = {};\n    const patternParts = pattern.split(\"/\").filter(Boolean);\n    const pathParts = path.split(\"/\").filter(Boolean);\n\n    for (let i = 0; i < patternParts.length; i++) {\n      if (patternParts[i].startsWith(\":\")) {\n        const paramName = patternParts[i].slice(1);\n        params[paramName] = pathParts[i];\n      }\n    }\n\n    return params;\n  }\n\n  /**\n   * è®¡ç®—è·¯å¾„ç‰¹å¼‚æ€§åˆ†æ•°\n   * ç”¨äºè·¯ç”±æ’åºï¼šé™æ€ > åŠ¨æ€(:param) > é€šé…ç¬¦(*)\n   */\n  static calculatePathScore(path: string): number {\n    const parts = path.split(\"/\").filter(Boolean);\n    let score = 0;\n    for (const p of parts) {\n      if (p === \"*\")\n        score += 1; // æœ€å¼±\n      else if (p.startsWith(\":\"))\n        score += 2; // ä¸­ç­‰\n      else score += 3; // é™æ€æœ€å¼º\n    }\n    // æ›´é•¿çš„è·¯å¾„æ›´å…·ä½“ï¼Œç•¥å¾®æå‡\n    return score * 10 + parts.length;\n  }\n\n  /**\n   * åˆ¤æ–­ä¸¤ä¸ªè·¯å¾„æ˜¯å¦å¯èƒ½å†²çª\n   */\n  static pathsMayConflict(path1: string, path2: string): boolean {\n    const parts1 = path1.split(\"/\").filter(Boolean);\n    const parts2 = path2.split(\"/\").filter(Boolean);\n\n    if (parts1.length !== parts2.length) return false;\n\n    for (let i = 0; i < parts1.length; i++) {\n      const p1 = parts1[i];\n      const p2 = parts2[i];\n\n      // å¦‚æœä¸¤ä¸ªéƒ¨åˆ†éƒ½æ˜¯é™æ€çš„ä¸”ä¸åŒï¼Œåˆ™ä¸ä¼šå†²çª\n      if (\n        !p1.startsWith(\":\") &&\n        !p1.startsWith(\"*\") &&\n        !p2.startsWith(\":\") &&\n        !p2.startsWith(\"*\") &&\n        p1 !== p2\n      ) {\n        return false;\n      }\n\n      // å¦‚æœä¸€ä¸ªæ˜¯é€šé…ç¬¦ï¼Œå¦ä¸€ä¸ªæ˜¯åŠ¨æ€å‚æ•°ï¼Œå¯èƒ½å†²çª\n      if (\n        (p1 === \"*\" && p2.startsWith(\":\")) ||\n        (p2 === \"*\" && p1.startsWith(\":\"))\n      ) {\n        return true;\n      }\n    }\n\n    return false;\n  }\n}\n","/**\n * HTMLæ¸²æŸ“å·¥å…·ç±»\n * æä¾›ç»Ÿä¸€çš„HTMLæ¨¡æ¿ç”ŸæˆåŠŸèƒ½\n */\nexport class HtmlRenderer {\n  /**\n   * ç”ŸæˆåŸºç¡€HTMLæ¨¡æ¿\n   */\n  static generateBaseHtml(\n    content: string,\n    context: any,\n    clientScriptPath: string = \"/client.js\",\n  ): string {\n    return `\n      <!doctype html>\n      <html>\n        <head>\n          <meta charset=\"utf-8\">\n          <title>Vafast SSR App</title>\n          <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">\n        </head>\n        <body>\n          <div id=\"app\">${content}</div>\n          <script>\n            window.__ROUTE_INFO__ = {\n              params: ${JSON.stringify(context.params || {})},\n              query: ${JSON.stringify(context.query || {})},\n              pathname: '${context.pathname}'\n            };\n          </script>\n          <script type=\"module\" src=\"${clientScriptPath}\"></script>\n        </body>\n      </html>\n    `;\n  }\n\n  /**\n   * ç”ŸæˆVueç»„ä»¶HTML\n   */\n  static generateVueHtml(\n    content: string,\n    context: any,\n    clientScriptPath: string = \"/client.js\",\n  ): string {\n    return this.generateBaseHtml(content, context, clientScriptPath);\n  }\n\n  /**\n   * ç”ŸæˆReactç»„ä»¶HTML\n   */\n  static generateReactHtml(\n    content: string,\n    context: any,\n    clientScriptPath: string = \"/client.js\",\n  ): string {\n    return `\n      <!doctype html>\n      <html>\n        <head>\n          <meta charset=\"utf-8\">\n          <title>Vafast SSR App</title>\n          <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">\n        </head>\n        <body>\n          <div id=\"root\">${content}</div>\n          <script>\n            window.__ROUTE_INFO__ = {\n              params: ${JSON.stringify(context.params || {})},\n              query: ${JSON.stringify(context.query || {})},\n              pathname: '${context.pathname}'\n            };\n          </script>\n          <script type=\"module\" src=\"${clientScriptPath}\"></script>\n        </body>\n      </html>\n    `;\n  }\n}\n","/**\n * ä¾èµ–ç®¡ç†å™¨\n * è´Ÿè´£æŒ‰éœ€åŠ è½½å’Œç®¡ç†æ¡†æ¶ä¾èµ–\n */\nexport class DependencyManager {\n  private dependencyCache = new Map<string, any>();\n\n  /**\n   * æŒ‰éœ€è·å–æ¡†æ¶ä¾èµ–\n   */\n  async getFrameworkDeps(framework: \"vue\" | \"react\") {\n    if (this.dependencyCache.has(framework)) {\n      return this.dependencyCache.get(framework);\n    }\n\n    console.log(`ğŸ“¦ æŒ‰éœ€åŠ è½½ ${framework} ä¾èµ–...`);\n\n    try {\n      let deps;\n      switch (framework) {\n        case \"vue\":\n          deps = await Promise.all([\n            import(\"vue\"),\n            import(\"@vue/server-renderer\"),\n          ]);\n          break;\n        case \"react\":\n          deps = await Promise.all([\n            import(\"react\"),\n            import(\"react-dom/server\"),\n          ]);\n          break;\n        default:\n          throw new Error(`ä¸æ”¯æŒçš„æ¡†æ¶: ${framework}`);\n      }\n\n      this.dependencyCache.set(framework, deps);\n      console.log(`âœ… ${framework} ä¾èµ–åŠ è½½å®Œæˆ`);\n      return deps;\n    } catch (error) {\n      console.error(`âŒ ${framework} ä¾èµ–åŠ è½½å¤±è´¥:`, error);\n      throw error;\n    }\n  }\n\n  /**\n   * æ£€æµ‹ç»„ä»¶ç±»å‹\n   */\n  detectComponentType(component: any): \"vue\" | \"react\" {\n    // ç®€å•çš„ç»„ä»¶ç±»å‹æ£€æµ‹\n    if (component.render && typeof component.render === \"function\") {\n      return \"vue\";\n    }\n    if (component.$$typeof) {\n      return \"react\";\n    }\n    // é»˜è®¤ä½¿ç”¨ Vue\n    return \"vue\";\n  }\n\n  /**\n   * æ¸…é™¤ç¼“å­˜\n   */\n  clearCache(): void {\n    this.dependencyCache.clear();\n    console.log(\"ğŸ§¹ ä¾èµ–ç¼“å­˜å·²æ¸…é™¤\");\n  }\n\n  /**\n   * è·å–ç¼“å­˜çŠ¶æ€\n   */\n  getCacheStatus(): Record<string, boolean> {\n    const status: Record<string, boolean> = {};\n    for (const [framework] of this.dependencyCache) {\n      status[framework] = true;\n    }\n    return status;\n  }\n}\n","import type {\n  ComponentRoute,\n  NestedComponentRoute,\n  FlattenedComponentRoute,\n} from \"../types/component-route\";\nimport { flattenComponentRoutes } from \"../middleware/component-router\";\nimport { BaseServer } from \"./base-server\";\nimport { PathMatcher } from \"../utils/path-matcher\";\nimport { HtmlRenderer } from \"../utils/html-renderer\";\nimport { DependencyManager } from \"../utils/dependency-manager\";\n\n/**\n * ç»„ä»¶è·¯ç”±æœåŠ¡å™¨\n * ä¸“é—¨å¤„ç†å£°æ˜å¼ç»„ä»¶è·¯ç”±\n */\nexport class ComponentServer extends BaseServer {\n  private routes: FlattenedComponentRoute[];\n  private dependencyManager: DependencyManager;\n\n  constructor(routes: (ComponentRoute | NestedComponentRoute)[]) {\n    super();\n    this.routes = flattenComponentRoutes(routes);\n    this.dependencyManager = new DependencyManager();\n\n    // æ£€æµ‹è·¯ç”±å†²çª\n    this.detectRouteConflicts(this.routes);\n    this.logFlattenedRoutes(this.routes, \"ç»„ä»¶è·¯ç”±\");\n    console.log(\"ğŸš€ ä¾èµ–æŒ‰éœ€åŠ è½½ï¼ŒæœåŠ¡å™¨å¯åŠ¨å®Œæˆ\");\n  }\n\n  /**\n   * å¤„ç†è¯·æ±‚\n   */\n  async fetch(req: Request): Promise<Response> {\n    const url = new URL(req.url);\n    const pathname = url.pathname;\n    const method = req.method;\n\n    // åªæ”¯æŒ GET è¯·æ±‚\n    if (method !== \"GET\") {\n      return new Response(\"Method Not Allowed\", { status: 405 });\n    }\n\n    // æŸ¥æ‰¾åŒ¹é…çš„è·¯ç”±\n    let matchedRoute: FlattenedComponentRoute | null = null;\n    for (const route of this.routes) {\n      if (PathMatcher.matchPath(route.fullPath, pathname)) {\n        matchedRoute = route;\n        break;\n      }\n    }\n\n    if (!matchedRoute) {\n      return new Response(\"Not Found\", { status: 404 });\n    }\n\n    try {\n      // åˆ›å»ºä¸­é—´ä»¶ä¸Šä¸‹æ–‡\n      const context = {\n        req,\n        params: PathMatcher.extractParams(matchedRoute.fullPath, pathname),\n        query: Object.fromEntries(url.searchParams),\n        pathname,\n      };\n\n      // æ‰§è¡Œä¸­é—´ä»¶é“¾ï¼Œä¸­é—´ä»¶ä¼šå¤„ç†ç»„ä»¶æ¸²æŸ“\n      return await this.executeMiddlewareChain(\n        matchedRoute.middlewareChain,\n        context,\n        matchedRoute.component,\n      );\n    } catch (error) {\n      console.error(\"ç»„ä»¶æ¸²æŸ“å¤±è´¥:\", error);\n      return new Response(\"Internal Server Error\", { status: 500 });\n    }\n  }\n\n  /**\n   * æ‰§è¡Œä¸­é—´ä»¶é“¾\n   */\n  private async executeMiddlewareChain(\n    middlewareChain: any[],\n    context: any,\n    componentImport: () => Promise<any>,\n  ): Promise<Response> {\n    // åˆ›å»ºæœ€ç»ˆçš„æ¸²æŸ“å‡½æ•°\n    const renderComponent = async () => {\n      const componentModule = await componentImport();\n      const component = componentModule.default || componentModule;\n\n      // è‡ªåŠ¨æ£€æµ‹ç»„ä»¶ç±»å‹\n      const componentType =\n        this.dependencyManager.detectComponentType(component);\n\n      // æŒ‰éœ€åŠ è½½ä¾èµ–\n      const deps = await this.dependencyManager.getFrameworkDeps(componentType);\n\n      // æ ¹æ®ç»„ä»¶ç±»å‹æ¸²æŸ“\n      if (componentType === \"vue\") {\n        return await this.renderVueComponent(component, context, deps);\n      } else if (componentType === \"react\") {\n        return await this.renderReactComponent(component, context, deps);\n      } else {\n        throw new Error(`ä¸æ”¯æŒçš„ç»„ä»¶ç±»å‹: ${componentType}`);\n      }\n    };\n\n    // æ‰§è¡Œä¸­é—´ä»¶é“¾\n    let index = 0;\n    const next = async (): Promise<Response> => {\n      if (index >= middlewareChain.length) {\n        return await renderComponent();\n      }\n\n      const middleware = middlewareChain[index++];\n      return await middleware(context.req, next);\n    };\n\n    return await next();\n  }\n\n  /**\n   * æ¸²æŸ“ Vue ç»„ä»¶\n   */\n  private async renderVueComponent(\n    component: any,\n    context: any,\n    deps: any,\n  ): Promise<Response> {\n    try {\n      const [vue, renderer] = deps;\n      const app = vue.createSSRApp(component);\n\n      // æä¾›è·¯ç”±ä¿¡æ¯\n      app.provide(\"routeInfo\", {\n        params: context.params || {},\n        query: context.query || {},\n        pathname: context.pathname,\n      });\n\n      const html = await renderer.renderToString(app);\n      const fullHtml = HtmlRenderer.generateVueHtml(html, context);\n\n      return new Response(fullHtml, {\n        headers: { \"Content-Type\": \"text/html; charset=utf-8\" },\n      });\n    } catch (error) {\n      console.error(\"Vue ç»„ä»¶æ¸²æŸ“å¤±è´¥:\", error);\n      return new Response(\"Vue Component Render Error\", { status: 500 });\n    }\n  }\n\n  /**\n   * æ¸²æŸ“ React ç»„ä»¶\n   */\n  private async renderReactComponent(\n    component: any,\n    context: any,\n    deps: any,\n  ): Promise<Response> {\n    try {\n      const [react, renderer] = deps;\n      const content = react.createElement(component, {\n        req: context.req,\n        params: context.params || {},\n        query: context.query || {},\n      });\n\n      const html = renderer.renderToString(content);\n      const fullHtml = HtmlRenderer.generateReactHtml(html, context);\n\n      return new Response(fullHtml, {\n        headers: { \"Content-Type\": \"text/html; charset=utf-8\" },\n      });\n    } catch (error) {\n      console.error(\"React ç»„ä»¶æ¸²æŸ“å¤±è´¥:\", error);\n      return new Response(\"React Component Render Error\", { status: 500 });\n    }\n  }\n\n  /**\n   * è·å–ä¾èµ–ç®¡ç†å™¨ï¼ˆç”¨äºå¤–éƒ¨è®¿é—®ï¼‰\n   */\n  getDependencyManager(): DependencyManager {\n    return this.dependencyManager;\n  }\n}\n","import type { Route, NestedRoute } from \"../types\";\nimport type {\n  ComponentRoute,\n  NestedComponentRoute,\n} from \"../types/component-route\";\nimport { Server } from \"../server\";\nimport { ComponentServer } from \"./component-server\";\n\n/**\n * æœåŠ¡å™¨å·¥å‚ç±»\n * ç”¨äºåˆ›å»ºå’Œç®¡ç†ä¸åŒç±»å‹çš„æœåŠ¡å™¨\n */\nexport class ServerFactory {\n  private servers: Map<string, Server | ComponentServer> = new Map();\n\n  /**\n   * åˆ›å»ºæ ‡å‡†REST APIæœåŠ¡å™¨\n   */\n  createRestServer(routes: (Route | NestedRoute)[]): Server {\n    const server = new Server(routes);\n    this.servers.set(\"rest\", server);\n    return server;\n  }\n\n  /**\n   * åˆ›å»ºç»„ä»¶æœåŠ¡å™¨\n   */\n  createComponentServer(\n    routes: (ComponentRoute | NestedComponentRoute)[],\n  ): ComponentServer {\n    const server = new ComponentServer(routes);\n    this.servers.set(\"component\", server);\n    return server;\n  }\n\n  /**\n   * è·å–æŒ‡å®šç±»å‹çš„æœåŠ¡å™¨\n   */\n  getServer(type: \"rest\" | \"component\"): Server | ComponentServer | undefined {\n    return this.servers.get(type);\n  }\n\n  /**\n   * è·å–æ‰€æœ‰æœåŠ¡å™¨\n   */\n  getAllServers(): Map<string, Server | ComponentServer> {\n    return this.servers;\n  }\n\n  /**\n   * ç§»é™¤æŒ‡å®šç±»å‹çš„æœåŠ¡å™¨\n   */\n  removeServer(type: string): boolean {\n    return this.servers.delete(type);\n  }\n\n  /**\n   * æ¸…é™¤æ‰€æœ‰æœåŠ¡å™¨\n   */\n  clearServers(): void {\n    this.servers.clear();\n  }\n\n  /**\n   * è·å–æœåŠ¡å™¨çŠ¶æ€ä¿¡æ¯\n   */\n  getServerStatus(): Record<string, { type: string; routes: number }> {\n    const status: Record<string, { type: string; routes: number }> = {};\n\n    for (const [name, server] of this.servers) {\n      if (server instanceof Server) {\n        status[name] = {\n          type: \"REST API\",\n          routes: (server as any).routes?.length || 0,\n        };\n      } else if (server instanceof ComponentServer) {\n        status[name] = {\n          type: \"Component\",\n          routes: (server as any).routes?.length || 0,\n        };\n      }\n    }\n\n    return status;\n  }\n}\n","// src/parsers.ts\nimport qs from \"qs\";\nimport cookie from \"cookie\";\n\n// æ–‡ä»¶ä¿¡æ¯æ¥å£\nexport interface FileInfo {\n  name: string;\n  type: string;\n  size: number;\n  data: ArrayBuffer;\n}\n\n// è¡¨å•æ•°æ®æ¥å£\nexport interface FormData {\n  fields: Record<string, string>;\n  files: Record<string, FileInfo>;\n}\n\n/**\n * ç®€åŒ–çš„è¯·æ±‚ä½“è§£æå‡½æ•°\n * ä¼˜å…ˆç®€æ´æ€§ï¼Œå¤„ç†æœ€å¸¸è§çš„åœºæ™¯\n */\nexport async function parseBody(req: Request): Promise<unknown> {\n  const contentType = req.headers.get(\"content-type\") || \"\";\n  if (contentType.includes(\"application/json\")) {\n    return await req.json();\n  }\n  if (contentType.includes(\"application/x-www-form-urlencoded\")) {\n    const text = await req.text();\n    return Object.fromEntries(new URLSearchParams(text));\n  }\n  return await req.text(); // fallback\n}\n\n/**\n * è§£æ multipart/form-data æ ¼å¼\n * æ”¯æŒæ–‡ä»¶ä¸Šä¼ å’Œæ™®é€šè¡¨å•å­—æ®µ\n */\nasync function parseMultipartFormData(req: Request): Promise<FormData> {\n  const formData = await req.formData();\n  const result: FormData = {\n    fields: {},\n    files: {},\n  };\n\n  for (const [key, value] of formData.entries()) {\n    if (\n      typeof value === \"object\" &&\n      value !== null &&\n      \"name\" in value &&\n      \"type\" in value &&\n      \"size\" in value\n    ) {\n      // å¤„ç†æ–‡ä»¶\n      const file = value as any;\n      const arrayBuffer = await file.arrayBuffer();\n      result.files[key] = {\n        name: file.name,\n        type: file.type,\n        size: file.size,\n        data: arrayBuffer,\n      };\n    } else {\n      // å¤„ç†æ™®é€šå­—æ®µ\n      result.fields[key] = value as string;\n    }\n  }\n\n  return result;\n}\n\n/**\n * è§£æè¯·æ±‚ä½“ä¸ºç‰¹å®šç±»å‹\n * æä¾›ç±»å‹å®‰å…¨çš„è§£ææ–¹æ³•\n */\nexport async function parseBodyAs<T>(req: Request): Promise<T> {\n  const body = await parseBody(req);\n  return body as T;\n}\n\n/**\n * è§£æè¯·æ±‚ä½“ä¸ºè¡¨å•æ•°æ®\n * ä¸“é—¨ç”¨äºå¤„ç† multipart/form-data\n */\nexport async function parseFormData(req: Request): Promise<FormData> {\n  const contentType = req.headers.get(\"content-type\") || \"\";\n\n  if (!contentType.includes(\"multipart/form-data\")) {\n    throw new Error(\"è¯·æ±‚ä¸æ˜¯ multipart/form-data æ ¼å¼\");\n  }\n\n  return await parseMultipartFormData(req);\n}\n\n/**\n * è§£æè¯·æ±‚ä½“ä¸ºæ–‡ä»¶\n * ä¸“é—¨ç”¨äºå¤„ç†æ–‡ä»¶ä¸Šä¼ \n */\nexport async function parseFile(req: Request): Promise<FileInfo> {\n  const contentType = req.headers.get(\"content-type\") || \"\";\n\n  if (!contentType.includes(\"multipart/form-data\")) {\n    throw new Error(\"è¯·æ±‚ä¸æ˜¯ multipart/form-data æ ¼å¼\");\n  }\n\n  const formData = await parseMultipartFormData(req);\n  const fileKeys = Object.keys(formData.files);\n\n  if (fileKeys.length === 0) {\n    throw new Error(\"è¯·æ±‚ä¸­æ²¡æœ‰æ–‡ä»¶\");\n  }\n\n  if (fileKeys.length > 1) {\n    throw new Error(\"è¯·æ±‚ä¸­åŒ…å«å¤šä¸ªæ–‡ä»¶ï¼Œè¯·ä½¿ç”¨ parseFormData\");\n  }\n\n  return formData.files[fileKeys[0]];\n}\n\n/**\n * å¿«é€Ÿæå– query stringï¼ˆé¿å…åˆ›å»º URL å¯¹è±¡ï¼‰\n */\nfunction extractQueryString(url: string): string {\n  const qIndex = url.indexOf(\"?\");\n  if (qIndex === -1) return \"\";\n\n  const hashIndex = url.indexOf(\"#\", qIndex);\n  return hashIndex === -1\n    ? url.substring(qIndex + 1)\n    : url.substring(qIndex + 1, hashIndex);\n}\n\n/** è·å–æŸ¥è¯¢å­—ç¬¦ä¸²ï¼Œç›´æ¥è¿”å›å¯¹è±¡ */\nexport function parseQuery(req: Request): Record<string, unknown> {\n  const queryString = extractQueryString(req.url);\n  if (!queryString) return {};\n  return qs.parse(queryString);\n}\n\n/**\n * å¿«é€Ÿè§£æç®€å•æŸ¥è¯¢å­—ç¬¦ä¸²ï¼ˆä¸æ”¯æŒåµŒå¥—ï¼Œä½†æ›´å¿«ï¼‰\n * é€‚ç”¨äºç®€å•çš„ key=value&key2=value2 åœºæ™¯\n */\nexport function parseQueryFast(req: Request): Record<string, string> {\n  const queryString = extractQueryString(req.url);\n  if (!queryString) return {};\n\n  const result: Record<string, string> = Object.create(null);\n  const pairs = queryString.split(\"&\");\n\n  for (const pair of pairs) {\n    const eqIndex = pair.indexOf(\"=\");\n    if (eqIndex === -1) {\n      result[decodeURIComponent(pair)] = \"\";\n    } else {\n      const key = decodeURIComponent(pair.substring(0, eqIndex));\n      const value = decodeURIComponent(pair.substring(eqIndex + 1));\n      result[key] = value;\n    }\n  }\n\n  return result;\n}\n\n/** è§£æè¯·æ±‚å¤´ï¼Œè¿”å›å¯¹è±¡ */\nexport function parseHeaders(req: Request): Record<string, string> {\n  const headers: Record<string, string> = Object.create(null);\n  req.headers.forEach((value, key) => {\n    headers[key] = value;\n  });\n  return headers;\n}\n\n/**\n * è·å–å•ä¸ªè¯·æ±‚å¤´ï¼ˆé¿å…è§£æå…¨éƒ¨ï¼‰\n */\nexport function getHeader(req: Request, name: string): string | null {\n  return req.headers.get(name);\n}\n\n/** ä½¿ç”¨cookieåº“è§£æCookieï¼Œä¿è¯å¯é æ€§ */\nexport function parseCookies(req: Request): Record<string, string> {\n  const cookieHeader = req.headers.get(\"cookie\");\n  if (!cookieHeader) return {};\n\n  try {\n    const parsed = cookie.parse(cookieHeader);\n    // è¿‡æ»¤æ‰undefinedå’Œnullå€¼\n    const result: Record<string, string> = {};\n    for (const [key, value] of Object.entries(parsed)) {\n      if (value !== undefined && value !== null) {\n        result[key] = value;\n      }\n    }\n    return result;\n  } catch {\n    return {};\n  }\n}\n\n/**\n * å¿«é€Ÿè§£æ Cookieï¼ˆç®€åŒ–ç‰ˆï¼Œä¸ä½¿ç”¨å¤–éƒ¨åº“ï¼‰\n * é€‚ç”¨äºç®€å•çš„ cookie åœºæ™¯\n */\nexport function parseCookiesFast(req: Request): Record<string, string> {\n  const cookieHeader = req.headers.get(\"cookie\");\n  if (!cookieHeader) return {};\n\n  const result: Record<string, string> = Object.create(null);\n  const pairs = cookieHeader.split(\";\");\n\n  for (const pair of pairs) {\n    const trimmed = pair.trim();\n    const eqIndex = trimmed.indexOf(\"=\");\n    if (eqIndex > 0) {\n      const key = trimmed.substring(0, eqIndex).trim();\n      const value = trimmed.substring(eqIndex + 1).trim();\n      // ç§»é™¤å¼•å·\n      result[key] =\n        value.startsWith('\"') && value.endsWith('\"')\n          ? value.slice(1, -1)\n          : value;\n    }\n  }\n\n  return result;\n}\n\n/**\n * è·å–å•ä¸ª Cookie å€¼ï¼ˆé¿å…è§£æå…¨éƒ¨ï¼‰\n */\nexport function getCookie(req: Request, name: string): string | null {\n  const cookieHeader = req.headers.get(\"cookie\");\n  if (!cookieHeader) return null;\n\n  const prefix = `${name}=`;\n  const pairs = cookieHeader.split(\";\");\n\n  for (const pair of pairs) {\n    const trimmed = pair.trim();\n    if (trimmed.startsWith(prefix)) {\n      const value = trimmed.substring(prefix.length).trim();\n      return value.startsWith('\"') && value.endsWith('\"')\n        ? value.slice(1, -1)\n        : value;\n    }\n  }\n\n  return null;\n}\n","/**\n * Go é£æ ¼çš„é”™è¯¯å¤„ç†å·¥å…·\n * å°† Promise è½¬æ¢ä¸º [Error | null, T | undefined] æ ¼å¼\n *\n * @author Framework Team\n * @version 1.0.0\n * @license MIT\n */\n\n/**\n * Go é£æ ¼çš„é”™è¯¯å¤„ç†å·¥å…·\n * å°† Promise è½¬æ¢ä¸º [Error | null, T | undefined] æ ¼å¼\n *\n * @param promise è¦å¤„ç†çš„ Promise\n * @returns [Error | null, T | undefined] å…ƒç»„ï¼Œç¬¬ä¸€ä¸ªå…ƒç´ æ˜¯é”™è¯¯ï¼Œç¬¬äºŒä¸ªæ˜¯ç»“æœ\n *\n * @example\n * ```typescript\n * const [error, result] = await goAwait(someAsyncFunction());\n * if (error) {\n *   console.error(\"æ“ä½œå¤±è´¥:\", error);\n * } else {\n *   console.log(\"æ“ä½œæˆåŠŸ:\", result);\n * }\n * ```\n */\nexport function goAwait<T>(\n  promise: Promise<T>,\n): Promise<[Error | null, T | undefined]> {\n  return promise\n    .then<[null, T]>((data) => [null, data])\n    .catch<\n      [Error, undefined]\n    >((err) => [err instanceof Error ? err : new Error(String(err)), undefined]);\n}\n","/**\n * Schema éªŒè¯å™¨ - ç®€æ´ç‰ˆ\n *\n * ç‰¹ç‚¹ï¼š\n * - WeakMap ç¼“å­˜é¿å…å†…å­˜æ³„æ¼\n * - TypeCompiler JIT ç¼–è¯‘ï¼Œæ€§èƒ½æœ€ä½³\n * - æ”¯æŒ FormatRegistryï¼ˆéœ€ç¡®ä¿åŒä¸€å®ä¾‹ï¼‰\n *\n * @version 7.0.0\n */\n\nimport { Type } from \"@sinclair/typebox\";\nimport type { Static, TSchema } from \"@sinclair/typebox\";\nimport { TypeCompiler, type TypeCheck } from \"@sinclair/typebox/compiler\";\nimport { Value } from \"@sinclair/typebox/value\";\n\n// ============== ç±»å‹å®šä¹‰ ==============\n\n/** Schema é…ç½®æ¥å£ */\nexport interface SchemaConfig {\n  body?: TSchema;\n  query?: TSchema;\n  params?: TSchema;\n  headers?: TSchema;\n  cookies?: TSchema;\n}\n\n/** éªŒè¯é”™è¯¯æ¥å£ */\nexport interface ValidationError {\n  path: string;\n  message: string;\n  code: string;\n  value?: unknown;\n}\n\n/** éªŒè¯ç»“æœ */\nexport type ValidationResult<T = unknown> =\n  | { success: true; data: T }\n  | { success: false; errors: ValidationError[] };\n\n// ============== ç¼“å­˜ ==============\n\n/** ç¼–è¯‘å™¨ç¼“å­˜ - WeakMap é¿å…å†…å­˜æ³„æ¼ */\nconst compilerCache = new WeakMap<TSchema, TypeCheck<TSchema>>();\n\n// ============== æ ¸å¿ƒå‡½æ•° ==============\n\n/**\n * è·å–æˆ–åˆ›å»ºç¼–è¯‘åçš„éªŒè¯å™¨\n */\nfunction getCompiledValidator<T extends TSchema>(schema: T): TypeCheck<T> {\n  let compiler = compilerCache.get(schema);\n  if (!compiler) {\n    compiler = TypeCompiler.Compile(schema);\n    compilerCache.set(schema, compiler);\n  }\n  return compiler as TypeCheck<T>;\n}\n\n/**\n * éªŒè¯å•ä¸ª Schemaï¼ˆè¿”å›ç»“æœå¯¹è±¡ï¼‰\n */\nexport function validateSchema<T extends TSchema>(\n  schema: T,\n  data: unknown,\n): ValidationResult<Static<T>> {\n  try {\n    const compiler = getCompiledValidator(schema);\n\n    if (compiler.Check(data)) {\n      return { success: true, data: data as Static<T> };\n    }\n\n    // æ”¶é›†é”™è¯¯\n    const errors: ValidationError[] = [];\n    for (const error of compiler.Errors(data)) {\n      errors.push({\n        path: error.path,\n        message: error.message,\n        code: \"VALIDATION_FAILED\",\n        value: error.value,\n      });\n    }\n    return { success: false, errors };\n  } catch (error) {\n    return {\n      success: false,\n      errors: [\n        {\n          path: \"\",\n          message: error instanceof Error ? error.message : \"éªŒè¯å¼‚å¸¸\",\n          code: \"VALIDATION_EXCEPTION\",\n        },\n      ],\n    };\n  }\n}\n\n/**\n * éªŒè¯ Schemaï¼ˆæŠ›å‡ºå¼‚å¸¸ç‰ˆæœ¬ï¼Œç”¨äºæ¡†æ¶å†…éƒ¨ï¼‰\n */\nexport function validateSchemaOrThrow<T extends TSchema>(\n  schema: T,\n  data: unknown,\n  context: string,\n): Static<T> {\n  const compiler = getCompiledValidator(schema);\n\n  if (!compiler.Check(data)) {\n    throw new Error(`${context}éªŒè¯å¤±è´¥`);\n  }\n\n  return data as Static<T>;\n}\n\n/**\n * å¿«é€ŸéªŒè¯ï¼ˆåªè¿”å›å¸ƒå°”å€¼ï¼‰\n */\nexport function validateFast<T extends TSchema>(\n  schema: T,\n  data: unknown,\n): data is Static<T> {\n  const compiler = getCompiledValidator(schema);\n  return compiler.Check(data);\n}\n\n/**\n * æ‰¹é‡éªŒè¯æ‰€æœ‰ Schemaï¼ˆç”¨äºè¯·æ±‚éªŒè¯ï¼‰\n */\nexport function validateAllSchemas(\n  config: SchemaConfig,\n  data: {\n    body: unknown;\n    query: unknown;\n    params: unknown;\n    headers: unknown;\n    cookies: unknown;\n  },\n): typeof data {\n  if (config.body) {\n    validateSchemaOrThrow(config.body, data.body, \"è¯·æ±‚ä½“\");\n  }\n  if (config.query) {\n    validateSchemaOrThrow(config.query, data.query, \"Queryå‚æ•°\");\n  }\n  if (config.params) {\n    validateSchemaOrThrow(config.params, data.params, \"è·¯å¾„å‚æ•°\");\n  }\n  if (config.headers) {\n    validateSchemaOrThrow(config.headers, data.headers, \"è¯·æ±‚å¤´\");\n  }\n  if (config.cookies) {\n    validateSchemaOrThrow(config.cookies, data.cookies, \"Cookie\");\n  }\n  return data;\n}\n\n/**\n * é¢„ç¼–è¯‘ Schemaï¼ˆå¯åŠ¨æ—¶è°ƒç”¨ï¼Œé¿å…é¦–æ¬¡è¯·æ±‚å¼€é”€ï¼‰\n */\nexport function precompileSchemas(config: SchemaConfig): void {\n  if (config.body) getCompiledValidator(config.body);\n  if (config.query) getCompiledValidator(config.query);\n  if (config.params) getCompiledValidator(config.params);\n  if (config.headers) getCompiledValidator(config.headers);\n  if (config.cookies) getCompiledValidator(config.cookies);\n}\n\n/**\n * åˆ›å»ºç±»å‹ç‰¹åŒ–çš„éªŒè¯å™¨ï¼ˆé«˜é¢‘ä½¿ç”¨åœºæ™¯ï¼‰\n */\nexport function createValidator<T extends TSchema>(\n  schema: T,\n): (data: unknown) => ValidationResult<Static<T>> {\n  return (data: unknown) => validateSchema(schema, data);\n}\n\n/**\n * è·å–ç¼“å­˜ç»Ÿè®¡ï¼ˆè°ƒè¯•ç”¨ï¼‰\n */\nexport function getValidatorCacheStats(): { cacheType: string; note: string } {\n  return {\n    cacheType: \"WeakMap\",\n    note: \"WeakMap ç¼“å­˜ä¼šéš Schema å¯¹è±¡è‡ªåŠ¨æ¸…ç†ï¼Œæ— å†…å­˜æ³„æ¼é£é™©\",\n  };\n}\n\n// å¯¼å‡º TypeBox ç±»å‹\nexport { Type, Static, TSchema };\n","/**\n * ç±»å‹å®‰å…¨çš„è·¯ç”±å¤„ç†å™¨å·¥å‚\n *\n * éæŸ¯é‡ŒåŒ–è®¾è®¡ï¼ŒAPI æ›´ç®€æ´\n *\n * @author Framework Team\n * @version 3.0.0\n * @license MIT\n */\n\nimport type {\n  RouteSchema,\n  HandlerContext,\n  HandlerContextWithExtra,\n} from \"../types/schema\";\nimport { parseBody, parseQuery, parseHeaders, parseCookies } from \"./parsers\";\nimport { goAwait } from \"./go-await\";\nimport { json } from \"./response\";\nimport {\n  validateAllSchemas,\n  precompileSchemas,\n} from \"./validators/validators\";\n\n/**\n * è‡ªåŠ¨å“åº”è½¬æ¢\n * å°†å„ç§è¿”å›å€¼ç±»å‹è½¬æ¢ä¸º Response å¯¹è±¡\n */\nfunction autoResponse(result: unknown): Response {\n  // å·²ç»æ˜¯ Response\n  if (result instanceof Response) {\n    return result;\n  }\n\n  // null/undefined -> 204\n  if (result === null || result === undefined) {\n    return new Response(null, { status: 204 });\n  }\n\n  // å­—ç¬¦ä¸² -> text/plain\n  if (typeof result === \"string\") {\n    return new Response(result, {\n      headers: { \"Content-Type\": \"text/plain; charset=utf-8\" },\n    });\n  }\n\n  // æ•°å­—/å¸ƒå°” -> text/plain\n  if (typeof result === \"number\" || typeof result === \"boolean\") {\n    return new Response(String(result), {\n      headers: { \"Content-Type\": \"text/plain; charset=utf-8\" },\n    });\n  }\n\n  // å¯¹è±¡ -> æ£€æŸ¥æ˜¯å¦æ˜¯ { data, status, headers } æ ¼å¼\n  if (typeof result === \"object\") {\n    const obj = result as Record<string, unknown>;\n    if (\"data\" in obj && (\"status\" in obj || \"headers\" in obj)) {\n      const { data, status = 200, headers = {} } = obj;\n\n      if (data === null || data === undefined) {\n        return new Response(null, {\n          status: status === 200 ? 204 : (status as number),\n          headers: headers as HeadersInit,\n        });\n      }\n\n      if (\n        typeof data === \"string\" ||\n        typeof data === \"number\" ||\n        typeof data === \"boolean\"\n      ) {\n        return new Response(String(data), {\n          status: status as number,\n          headers: {\n            \"Content-Type\": \"text/plain; charset=utf-8\",\n            ...(headers as Record<string, string>),\n          },\n        });\n      }\n\n      return json(data, status as number, headers as Record<string, string>);\n    }\n\n    // æ™®é€šå¯¹è±¡ -> JSON\n    return json(result);\n  }\n\n  // å…¶ä»–ç±»å‹ -> 204\n  return new Response(null, { status: 204 });\n}\n\n/**\n * å¤„ç†éªŒè¯é”™è¯¯\n */\nfunction handleValidationError(error: Error): Response {\n  return json(\n    {\n      success: false,\n      error: \"Validation Error\",\n      message: error.message,\n      timestamp: new Date().toISOString(),\n    },\n    400,\n  );\n}\n\n/**\n * å¤„ç†å†…éƒ¨é”™è¯¯\n */\nfunction handleInternalError(error: unknown): Response {\n  return json(\n    {\n      success: false,\n      error: \"Internal Error\",\n      message: error instanceof Error ? error.message : \"æœªçŸ¥é”™è¯¯\",\n    },\n    500,\n  );\n}\n\n/** ç©º schema çš„ä¸Šä¸‹æ–‡ç±»å‹ */\ntype EmptySchemaContext = {\n  req: Request;\n  body: unknown;\n  query: Record<string, string>;\n  params: Record<string, string>;\n  headers: Record<string, string>;\n  cookies: Record<string, string>;\n};\n\n/**\n * åˆ¤æ–­æ˜¯å¦ä¸º handler å‡½æ•°\n */\nfunction isHandler(value: unknown): value is (...args: unknown[]) => unknown {\n  return typeof value === \"function\";\n}\n\n/**\n * åˆ›å»ºç±»å‹å®‰å…¨çš„è·¯ç”±å¤„ç†å™¨\n *\n * @example\n * ```typescript\n * // æ—  schema - ç›´æ¥ä¼ å…¥ handler\n * createHandler(({ params }) => `User: ${params.id}`)\n *\n * // æœ‰ schema - ä¼ å…¥ schema å’Œ handler\n * createHandler(\n *   { body: Type.Object({ name: Type.String() }) },\n *   ({ body }) => ({ hello: body.name })\n * )\n * ```\n */\n/**\n * å¸¦ç±»å‹æ¨æ–­çš„ Handler - ä¿ç•™è¿”å›ç±»å‹ä¿¡æ¯ç”¨äºå®¢æˆ·ç«¯ç±»å‹æ¨æ–­\n */\nexport type InferableHandler<TReturn, TSchema extends RouteSchema = RouteSchema> = ((req: Request) => Promise<Response>) & {\n  /** è¿”å›ç±»å‹æ ‡è®°ï¼ˆä»…ç”¨äºç±»å‹æ¨æ–­ï¼Œè¿è¡Œæ—¶ä¸å­˜åœ¨ï¼‰ */\n  __returnType: TReturn;\n  /** Schema ç±»å‹æ ‡è®° */\n  __schema: TSchema;\n};\n\n\n// é‡è½½ 1: æ—  schema\nexport function createHandler<R>(\n  handler: (ctx: EmptySchemaContext) => R | Promise<R>,\n): InferableHandler<R>;\n\n// é‡è½½ 2: æœ‰ schema\nexport function createHandler<const T extends RouteSchema, R>(\n  schema: T,\n  handler: (ctx: HandlerContext<T>) => R | Promise<R>,\n): InferableHandler<R, T>;\n\n// å®ç°\nexport function createHandler<const T extends RouteSchema, R>(\n  schemaOrHandler: T | ((ctx: EmptySchemaContext) => R | Promise<R>),\n  maybeHandler?: (ctx: HandlerContext<T>) => R | Promise<R>,\n): InferableHandler<R, T> {\n  // åˆ¤æ–­è°ƒç”¨æ–¹å¼\n  const hasSchema = !isHandler(schemaOrHandler);\n  const schema = hasSchema ? (schemaOrHandler as T) : ({} as T);\n  const handler = hasSchema\n    ? maybeHandler!\n    : (schemaOrHandler as (ctx: HandlerContext<T>) => R | Promise<R>);\n\n  // é¢„ç¼–è¯‘ schema\n  if (\n    schema.body ||\n    schema.query ||\n    schema.params ||\n    schema.headers ||\n    schema.cookies\n  ) {\n    precompileSchemas(schema);\n  }\n\n  const handlerFn = async (req: Request): Promise<Response> => {\n    try {\n      // è§£æè¯·æ±‚æ•°æ®\n      const query = parseQuery(req);\n      const headers = parseHeaders(req);\n      const cookies = parseCookies(req);\n      const params =\n        ((req as unknown as Record<string, unknown>).params as Record<\n          string,\n          string\n        >) || {};\n\n      // è§£æè¯·æ±‚ä½“\n      let body: unknown = undefined;\n      if (req.method !== \"GET\" && req.method !== \"HEAD\") {\n        const [, parsedBody] = await goAwait(parseBody(req));\n        body = parsedBody;\n      }\n\n      // éªŒè¯ schema\n      const data = { body, query, params, headers, cookies };\n      if (\n        schema.body ||\n        schema.query ||\n        schema.params ||\n        schema.headers ||\n        schema.cookies\n      ) {\n        validateAllSchemas(schema, data);\n      }\n\n      // è°ƒç”¨ handler\n      const result = await handler({\n        req,\n        body: body as HandlerContext<T>[\"body\"],\n        query: query as HandlerContext<T>[\"query\"],\n        params: params as HandlerContext<T>[\"params\"],\n        headers: headers as HandlerContext<T>[\"headers\"],\n        cookies: cookies as HandlerContext<T>[\"cookies\"],\n      });\n\n      return autoResponse(result);\n    } catch (error) {\n      if (error instanceof Error && error.message.includes(\"éªŒè¯å¤±è´¥\")) {\n        return handleValidationError(error);\n      }\n      return handleInternalError(error);\n    }\n  };\n\n  // ç±»å‹æ–­è¨€ï¼šè¿™äº›å±æ€§åªåœ¨ç¼–è¯‘æ—¶ç”¨äºç±»å‹æ¨æ–­ï¼Œè¿è¡Œæ—¶ä¸å­˜åœ¨\n  return handlerFn as InferableHandler<R, T>;\n}\n\n/**\n * åˆ›å»ºå¸¦é¢å¤–ä¸Šä¸‹æ–‡çš„è·¯ç”±å¤„ç†å™¨\n *\n * ç”¨äºä¸­é—´ä»¶æ³¨å…¥é¢å¤–æ•°æ®çš„åœºæ™¯\n *\n * @example\n * ```typescript\n * // å®šä¹‰ä¸­é—´ä»¶æ³¨å…¥çš„ç±»å‹\n * type AuthContext = { user: { id: string; role: string } };\n *\n * // æ—  schema\n * createHandlerWithExtra<AuthContext>(({ user }) => {\n *   return { userId: user.id };\n * })\n *\n * // æœ‰ schema\n * createHandlerWithExtra<AuthContext>(\n *   { body: Type.Object({ action: Type.String() }) },\n *   ({ body, user }) => ({ success: true, userId: user.id })\n * )\n * ```\n */\n// é‡è½½ 1: æ—  schema\nexport function createHandlerWithExtra<\n  TExtra extends Record<string, unknown> = Record<string, never>,\n  R = unknown,\n>(\n  handler: (ctx: EmptySchemaContext & TExtra) => R | Promise<R>,\n): (req: Request) => Promise<Response>;\n\n// é‡è½½ 2: æœ‰ schema\nexport function createHandlerWithExtra<\n  TExtra extends Record<string, unknown> = Record<string, never>,\n  const T extends RouteSchema = RouteSchema,\n  R = unknown,\n>(\n  schema: T,\n  handler: (ctx: HandlerContextWithExtra<T, TExtra>) => R | Promise<R>,\n): (req: Request) => Promise<Response>;\n\n// å®ç°\nexport function createHandlerWithExtra<\n  TExtra extends Record<string, unknown> = Record<string, never>,\n  const T extends RouteSchema = RouteSchema,\n  R = unknown,\n>(\n  schemaOrHandler: T | ((ctx: EmptySchemaContext & TExtra) => R | Promise<R>),\n  maybeHandler?: (ctx: HandlerContextWithExtra<T, TExtra>) => R | Promise<R>,\n): (req: Request) => Promise<Response> {\n  // åˆ¤æ–­è°ƒç”¨æ–¹å¼\n  const hasSchema = !isHandler(schemaOrHandler);\n  const schema = hasSchema ? (schemaOrHandler as T) : ({} as T);\n  const handler = hasSchema\n    ? maybeHandler!\n    : (schemaOrHandler as (\n        ctx: HandlerContextWithExtra<T, TExtra>,\n      ) => R | Promise<R>);\n\n  // é¢„ç¼–è¯‘ schema\n  if (\n    schema.body ||\n    schema.query ||\n    schema.params ||\n    schema.headers ||\n    schema.cookies\n  ) {\n    precompileSchemas(schema);\n  }\n\n  return async (req: Request): Promise<Response> => {\n    try {\n      // è§£æè¯·æ±‚æ•°æ®\n      const query = parseQuery(req);\n      const headers = parseHeaders(req);\n      const cookies = parseCookies(req);\n      const params =\n        ((req as unknown as Record<string, unknown>).params as Record<\n          string,\n          string\n        >) || {};\n\n      // è§£æè¯·æ±‚ä½“\n      let body: unknown = undefined;\n      if (req.method !== \"GET\" && req.method !== \"HEAD\") {\n        const [, parsedBody] = await goAwait(parseBody(req));\n        body = parsedBody;\n      }\n\n      // éªŒè¯ schema\n      const data = { body, query, params, headers, cookies };\n      if (\n        schema.body ||\n        schema.query ||\n        schema.params ||\n        schema.headers ||\n        schema.cookies\n      ) {\n        validateAllSchemas(schema, data);\n      }\n\n      // è·å–ä¸­é—´ä»¶æ³¨å…¥çš„é¢å¤–æ•°æ®\n      const extras = ((req as unknown as Record<string, unknown>).__locals ??\n        {}) as TExtra;\n\n      // è°ƒç”¨ handler\n      const result = await handler({\n        req,\n        body: body as HandlerContext<T>[\"body\"],\n        query: query as HandlerContext<T>[\"query\"],\n        params: params as HandlerContext<T>[\"params\"],\n        headers: headers as HandlerContext<T>[\"headers\"],\n        cookies: cookies as HandlerContext<T>[\"cookies\"],\n        ...extras,\n      } as HandlerContextWithExtra<T, TExtra>);\n\n      return autoResponse(result);\n    } catch (error) {\n      if (error instanceof Error && error.message.includes(\"éªŒè¯å¤±è´¥\")) {\n        return handleValidationError(error);\n      }\n      return handleInternalError(error);\n    }\n  };\n}\n\n/**\n * ç®€å•çš„è·¯ç”±å¤„ç†å™¨ (æ—  schema éªŒè¯ï¼Œåªæœ‰ req)\n *\n * @example\n * ```typescript\n * simpleHandler(({ req }) => {\n *   return { message: \"Hello World\" };\n * })\n * ```\n */\nexport function simpleHandler<R>(\n  handler: (ctx: { req: Request }) => R | Promise<R>,\n): (req: Request) => Promise<Response> {\n  return async (req: Request): Promise<Response> => {\n    try {\n      const result = await handler({ req });\n      return autoResponse(result);\n    } catch (error) {\n      return handleInternalError(error);\n    }\n  };\n}\n","export function base64urlEncode(str: string): string {\n  return btoa(str)\n    .replace(/=/g, \"\") // âœ… åˆ é™¤å¡«å……\n    .replace(/\\+/g, \"-\")\n    .replace(/\\//g, \"_\");\n}\n\nexport function base64urlDecode(str: string): string {\n  const pad = str.length % 4 === 0 ? \"\" : \"=\".repeat(4 - (str.length % 4));\n  const base64 = str.replace(/-/g, \"+\").replace(/_/g, \"/\") + pad;\n  return atob(base64);\n}\n","import { parseCookies } from \"./parsers\";\n\n/** è·å–å•ä¸ª Cookie å€¼ */\nexport function getCookie(req: Request, key: string): string | null {\n  const cookies = parseCookies(req);\n  return cookies[key] || null;\n}\n\n/** ç”Ÿæˆ Set-Cookie å¤´ */\nexport function setCookie(\n  key: string,\n  value: string,\n  options: {\n    path?: string;\n    httpOnly?: boolean;\n    maxAge?: number;\n    secure?: boolean;\n  } = {},\n): string {\n  let cookie = `${key}=${encodeURIComponent(value)}`;\n\n  if (options.path) cookie += `; Path=${options.path}`;\n  if (options.httpOnly) cookie += `; HttpOnly`;\n  if (options.secure) cookie += `; Secure`;\n  if (options.maxAge) cookie += `; Max-Age=${options.maxAge}`;\n\n  return cookie;\n}\n\n// æä¾›ç»™ä¸­é—´ä»¶å†™å…¥\"å±€éƒ¨ä¸Šä¸‹æ–‡\"çš„å·¥å…·å‡½æ•°\nexport function setLocals<T extends object>(req: Request, extras: T) {\n  const target = req as unknown as Record<string, unknown>;\n  target.__locals = { ...((target.__locals as object) ?? {}), ...extras };\n}\n\n// è·å–ä¸­é—´ä»¶æ³¨å…¥çš„å±€éƒ¨ä¸Šä¸‹æ–‡\nexport function getLocals<T extends object>(req: Request): T {\n  const target = req as unknown as Record<string, unknown>;\n  return (target.__locals ?? {}) as T;\n}\n","/**\n * è¯·æ±‚è§£æå’ŒéªŒè¯å™¨\n *\n * è§£æhandlerçš„reqå‚æ•°ï¼Œä½¿ç”¨UltraéªŒè¯å™¨è¿›è¡ŒéªŒè¯ï¼Œ\n * å¹¶ç±»å‹å®‰å…¨åœ°è¿”å›è§£æå‡ºæ¥çš„å€¼\n *\n * @author Framework Team\n * @version 1.0.0\n * @license MIT\n */\n\nimport type { TSchema } from \"@sinclair/typebox\";\nimport type { Static } from \"@sinclair/typebox\";\nimport {\n  validateAllSchemas,\n  type SchemaConfig,\n} from \"./validators/validators\";\nimport { parseBody, parseQuery, parseHeaders, parseCookies } from \"./parsers\";\n\n// è¯·æ±‚æ•°æ®ç»“æ„\nexport interface RequestData {\n  body: unknown;\n  query: unknown;\n  params: Record<string, string>;\n  headers: Record<string, string>;\n  cookies: Record<string, string>;\n}\n\n// éªŒè¯åçš„è¯·æ±‚æ•°æ®ç±»å‹\nexport interface ValidatedRequestData<T extends SchemaConfig> {\n  body: T[\"body\"] extends TSchema ? Static<T[\"body\"]> : unknown;\n  query: T[\"query\"] extends TSchema ? Static<T[\"query\"]> : unknown;\n  params: T[\"params\"] extends TSchema\n    ? Static<T[\"params\"]>\n    : Record<string, string>;\n  headers: T[\"headers\"] extends TSchema\n    ? Static<T[\"headers\"]>\n    : Record<string, string>;\n  cookies: T[\"cookies\"] extends TSchema\n    ? Static<T[\"cookies\"]>\n    : Record<string, string>;\n}\n\n// éªŒè¯ç»“æœ\nexport interface ValidationResult<T extends SchemaConfig> {\n  success: boolean;\n  data?: ValidatedRequestData<T>;\n  errors?: Array<{ field: keyof SchemaConfig; message: string }>;\n}\n\n/**\n * è§£æRequestå¯¹è±¡ï¼Œæå–æ‰€æœ‰ç›¸å…³æ•°æ®\n * @param request Requestå¯¹è±¡\n * @param params è·¯å¾„å‚æ•°ï¼ˆå¯é€‰ï¼‰\n * @returns è§£æåçš„è¯·æ±‚æ•°æ®\n */\nexport async function parseRequest(\n  request: Request,\n  params?: Record<string, string>,\n): Promise<RequestData> {\n  const requestData: RequestData = {\n    body: undefined,\n    query: parseQuery(request),\n    params: params || {},\n    headers: parseHeaders(request),\n    cookies: parseCookies(request),\n  };\n\n  // å¯¹äºéGETè¯·æ±‚ï¼Œå°è¯•è§£æè¯·æ±‚ä½“\n  if (request.method !== \"GET\" && request.method !== \"HEAD\") {\n    requestData.body = await parseBody(request);\n  }\n\n  return requestData;\n}\n\n/**\n * éªŒè¯è¯·æ±‚æ•°æ®\n * @param config Schemaé…ç½®\n * @param requestData è¯·æ±‚æ•°æ®\n * @returns éªŒè¯ç»“æœ\n */\nexport function validateRequest<T extends SchemaConfig>(\n  config: T,\n  requestData: RequestData,\n): ValidationResult<T> {\n  try {\n    const validatedData = validateAllSchemas(config, requestData);\n\n    return {\n      success: true,\n      data: validatedData as ValidatedRequestData<T>,\n    };\n  } catch (error) {\n    return {\n      success: false,\n      errors: [\n        {\n          field: \"unknown\" as keyof SchemaConfig,\n          message: error instanceof Error ? error.message : \"éªŒè¯å¤±è´¥\",\n        },\n      ],\n    };\n  }\n}\n\n/**\n * å®Œæ•´çš„è¯·æ±‚è§£æå’ŒéªŒè¯æµç¨‹\n * @param request Requestå¯¹è±¡\n * @param config Schemaé…ç½®\n * @param params è·¯å¾„å‚æ•°ï¼ˆå¯é€‰ï¼‰\n * @returns éªŒè¯ç»“æœ\n */\nexport async function parseAndValidateRequest<T extends SchemaConfig>(\n  request: Request,\n  config: T,\n  params?: Record<string, string>,\n): Promise<ValidationResult<T>> {\n  try {\n    // 1. è§£æè¯·æ±‚\n    const requestData = await parseRequest(request, params);\n\n    // 2. éªŒè¯æ•°æ®\n    return validateRequest(config, requestData);\n  } catch (error) {\n    return {\n      success: false,\n      errors: [\n        {\n          field: \"unknown\" as keyof SchemaConfig,\n          message: error instanceof Error ? error.message : \"è¯·æ±‚è§£æå¤±è´¥\",\n        },\n      ],\n    };\n  }\n}\n\n/**\n * åˆ›å»ºç±»å‹å®‰å…¨çš„è¯·æ±‚éªŒè¯å™¨å·¥å‚\n * @param config Schemaé…ç½®\n * @returns éªŒè¯å™¨å‡½æ•°\n */\nexport function createRequestValidator<T extends SchemaConfig>(config: T) {\n  return async (request: Request, params?: Record<string, string>) => {\n    return parseAndValidateRequest(request, config, params);\n  };\n}\n","/**\n * TypeBox Format éªŒè¯å™¨\n *\n * å†…ç½®å¸¸ç”¨çš„ format éªŒè¯ï¼Œå¯¹æ ‡ Zod çš„å†…ç½®éªŒè¯\n * æ¡†æ¶å¯åŠ¨æ—¶è‡ªåŠ¨æ³¨å†Œ\n *\n * @version 1.0.0\n */\n\nimport { FormatRegistry } from \"@sinclair/typebox\";\n\n// ============== æ­£åˆ™è¡¨è¾¾å¼ ==============\n\n// é‚®ç®± (RFC 5322 ç®€åŒ–ç‰ˆ)\nconst EMAIL_REGEX = /^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/;\n\n// UUID v4\nconst UUID_REGEX = /^[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;\n\n// UUID ä»»æ„ç‰ˆæœ¬\nconst UUID_ANY_REGEX = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;\n\n// CUID\nconst CUID_REGEX = /^c[^\\s-]{8,}$/i;\n\n// CUID2\nconst CUID2_REGEX = /^[0-9a-z]+$/;\n\n// ULID\nconst ULID_REGEX = /^[0-9A-HJKMNP-TV-Z]{26}$/i;\n\n// NanoID (é»˜è®¤ 21 å­—ç¬¦)\nconst NANOID_REGEX = /^[A-Za-z0-9_-]{21}$/;\n\n// URL\nconst URL_REGEX = /^https?:\\/\\/(?:www\\.)?[-a-zA-Z0-9@:%._+~#=]{1,256}\\.[a-zA-Z0-9()]{1,6}\\b[-a-zA-Z0-9()@:%_+.~#?&/=]*$/;\n\n// IPv4\nconst IPV4_REGEX = /^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/;\n\n// IPv6 (ç®€åŒ–ç‰ˆ)\nconst IPV6_REGEX = /^(?:[0-9a-fA-F]{1,4}:){7}[0-9a-fA-F]{1,4}$|^::(?:[0-9a-fA-F]{1,4}:){0,6}[0-9a-fA-F]{1,4}$|^(?:[0-9a-fA-F]{1,4}:){1,7}:$|^(?:[0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}$|^(?:[0-9a-fA-F]{1,4}:){1,5}(?::[0-9a-fA-F]{1,4}){1,2}$|^(?:[0-9a-fA-F]{1,4}:){1,4}(?::[0-9a-fA-F]{1,4}){1,3}$|^(?:[0-9a-fA-F]{1,4}:){1,3}(?::[0-9a-fA-F]{1,4}){1,4}$|^(?:[0-9a-fA-F]{1,4}:){1,2}(?::[0-9a-fA-F]{1,4}){1,5}$|^[0-9a-fA-F]{1,4}:(?::[0-9a-fA-F]{1,4}){1,6}$/;\n\n// CIDR (IPv4)\nconst CIDR_REGEX = /^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\/(?:3[0-2]|[12]?[0-9])$/;\n\n// æ—¥æœŸ (YYYY-MM-DD)\nconst DATE_REGEX = /^\\d{4}-(?:0[1-9]|1[0-2])-(?:0[1-9]|[12][0-9]|3[01])$/;\n\n// æ—¶é—´ (HH:mm:ss æˆ– HH:mm:ss.SSS)\nconst TIME_REGEX = /^(?:[01][0-9]|2[0-3]):[0-5][0-9]:[0-5][0-9](?:\\.\\d{1,3})?$/;\n\n// ISO æ—¥æœŸæ—¶é—´\nconst DATE_TIME_REGEX = /^\\d{4}-(?:0[1-9]|1[0-2])-(?:0[1-9]|[12][0-9]|3[01])T(?:[01][0-9]|2[0-3]):[0-5][0-9]:[0-5][0-9](?:\\.\\d{1,3})?(?:Z|[+-](?:[01][0-9]|2[0-3]):[0-5][0-9])?$/;\n\n// ISO 8601 Duration (P1Y2M3DT4H5M6S)\nconst DURATION_REGEX = /^P(?:\\d+Y)?(?:\\d+M)?(?:\\d+W)?(?:\\d+D)?(?:T(?:\\d+H)?(?:\\d+M)?(?:\\d+(?:\\.\\d+)?S)?)?$/;\n\n// Hostname (RFC 1123)\nconst HOSTNAME_REGEX = /^(?=.{1,253}$)(?:(?!-)[a-zA-Z0-9-]{1,63}(?<!-)\\.)*(?!-)[a-zA-Z0-9-]{1,63}(?<!-)$/;\n\n// æ‰‹æœºå· (ä¸­å›½å¤§é™†)\nconst PHONE_CN_REGEX = /^1[3-9]\\d{9}$/;\n\n// æ‰‹æœºå· (å›½é™…æ ¼å¼ E.164)\nconst PHONE_E164_REGEX = /^\\+[1-9]\\d{6,14}$/;\n\n// MongoDB ObjectId\nconst OBJECTID_REGEX = /^[0-9a-fA-F]{24}$/;\n\n// åå…­è¿›åˆ¶é¢œè‰²\nconst HEX_COLOR_REGEX = /^#(?:[0-9a-fA-F]{3}){1,2}$/;\n\n// RGB/RGBA é¢œè‰²\nconst RGB_COLOR_REGEX = /^rgba?\\(\\s*(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\s*,\\s*(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\s*,\\s*(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)(?:\\s*,\\s*(?:0|1|0?\\.\\d+))?\\s*\\)$/;\n\n// Base64\nconst BASE64_REGEX = /^(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=)?$/;\n\n// Base64 URL Safe\nconst BASE64URL_REGEX = /^[A-Za-z0-9_-]+$/;\n\n// JWT (3 éƒ¨åˆ† base64url)\nconst JWT_REGEX = /^[A-Za-z0-9_-]+\\.[A-Za-z0-9_-]+\\.[A-Za-z0-9_-]+$/;\n\n// Emoji (ç®€åŒ–æ£€æµ‹)\nconst EMOJI_REGEX = /^[\\p{Emoji}]+$/u;\n\n// Slug (URL å‹å¥½å­—ç¬¦ä¸²)\nconst SLUG_REGEX = /^[a-z0-9]+(?:-[a-z0-9]+)*$/;\n\n// Semver (è¯­ä¹‰åŒ–ç‰ˆæœ¬)\nconst SEMVER_REGEX = /^(0|[1-9]\\d*)\\.(0|[1-9]\\d*)\\.(0|[1-9]\\d*)(?:-((?:0|[1-9]\\d*|\\d*[a-zA-Z-][0-9a-zA-Z-]*)(?:\\.(?:0|[1-9]\\d*|\\d*[a-zA-Z-][0-9a-zA-Z-]*))*))?(?:\\+([0-9a-zA-Z-]+(?:\\.[0-9a-zA-Z-]+)*))?$/;\n\n// ä¿¡ç”¨å¡å· (Luhn ç®—æ³•éªŒè¯)\nfunction isValidCreditCard(value: string): boolean {\n  const digits = value.replace(/\\D/g, \"\");\n  if (digits.length < 13 || digits.length > 19) return false;\n\n  let sum = 0;\n  let isEven = false;\n  for (let i = digits.length - 1; i >= 0; i--) {\n    let digit = parseInt(digits[i], 10);\n    if (isEven) {\n      digit *= 2;\n      if (digit > 9) digit -= 9;\n    }\n    sum += digit;\n    isEven = !isEven;\n  }\n  return sum % 10 === 0;\n}\n\n// ============== Format æ³¨å†Œ ==============\n\nlet isRegistered = false;\n\n/**\n * æ³¨å†Œæ‰€æœ‰å†…ç½® format éªŒè¯å™¨\n * æ¡†æ¶è‡ªåŠ¨è°ƒç”¨ï¼Œä¹Ÿå¯æ‰‹åŠ¨è°ƒç”¨\n */\nexport function registerFormats(): void {\n  if (isRegistered) return;\n  isRegistered = true;\n\n  // === å­—ç¬¦ä¸²æ ‡è¯†ç¬¦ ===\n  FormatRegistry.Set(\"email\", (v) => EMAIL_REGEX.test(v));\n  FormatRegistry.Set(\"uuid\", (v) => UUID_REGEX.test(v));\n  FormatRegistry.Set(\"uuid-any\", (v) => UUID_ANY_REGEX.test(v));\n  FormatRegistry.Set(\"cuid\", (v) => CUID_REGEX.test(v));\n  FormatRegistry.Set(\"cuid2\", (v) => CUID2_REGEX.test(v) && v.length >= 1);\n  FormatRegistry.Set(\"ulid\", (v) => ULID_REGEX.test(v));\n  FormatRegistry.Set(\"nanoid\", (v) => NANOID_REGEX.test(v));\n  FormatRegistry.Set(\"objectid\", (v) => OBJECTID_REGEX.test(v));\n  FormatRegistry.Set(\"slug\", (v) => SLUG_REGEX.test(v));\n\n  // === ç½‘ç»œç›¸å…³ ===\n  FormatRegistry.Set(\"url\", (v) => URL_REGEX.test(v));\n  FormatRegistry.Set(\"uri\", (v) => URL_REGEX.test(v)); // åˆ«å\n  FormatRegistry.Set(\"ipv4\", (v) => IPV4_REGEX.test(v));\n  FormatRegistry.Set(\"ipv6\", (v) => IPV6_REGEX.test(v));\n  FormatRegistry.Set(\"ip\", (v) => IPV4_REGEX.test(v) || IPV6_REGEX.test(v));\n  FormatRegistry.Set(\"cidr\", (v) => CIDR_REGEX.test(v));\n  FormatRegistry.Set(\"hostname\", (v) => HOSTNAME_REGEX.test(v));\n\n  // === æ—¥æœŸæ—¶é—´ ===\n  FormatRegistry.Set(\"date\", (v) => DATE_REGEX.test(v));\n  FormatRegistry.Set(\"time\", (v) => TIME_REGEX.test(v));\n  FormatRegistry.Set(\"date-time\", (v) => DATE_TIME_REGEX.test(v));\n  FormatRegistry.Set(\"datetime\", (v) => DATE_TIME_REGEX.test(v)); // åˆ«å\n  FormatRegistry.Set(\"duration\", (v) => DURATION_REGEX.test(v));\n\n  // === æ‰‹æœºå· ===\n  FormatRegistry.Set(\"phone\", (v) => PHONE_CN_REGEX.test(v)); // ä¸­å›½å¤§é™†\n  FormatRegistry.Set(\"phone-cn\", (v) => PHONE_CN_REGEX.test(v));\n  FormatRegistry.Set(\"phone-e164\", (v) => PHONE_E164_REGEX.test(v)); // å›½é™…\n\n  // === ç¼–ç æ ¼å¼ ===\n  FormatRegistry.Set(\"base64\", (v) => BASE64_REGEX.test(v));\n  FormatRegistry.Set(\"base64url\", (v) => BASE64URL_REGEX.test(v));\n  FormatRegistry.Set(\"jwt\", (v) => JWT_REGEX.test(v));\n\n  // === é¢œè‰² ===\n  FormatRegistry.Set(\"hex-color\", (v) => HEX_COLOR_REGEX.test(v));\n  FormatRegistry.Set(\"rgb-color\", (v) => RGB_COLOR_REGEX.test(v));\n  FormatRegistry.Set(\n    \"color\",\n    (v) => HEX_COLOR_REGEX.test(v) || RGB_COLOR_REGEX.test(v),\n  );\n\n  // === å…¶ä»– ===\n  FormatRegistry.Set(\"emoji\", (v) => EMOJI_REGEX.test(v));\n  FormatRegistry.Set(\"semver\", (v) => SEMVER_REGEX.test(v));\n  FormatRegistry.Set(\"credit-card\", isValidCreditCard);\n}\n\n/**\n * è‡ªå®šä¹‰æ³¨å†Œ format\n */\nexport function registerFormat(\n  name: string,\n  validator: (value: string) => boolean,\n): void {\n  FormatRegistry.Set(name, validator);\n}\n\n/**\n * æ£€æŸ¥ format æ˜¯å¦å·²æ³¨å†Œ\n */\nexport function hasFormat(name: string): boolean {\n  return FormatRegistry.Has(name);\n}\n\n// å¯¼å‡ºæ­£åˆ™ï¼ˆä¾›å¤–éƒ¨ä½¿ç”¨ï¼‰\nexport const Patterns = {\n  EMAIL: EMAIL_REGEX,\n  UUID: UUID_REGEX,\n  URL: URL_REGEX,\n  IPV4: IPV4_REGEX,\n  IPV6: IPV6_REGEX,\n  DATE: DATE_REGEX,\n  TIME: TIME_REGEX,\n  DATE_TIME: DATE_TIME_REGEX,\n  PHONE_CN: PHONE_CN_REGEX,\n  PHONE_E164: PHONE_E164_REGEX,\n  OBJECTID: OBJECTID_REGEX,\n  HEX_COLOR: HEX_COLOR_REGEX,\n  SLUG: SLUG_REGEX,\n  SEMVER: SEMVER_REGEX,\n  JWT: JWT_REGEX,\n} as const;\n\n","/**\n * Server-Sent Events (SSE) æ”¯æŒ\n *\n * ç”¨äºå®ç°æµå¼å“åº”ï¼Œå¦‚ AI èŠå¤©ã€å®æ—¶é€šçŸ¥ç­‰\n *\n * @example\n * ```typescript\n * import { createSSEHandler, Type } from 'vafast'\n *\n * const streamHandler = createSSEHandler(\n *   { query: Type.Object({ prompt: Type.String() }) },\n *   async function* ({ query }) {\n *     yield { event: 'start', data: { message: 'Starting...' } }\n *\n *     for await (const chunk of aiStream(query.prompt)) {\n *       yield { data: chunk }\n *     }\n *\n *     yield { event: 'end', data: { message: 'Done!' } }\n *   }\n * )\n * ```\n */\n\nimport type { RouteSchema, HandlerContext } from \"../types/schema\";\nimport { parseQuery, parseHeaders, parseCookies } from \"./parsers\";\nimport { precompileSchemas, validateAllSchemas } from \"./validators/validators\";\n\n/**\n * SSE äº‹ä»¶ç±»å‹\n */\nexport interface SSEEvent<T = unknown> {\n  /** äº‹ä»¶åç§°ï¼ˆå¯é€‰ï¼Œé»˜è®¤ä¸º messageï¼‰ */\n  event?: string;\n  /** äº‹ä»¶æ•°æ® */\n  data: T;\n  /** äº‹ä»¶ IDï¼ˆå¯é€‰ï¼‰ */\n  id?: string;\n  /** é‡è¯•é—´éš”ï¼ˆæ¯«ç§’ï¼Œå¯é€‰ï¼‰ */\n  retry?: number;\n}\n\n/**\n * SSE ç”Ÿæˆå™¨å‡½æ•°ç±»å‹\n */\nexport type SSEGenerator<T extends RouteSchema = RouteSchema> = (\n  ctx: HandlerContext<T>\n) => AsyncGenerator<SSEEvent<unknown>, void, unknown>;\n\n/**\n * æ ¼å¼åŒ– SSE äº‹ä»¶ä¸ºå­—ç¬¦ä¸²\n */\nfunction formatSSEEvent(event: SSEEvent): string {\n  const lines: string[] = [];\n\n  if (event.id !== undefined) {\n    lines.push(`id: ${event.id}`);\n  }\n\n  if (event.event !== undefined) {\n    lines.push(`event: ${event.event}`);\n  }\n\n  if (event.retry !== undefined) {\n    lines.push(`retry: ${event.retry}`);\n  }\n\n  // æ•°æ®å¯èƒ½æ˜¯å¤šè¡Œçš„ï¼Œéœ€è¦åˆ†è¡Œå¤„ç†\n  const dataStr = typeof event.data === 'string'\n    ? event.data\n    : JSON.stringify(event.data);\n\n  const dataLines = dataStr.split('\\n');\n  for (const line of dataLines) {\n    lines.push(`data: ${line}`);\n  }\n\n  return lines.join('\\n') + '\\n\\n';\n}\n\n/**\n * SSE æ ‡è®°ç±»å‹ - ä½¿ç”¨å­—é¢é‡å“ç‰Œç±»å‹\n */\nexport type SSEMarker = { readonly __brand: 'SSE' }\n\n/**\n * SSE Handler ç±»å‹æ ‡è®°\n */\nexport interface SSEHandler<TSchema extends RouteSchema = RouteSchema> {\n  (req: Request): Promise<Response>;\n  /** è¿”å›ç±»å‹æ ‡è®° - SSE æµçš„æ•°æ®ç±»å‹ */\n  readonly __returnType: unknown;\n  /** Schema ç±»å‹æ ‡è®° */\n  readonly __schema: TSchema;\n  /** SSE æ ‡è®° - ä½¿ç”¨å“ç‰Œç±»å‹ç¡®ä¿ä¸è¢«æ‰©å±• */\n  readonly __sse: SSEMarker;\n}\n\n/**\n * åˆ›å»º SSE æµå¼å“åº”å¤„ç†å™¨\n *\n * @example\n * ```typescript\n * // åŸºç¡€ç”¨æ³•\n * const streamChat = createSSEHandler(\n *   { query: Type.Object({ message: Type.String() }) },\n *   async function* ({ query }) {\n *     const response = await ai.chat(query.message);\n *\n *     for await (const chunk of response) {\n *       yield { data: { text: chunk } };\n *     }\n *   }\n * );\n *\n * // ä½¿ç”¨è·¯ç”±\n * route('GET', '/chat/stream', streamChat)\n * ```\n */\nexport function createSSEHandler<const T extends RouteSchema>(\n  schema: T,\n  generator: SSEGenerator<T>\n): SSEHandler<T>;\n\nexport function createSSEHandler(\n  generator: SSEGenerator<RouteSchema>\n): SSEHandler<RouteSchema>;\n\nexport function createSSEHandler<const T extends RouteSchema>(\n  schemaOrGenerator: T | SSEGenerator<T>,\n  maybeGenerator?: SSEGenerator<T>\n): SSEHandler<T> {\n  // åˆ¤æ–­è°ƒç”¨æ–¹å¼\n  const hasSchema = typeof schemaOrGenerator !== 'function';\n  const schema = hasSchema ? (schemaOrGenerator as T) : ({} as T);\n  const generator = hasSchema\n    ? maybeGenerator!\n    : (schemaOrGenerator as SSEGenerator<T>);\n\n  // é¢„ç¼–è¯‘ schema\n  if (schema.body || schema.query || schema.params || schema.headers || schema.cookies) {\n    precompileSchemas(schema);\n  }\n\n  const handlerFn = async (req: Request): Promise<Response> => {\n    try {\n      // è§£æè¯·æ±‚æ•°æ®\n      const query = parseQuery(req);\n      const headers = parseHeaders(req);\n      const cookies = parseCookies(req);\n      const params = ((req as unknown as Record<string, unknown>).params as Record<string, string>) || {};\n\n      // éªŒè¯ schema\n      const data = { body: undefined, query, params, headers, cookies };\n      if (schema.body || schema.query || schema.params || schema.headers || schema.cookies) {\n        validateAllSchemas(schema, data);\n      }\n\n      // åˆ›å»º SSE æµ\n      const stream = new ReadableStream({\n        async start(controller) {\n          const encoder = new TextEncoder();\n\n          try {\n            const gen = generator({\n              req,\n              body: undefined as HandlerContext<T>['body'],\n              query: query as HandlerContext<T>['query'],\n              params: params as HandlerContext<T>['params'],\n              headers: headers as HandlerContext<T>['headers'],\n              cookies: cookies as HandlerContext<T>['cookies'],\n            });\n\n            for await (const event of gen) {\n              const formatted = formatSSEEvent(event);\n              controller.enqueue(encoder.encode(formatted));\n            }\n          } catch (error) {\n            // å‘é€é”™è¯¯äº‹ä»¶\n            const errorEvent = formatSSEEvent({\n              event: 'error',\n              data: {\n                message: error instanceof Error ? error.message : 'Unknown error'\n              }\n            });\n            controller.enqueue(encoder.encode(errorEvent));\n          } finally {\n            controller.close();\n          }\n        }\n      });\n\n      return new Response(stream, {\n        headers: {\n          'Content-Type': 'text/event-stream',\n          'Cache-Control': 'no-cache',\n          'Connection': 'keep-alive',\n          'X-Accel-Buffering': 'no', // Nginx ç¦ç”¨ç¼“å†²\n        }\n      });\n    } catch (error) {\n      // éªŒè¯é”™è¯¯ç­‰\n      return new Response(\n        JSON.stringify({\n          success: false,\n          error: 'Validation Error',\n          message: error instanceof Error ? error.message : 'Unknown error'\n        }),\n        {\n          status: 400,\n          headers: { 'Content-Type': 'application/json' }\n        }\n      );\n    }\n  };\n\n  // æ·»åŠ ç±»å‹æ ‡è®°\n  const handler = handlerFn as SSEHandler<T>;\n  (handler as unknown as { __sse: SSEMarker }).__sse = { __brand: 'SSE' } as const;\n  (handler as unknown as { __schema: T }).__schema = schema;\n  (handler as unknown as { __returnType: unknown }).__returnType = undefined;\n  return handler;\n}\n\n\n","// src/middleware/authMiddleware.ts\nimport type { Middleware } from \"../types\";\nimport { VafastError } from \"../middleware\";\nimport { getCookie } from \"../utils/handle\";\n\nexport const requireAuth: Middleware = async (req, next) => {\n  const token = getCookie(req, \"auth\");\n\n  if (!token || token !== \"valid-token\") {\n    throw new VafastError(\"Unauthorized\", {\n      status: 401,\n      type: \"unauthorized\",\n      expose: true,\n    });\n  }\n\n  return next();\n};\n","// src/middleware/rateLimit.ts\n\nimport type { Middleware } from \"../types\";\nimport { VafastError } from \"../middleware\";\n\ninterface RateLimitOptions {\n  windowMs?: number; // é™åˆ¶çª—å£ï¼ˆæ¯«ç§’ï¼‰\n  max?: number; // æœ€å¤§è¯·æ±‚æ•°\n  keyFn?: (req: Request) => string;\n}\n\ntype Entry = {\n  count: number;\n  expires: number;\n};\n\nconst store = new Map<string, Entry>();\n\nexport function rateLimit(options: RateLimitOptions = {}): Middleware {\n  const windowMs = options.windowMs ?? 60_000; // é»˜è®¤: 1åˆ†é’Ÿ\n  const max = options.max ?? 30;\n  const keyFn = options.keyFn ?? getIP;\n\n  return async (req, next) => {\n    const key = keyFn(req);\n    const now = Date.now();\n\n    const entry = store.get(key);\n    if (entry && entry.expires > now) {\n      if (entry.count >= max) {\n        throw new VafastError(\"Too many requests\", {\n          status: 429,\n          type: \"rate_limit\",\n          expose: true,\n        });\n      }\n      entry.count += 1;\n    } else {\n      store.set(key, { count: 1, expires: now + windowMs });\n    }\n\n    return next();\n  };\n}\n\n// Edge å®‰å…¨çš„ IP è·å–\nfunction getIP(req: Request): string {\n  return (\n    req.headers.get(\"cf-connecting-ip\") || // Cloudflare\n    req.headers.get(\"x-forwarded-for\")?.split(\",\")[0]?.trim() || // Vercel\n    \"unknown\"\n  );\n}\n","import type { Middleware } from \"../types\";\n\nexport interface CORSOptions {\n  origin?: string[] | \"*\";\n  methods?: string[];\n  headers?: string[];\n  credentials?: boolean;\n  maxAge?: number;\n}\n\nexport function createCORS(options: CORSOptions = {}): Middleware {\n  const {\n    origin = [],\n    methods = [\"GET\", \"POST\", \"PUT\", \"DELETE\", \"OPTIONS\"],\n    headers = [],\n    credentials = false,\n    maxAge,\n  } = options;\n\n  return async (req, next) => {\n    const reqOrigin = req.headers.get(\"Origin\") || \"\";\n\n    // åˆ¤æ–­ï¼šæ˜¯å¦ä¸ºå…è®¸çš„ Originï¼Ÿ\n    const isAllowedOrigin = origin === \"*\" || origin.includes(reqOrigin);\n\n    // é¢„æ£€ (OPTIONS) è¯·æ±‚å¤„ç†\n    if (req.method === \"OPTIONS\") {\n      const resHeaders = new Headers();\n\n      if (isAllowedOrigin) {\n        resHeaders.set(\n          \"Access-Control-Allow-Origin\",\n          origin === \"*\" ? \"*\" : reqOrigin,\n        );\n        resHeaders.set(\"Access-Control-Allow-Methods\", methods.join(\",\"));\n        resHeaders.set(\"Access-Control-Allow-Headers\", headers.join(\",\"));\n        if (credentials)\n          resHeaders.set(\"Access-Control-Allow-Credentials\", \"true\");\n        if (maxAge) resHeaders.set(\"Access-Control-Max-Age\", maxAge.toString());\n      }\n\n      return new Response(null, { status: 204, headers: resHeaders });\n    }\n\n    // æ­£å¸¸è¯·æ±‚ï¼šåœ¨ next åæ·»åŠ å¤´éƒ¨\n    const res = await next();\n\n    if (isAllowedOrigin) {\n      res.headers.set(\n        \"Access-Control-Allow-Origin\",\n        origin === \"*\" ? \"*\" : reqOrigin,\n      );\n      if (credentials)\n        res.headers.set(\"Access-Control-Allow-Credentials\", \"true\");\n    }\n\n    return res;\n  };\n}\n","// src/auth/token.ts\nimport { base64urlEncode, base64urlDecode } from \"../utils/base64url\";\n\n// ç±»å‹å®šä¹‰\nexport interface TokenPayload {\n  [key: string]: any;\n  exp?: number; // è¿‡æœŸæ—¶é—´æˆ³\n  iat?: number; // ç­¾å‘æ—¶é—´æˆ³\n  sub?: string; // ä¸»é¢˜ï¼ˆé€šå¸¸æ˜¯ç”¨æˆ·IDï¼‰\n  aud?: string; // å—ä¼—\n  iss?: string; // ç­¾å‘è€…\n}\n\nexport interface TokenResult {\n  payload: TokenPayload;\n  token: string;\n  expiresAt: number;\n}\n\nexport interface TokenOptions {\n  expiresIn?: number; // è¿‡æœŸæ—¶é—´ï¼ˆç§’ï¼‰\n  issuer?: string; // ç­¾å‘è€…\n  audience?: string; // å—ä¼—\n  subject?: string; // ä¸»é¢˜\n}\n\nexport class TokenError extends Error {\n  constructor(\n    message: string,\n    public code:\n      | \"INVALID_TOKEN\"\n      | \"EXPIRED_TOKEN\"\n      | \"INVALID_SIGNATURE\"\n      | \"MALFORMED_TOKEN\"\n      | \"INVALID_PAYLOAD\",\n  ) {\n    super(message);\n    this.name = \"TokenError\";\n  }\n}\n\nconst encoder = new TextEncoder();\n\n/** ä½¿ç”¨ HMAC-SHA256 è¿›è¡Œç­¾å */\nasync function sign(data: string, secret: string): Promise<string> {\n  const key = await crypto.subtle.importKey(\n    \"raw\",\n    encoder.encode(secret),\n    { name: \"HMAC\", hash: \"SHA-256\" },\n    false,\n    [\"sign\"],\n  );\n\n  const signature = await crypto.subtle.sign(\"HMAC\", key, encoder.encode(data));\n  return btoa(\n    String.fromCharCode.apply(null, Array.from(new Uint8Array(signature))),\n  );\n}\n\n/** ç”Ÿæˆä»¤ç‰Œ */\nexport async function generateToken(\n  payload: TokenPayload,\n  secret: string,\n  options: TokenOptions = {},\n): Promise<TokenResult> {\n  const { expiresIn = 3600, issuer, audience, subject } = options;\n\n  // åˆ›å»ºä»¤ç‰Œè½½è·ï¼Œå¼ºåˆ¶ä½¿ç”¨å½“å‰æ—¶é—´\n  const now = Math.floor(Date.now() / 1000);\n  const tokenPayload: TokenPayload = {\n    ...payload,\n    iat: now,\n    exp: now + expiresIn,\n  };\n\n  // æ·»åŠ å¯é€‰å­—æ®µ\n  if (issuer) tokenPayload.iss = issuer;\n  if (audience) tokenPayload.aud = audience;\n  if (subject) tokenPayload.sub = subject;\n\n  const data = base64urlEncode(JSON.stringify(tokenPayload));\n  const sig = await sign(data, secret);\n  const token = `${data}.${base64urlEncode(sig)}`;\n\n  return {\n    payload: tokenPayload,\n    token,\n    expiresAt: tokenPayload.exp! * 1000, // è½¬æ¢ä¸ºæ¯«ç§’\n  };\n}\n\n/** éªŒè¯ä»¤ç‰Œ */\nexport async function verifyToken(\n  token: string,\n  secret: string,\n): Promise<TokenPayload | null> {\n  try {\n    const [data, sig] = token.split(\".\");\n    if (!data || !sig) {\n      throw new TokenError(\"ä»¤ç‰Œæ ¼å¼æ— æ•ˆ\", \"MALFORMED_TOKEN\");\n    }\n\n    const expectedSig = await sign(data, secret);\n    const expected = base64urlEncode(expectedSig);\n\n    if (sig !== expected) {\n      throw new TokenError(\"ä»¤ç‰Œç­¾åæ— æ•ˆ\", \"INVALID_SIGNATURE\");\n    }\n\n    const payload = JSON.parse(base64urlDecode(data)) as TokenPayload;\n\n    // æ£€æŸ¥è¿‡æœŸæ—¶é—´\n    if (payload.exp && Date.now() / 1000 > payload.exp) {\n      throw new TokenError(\"ä»¤ç‰Œå·²è¿‡æœŸ\", \"EXPIRED_TOKEN\");\n    }\n\n    return payload;\n  } catch (error) {\n    if (error instanceof TokenError) {\n      throw error;\n    }\n    throw new TokenError(\"ä»¤ç‰ŒéªŒè¯å¤±è´¥\", \"INVALID_TOKEN\");\n  }\n}\n\n/** è§£æä»¤ç‰Œï¼ˆä¸éªŒè¯ç­¾åï¼‰ */\nexport function parseToken(token: string): TokenPayload | null {\n  try {\n    const [data] = token.split(\".\");\n    if (!data) return null;\n\n    return JSON.parse(base64urlDecode(data));\n  } catch {\n    return null;\n  }\n}\n\n/** æ£€æŸ¥ä»¤ç‰Œæ˜¯å¦è¿‡æœŸ */\nexport function isTokenExpired(token: string): boolean {\n  const payload = parseToken(token);\n  if (!payload || !payload.exp) return true;\n\n  return Date.now() / 1000 > payload.exp;\n}\n\n/** è·å–ä»¤ç‰Œå‰©ä½™æœ‰æ•ˆæ—¶é—´ï¼ˆç§’ï¼‰ */\nexport function getTokenTimeRemaining(token: string): number {\n  const payload = parseToken(token);\n  if (!payload || !payload.exp) return 0;\n\n  const remaining = payload.exp - Date.now() / 1000;\n  return Math.max(0, Math.floor(remaining));\n}\n\n/** åˆ·æ–°ä»¤ç‰Œ */\nexport async function refreshToken(\n  token: string,\n  secret: string,\n  options: TokenOptions = {},\n): Promise<TokenResult | null> {\n  try {\n    const payload = await verifyToken(token, secret);\n    if (!payload) return null;\n\n    // ç§»é™¤æ—¶é—´ç›¸å…³å­—æ®µï¼Œé‡æ–°ç”Ÿæˆ\n    const { exp, iat, ...cleanPayload } = payload;\n\n    // æ·»åŠ å»¶è¿Ÿç¡®ä¿æ—¶é—´æˆ³ä¸åŒ\n    await new Promise((resolve) => setTimeout(resolve, 10));\n\n    return await generateToken(cleanPayload, secret, options);\n  } catch {\n    return null;\n  }\n}\n\n/** åˆ›å»ºè®¿é—®ä»¤ç‰Œå’Œåˆ·æ–°ä»¤ç‰Œå¯¹ */\nexport async function createTokenPair(\n  payload: TokenPayload,\n  secret: string,\n  options: TokenOptions = {},\n): Promise<{\n  accessToken: TokenResult;\n  refreshToken: TokenResult;\n}> {\n  const accessToken = await generateToken(payload, secret, {\n    ...options,\n    expiresIn: options.expiresIn || 3600, // 1å°æ—¶\n  });\n\n  const refreshToken = await generateToken(payload, secret, {\n    ...options,\n    expiresIn: 7 * 24 * 3600, // 7å¤©\n  });\n\n  return { accessToken, refreshToken };\n}\n","// src/middleware/auth.ts\n\nimport type { Middleware } from \"../types\";\nimport { VafastError } from \"../middleware\";\nimport { getCookie } from \"../utils/handle\";\nimport { verifyToken, TokenError, type TokenPayload } from \"../auth/token\";\n\ninterface AuthOptions {\n  secret: string;\n  cookieName?: string;\n  headerName?: string;\n  required?: boolean; // æ˜¯å¦å¿…éœ€è®¤è¯\n  roles?: string[]; // å…è®¸çš„è§’è‰²\n  permissions?: string[]; // å…è®¸çš„æƒé™\n}\n\nexport function createAuth(options: AuthOptions): Middleware {\n  const {\n    secret,\n    cookieName = \"auth\",\n    headerName = \"authorization\",\n    required = true,\n    roles = [],\n    permissions = [],\n  } = options;\n\n  return async (req, next) => {\n    const token =\n      getCookie(req, cookieName) ||\n      req.headers.get(headerName)?.replace(\"Bearer \", \"\") ||\n      \"\";\n\n    if (!token && required) {\n      throw new VafastError(\"ç¼ºå°‘è®¤è¯ä»¤ç‰Œ\", {\n        status: 401,\n        type: \"unauthorized\",\n        expose: true,\n      });\n    }\n\n    if (!token && !required) {\n      return next();\n    }\n\n    try {\n      const user = (await verifyToken(token, secret)) as TokenPayload;\n\n      if (!user) {\n        throw new VafastError(\"ä»¤ç‰ŒéªŒè¯å¤±è´¥\", {\n          status: 401,\n          type: \"unauthorized\",\n          expose: true,\n        });\n      }\n\n      // æ£€æŸ¥è§’è‰²æƒé™\n      if (roles.length > 0 && user.role && !roles.includes(user.role)) {\n        throw new VafastError(\"æƒé™ä¸è¶³\", {\n          status: 403,\n          type: \"forbidden\",\n          expose: true,\n        });\n      }\n\n      // æ£€æŸ¥å…·ä½“æƒé™\n      if (permissions.length > 0 && user.permissions) {\n        const userPermissions = Array.isArray(user.permissions)\n          ? user.permissions\n          : [user.permissions];\n\n        const hasPermission = permissions.some((permission) =>\n          userPermissions.includes(permission),\n        );\n\n        if (!hasPermission) {\n          throw new VafastError(\"æƒé™ä¸è¶³\", {\n            status: 403,\n            type: \"forbidden\",\n            expose: true,\n          });\n        }\n      }\n\n      // ğŸª„ åœ¨è¿™é‡Œæ‰©å±• Request å¯¹è±¡\n      (req as any).user = user;\n      (req as any).token = token;\n\n      return next();\n    } catch (error) {\n      if (error instanceof TokenError) {\n        let status = 401;\n        let message = \"è®¤è¯å¤±è´¥\";\n\n        switch (error.code) {\n          case \"EXPIRED_TOKEN\":\n            status = 401;\n            message = \"ä»¤ç‰Œå·²è¿‡æœŸ\";\n            break;\n          case \"INVALID_SIGNATURE\":\n            status = 401;\n            message = \"ä»¤ç‰Œç­¾åæ— æ•ˆ\";\n            break;\n          case \"MALFORMED_TOKEN\":\n            status = 400;\n            message = \"ä»¤ç‰Œæ ¼å¼é”™è¯¯\";\n            break;\n          default:\n            status = 401;\n            message = \"ä»¤ç‰ŒéªŒè¯å¤±è´¥\";\n        }\n\n        throw new VafastError(message, {\n          status,\n          type: \"unauthorized\",\n          expose: true,\n        });\n      }\n\n      if (error instanceof VafastError) {\n        throw error;\n      }\n\n      throw new VafastError(\"è®¤è¯è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯\", {\n        status: 500,\n        type: \"internal_error\",\n        expose: false,\n      });\n    }\n  };\n}\n\n// å¯é€‰è®¤è¯ä¸­é—´ä»¶\nexport function createOptionalAuth(\n  options: Omit<AuthOptions, \"required\">,\n): Middleware {\n  return createAuth({ ...options, required: false });\n}\n\n// è§’è‰²éªŒè¯ä¸­é—´ä»¶\nexport function createRoleAuth(\n  roles: string[],\n  options: Omit<AuthOptions, \"roles\">,\n): Middleware {\n  return createAuth({ ...options, roles });\n}\n\n// æƒé™éªŒè¯ä¸­é—´ä»¶\nexport function createPermissionAuth(\n  permissions: string[],\n  options: Omit<AuthOptions, \"permissions\">,\n): Middleware {\n  return createAuth({ ...options, permissions });\n}\n","import type { RouteSchema } from \"./types\";\nimport type { InferableHandler } from \"./utils/create-handler\";\n\n/**\n * å¯æ¨æ–­çš„è·¯ç”±ç±»å‹ï¼ˆç”¨äºç±»å‹æ¨æ–­ï¼‰\n * ä¾› vafast-api-client ä½¿ç”¨ï¼Œä¿ç•™å®Œæ•´çš„ç±»å‹ä¿¡æ¯\n */\nexport type InferableRoute<\n  TMethod extends string = string,\n  TPath extends string = string,\n  TReturn = unknown,\n  TSchema extends RouteSchema = RouteSchema\n> = {\n  readonly method: TMethod;\n  readonly path: TPath;\n  readonly handler: InferableHandler<TReturn, TSchema>;\n  readonly middleware?: ReadonlyArray<(req: Request, next: () => Promise<Response>) => Promise<Response>>;\n}\n\n/**\n * ä¸­é—´ä»¶ç±»å‹\n */\ntype Middleware = (req: Request, next: () => Promise<Response>) => Promise<Response>;\n\n/**\n * è·¯ç”±å®šä¹‰ç±»å‹ï¼ˆä¿ç•™å®Œæ•´ handler ç±»å‹ï¼‰\n */\nexport type RouteDefinition<\n  TMethod extends string = string,\n  TPath extends string = string,\n  THandler = unknown\n> = {\n  readonly method: TMethod;\n  readonly path: TPath;\n  readonly handler: THandler;\n  readonly middleware?: ReadonlyArray<Middleware>;\n}\n\n/**\n * åˆ›å»ºå•ä¸ªè·¯ç”±å®šä¹‰ï¼ˆè‡ªåŠ¨ä¿ç•™å­—é¢é‡ç±»å‹ï¼Œæ— éœ€ as constï¼‰\n * \n * @example\n * ```typescript\n * import { route, defineRoutes, createHandler, Type } from 'vafast'\n * \n * const routes = defineRoutes([\n *   route('GET', '/users', createHandler(\n *     { query: Type.Object({ page: Type.Number() }) },\n *     async ({ query }) => ({ users: [], total: 0 })\n *   )),\n *   route('POST', '/users', createHandler(\n *     { body: Type.Object({ name: Type.String() }) },\n *     async ({ body }) => ({ id: '1', name: body.name })\n *   )),\n *   route('GET', '/users/:id', createHandler(\n *     { params: Type.Object({ id: Type.String() }) },\n *     async ({ params }) => ({ id: params.id, name: 'User' })\n *   ))\n * ])\n * \n * // æ— éœ€ as constï¼ç±»å‹è‡ªåŠ¨æ¨æ–­\n * type Api = InferEden<typeof routes>\n * ```\n */\nexport function route<\n  TMethod extends string,\n  TPath extends string,\n  THandler\n>(\n  method: TMethod,\n  path: TPath,\n  handler: THandler,\n  middleware?: Middleware[]\n): RouteDefinition<TMethod, TPath, THandler> {\n  return {\n    method,\n    path,\n    handler,\n    middleware\n  };\n}\n\n/**\n * GET è·¯ç”±å¿«æ·æ–¹æ³•\n */\nexport function get<TPath extends string, THandler>(\n  path: TPath,\n  handler: THandler,\n  middleware?: Middleware[]\n): RouteDefinition<'GET', TPath, THandler> {\n  return route('GET', path, handler, middleware);\n}\n\n/**\n * POST è·¯ç”±å¿«æ·æ–¹æ³•\n */\nexport function post<TPath extends string, THandler>(\n  path: TPath,\n  handler: THandler,\n  middleware?: Middleware[]\n): RouteDefinition<'POST', TPath, THandler> {\n  return route('POST', path, handler, middleware);\n}\n\n/**\n * PUT è·¯ç”±å¿«æ·æ–¹æ³•\n */\nexport function put<TPath extends string, THandler>(\n  path: TPath,\n  handler: THandler,\n  middleware?: Middleware[]\n): RouteDefinition<'PUT', TPath, THandler> {\n  return route('PUT', path, handler, middleware);\n}\n\n/**\n * DELETE è·¯ç”±å¿«æ·æ–¹æ³•\n */\nexport function del<TPath extends string, THandler>(\n  path: TPath,\n  handler: THandler,\n  middleware?: Middleware[]\n): RouteDefinition<'DELETE', TPath, THandler> {\n  return route('DELETE', path, handler, middleware);\n}\n\n/**\n * PATCH è·¯ç”±å¿«æ·æ–¹æ³•\n */\nexport function patch<TPath extends string, THandler>(\n  path: TPath,\n  handler: THandler,\n  middleware?: Middleware[]\n): RouteDefinition<'PATCH', TPath, THandler> {\n  return route('PATCH', path, handler, middleware);\n}\n\n/**\n * å®šä¹‰è·¯ç”±æ•°ç»„ï¼ˆä¿ç•™å®Œæ•´ç±»å‹ä¿¡æ¯ï¼‰\n * \n * æ¨èé…åˆ route() å‡½æ•°ä½¿ç”¨ï¼Œæ— éœ€ as const\n * \n * @example\n * ```typescript\n * import { defineRoutes, route, createHandler, Type } from 'vafast'\n * \n * // âœ¨ æ–°æ–¹å¼ï¼šä½¿ç”¨ route() å‡½æ•°ï¼Œæ— éœ€ as const\n * const routes = defineRoutes([\n *   route('GET', '/users', createHandler(...)),\n *   route('POST', '/users', createHandler(...))\n * ])\n * \n * // ğŸ”™ æ—§æ–¹å¼ï¼šéœ€è¦ as constï¼ˆä»ç„¶æ”¯æŒï¼‰\n * const routes = defineRoutes([\n *   { method: 'GET', path: '/users', handler: createHandler(...) }\n * ] as const)\n * ```\n */\nexport function defineRoutes<\n  const T extends readonly {\n    readonly method: string\n    readonly path: string\n    readonly handler: unknown\n    readonly middleware?: ReadonlyArray<Middleware>\n  }[]\n>(routes: T): T {\n  return routes;\n}\n","import { Route, ResponseBody } from \"./types\";\n\n// å®šä¹‰ä¸­é—´ä»¶ç±»å‹\nexport interface Middleware {\n  (req: Request, next: () => Promise<Response>): Promise<Response>;\n}\n\n// åŸºç¡€è·¯ç”±é…ç½®\nexport interface BaseRouteConfig {\n  method: \"GET\" | \"POST\" | \"PUT\" | \"DELETE\" | \"PATCH\" | \"OPTIONS\" | \"HEAD\";\n  path: string;\n  handler: (req: Request) => ResponseBody | Promise<ResponseBody>;\n}\n\n// æ‰©å±•çš„è·¯ç”±é…ç½® - åªä¿ç•™SchemaéªŒè¯å’Œä¸­é—´ä»¶\nexport interface ExtendedRouteConfig extends BaseRouteConfig {\n  // Tirne ä¸­é—´ä»¶ç³»ç»Ÿ\n  middleware?: Middleware[];\n\n  // SchemaéªŒè¯é…ç½®\n  body?: any;\n  query?: any;\n  params?: any;\n  headers?: any;\n  cookies?: any;\n\n  // å…¶ä»–é…ç½®\n  docs?: {\n    description?: string;\n    tags?: string[];\n    security?: any[];\n    responses?: Record<string, any>;\n  };\n  timeout?: number;\n  maxBodySize?: string;\n\n  // å…è®¸ä»»æ„æ‰©å±•\n  [key: string]: any;\n}\n\n// åµŒå¥—è·¯ç”±é…ç½®\nexport interface NestedRouteConfig {\n  path: string;\n  middleware?: Middleware[];\n  children?: (NestedRouteConfig | ExtendedRouteConfig)[];\n}\n\n// ç±»å‹å®‰å…¨çš„è·¯ç”±\nexport type TypedRoute = ExtendedRouteConfig;\n\n// å…¼å®¹ç±»å‹ï¼šå¯ä»¥æ¥å—Routeæˆ–TypedRoute\nexport type CompatibleRoute = Route | TypedRoute;\n\n// æ‰å¹³åŒ–åçš„è·¯ç”±ï¼ŒåŒ…å«å®Œæ•´çš„ä¸­é—´ä»¶é“¾\nexport interface FlattenedRoute extends ExtendedRouteConfig {\n  fullPath: string;\n  middlewareChain: Middleware[];\n}\n\n// å¯¼å‡ºä¸€äº›å®é™…çš„å‡½æ•°ï¼Œç¡®ä¿ JavaScript ä»£ç ç”Ÿæˆ\nexport function createTypedRoute(\n  config: ExtendedRouteConfig,\n): ExtendedRouteConfig {\n  return config;\n}\n\nexport function isTypedRoute(route: any): route is TypedRoute {\n  return (\n    route &&\n    typeof route === \"object\" &&\n    \"method\" in route &&\n    \"path\" in route &&\n    \"handler\" in route\n  );\n}\n","/**\n * Node.js æœåŠ¡å™¨é€‚é…å™¨\n * æä¾›ç±»ä¼¼ Bun.serve çš„ API\n */\n\nimport {\n  createServer,\n  type Server as HttpServer,\n  type IncomingMessage,\n  type ServerResponse,\n} from \"node:http\";\nimport { createProxyRequest } from \"./request\";\nimport { writeResponse } from \"./response\";\n\n/** fetch å‡½æ•°ç±»å‹ */\nexport type FetchHandler = (request: Request) => Response | Promise<Response>;\n\n/** ä¼˜é›…å…³é—­é…ç½® */\nexport interface GracefulShutdownOptions {\n  /** å…³é—­è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰ï¼Œé»˜è®¤ 30000 */\n  timeout?: number;\n  /** å…³é—­å‰å›è°ƒ */\n  onShutdown?: () => void | Promise<void>;\n  /** å…³é—­å®Œæˆå›è°ƒ */\n  onShutdownComplete?: () => void;\n  /** ç›‘å¬çš„ä¿¡å·ï¼Œé»˜è®¤ ['SIGINT', 'SIGTERM'] */\n  signals?: NodeJS.Signals[];\n}\n\n/** serve é…ç½®é€‰é¡¹ */\nexport interface ServeOptions {\n  /** fetch å¤„ç†å‡½æ•° */\n  fetch: FetchHandler;\n  /** ç«¯å£å·ï¼Œé»˜è®¤ 3000 */\n  port?: number;\n  /** ä¸»æœºåï¼Œé»˜è®¤ 0.0.0.0 */\n  hostname?: string;\n  /** é”™è¯¯å¤„ç†å‡½æ•° */\n  onError?: (error: Error) => Response | Promise<Response>;\n  /** ä¼˜é›…å…³é—­é…ç½®ï¼Œè®¾ç½®ä¸º true ä½¿ç”¨é»˜è®¤é…ç½® */\n  gracefulShutdown?: boolean | GracefulShutdownOptions;\n}\n\n/** serve è¿”å›çš„æœåŠ¡å™¨ä¿¡æ¯ */\nexport interface ServeResult {\n  /** Node.js HTTP Server å®ä¾‹ */\n  server: HttpServer;\n  /** æœåŠ¡å™¨ç«¯å£ */\n  port: number;\n  /** æœåŠ¡å™¨ä¸»æœºå */\n  hostname: string;\n  /** å…³é—­æœåŠ¡å™¨ */\n  stop: () => Promise<void>;\n  /** ä¼˜é›…å…³é—­ï¼ˆç­‰å¾…ç°æœ‰è¯·æ±‚å®Œæˆï¼‰ */\n  shutdown: () => Promise<void>;\n}\n\n/**\n * åˆ›å»ºè¯·æ±‚å¤„ç†å‡½æ•°\n */\nfunction createRequestHandler(\n  fetch: FetchHandler,\n  defaultHost: string,\n  onError?: (error: Error) => Response | Promise<Response>,\n) {\n  return async (incoming: IncomingMessage, outgoing: ServerResponse) => {\n    try {\n      // åˆ›å»ºä»£ç† Requestï¼ˆå»¶è¿Ÿåˆ›å»ºçœŸå® Requestï¼‰\n      const request = createProxyRequest(incoming, defaultHost);\n\n      // è°ƒç”¨ fetch handler\n      const response = await fetch(request);\n\n      // æµå¼å†™å…¥ Response\n      await writeResponse(response, outgoing);\n    } catch (error) {\n      // é”™è¯¯å¤„ç†\n      const err = error instanceof Error ? error : new Error(String(error));\n\n      if (onError) {\n        try {\n          const errorResponse = await onError(err);\n          await writeResponse(errorResponse, outgoing);\n          return;\n        } catch {\n          // onError ä¹Ÿå¤±è´¥äº†ï¼Œè¿”å› 500\n        }\n      }\n\n      // é»˜è®¤é”™è¯¯å“åº”\n      if (!outgoing.headersSent) {\n        outgoing.statusCode = 500;\n        outgoing.setHeader(\"Content-Type\", \"text/plain\");\n        outgoing.end(\"Internal Server Error\");\n      }\n    }\n  };\n}\n\n/**\n * å¯åŠ¨ HTTP æœåŠ¡å™¨\n *\n * @example\n * ```ts\n * import { serve } from \"@vafast/node-server\";\n * import { Server } from \"vafast\";\n *\n * const app = new Server([\n *   { method: \"GET\", path: \"/\", handler: () => \"Hello World\" },\n * ]);\n *\n * serve({ fetch: app.fetch, port: 3000 }, () => {\n *   console.log(\"Server running on http://localhost:3000\");\n * });\n * ```\n */\nexport function serve(\n  options: ServeOptions,\n  callback?: () => void,\n): ServeResult {\n  const { fetch, port = 3000, hostname = \"0.0.0.0\", onError, gracefulShutdown } = options;\n\n  const defaultHost = `${hostname === \"0.0.0.0\" ? \"localhost\" : hostname}:${port}`;\n  const handler = createRequestHandler(fetch, defaultHost, onError);\n\n  const server = createServer(handler);\n\n  // è¿½è¸ªæ´»è·ƒè¿æ¥\n  const connections = new Set<import(\"node:net\").Socket>();\n\n  server.on(\"connection\", (socket) => {\n    connections.add(socket);\n    socket.on(\"close\", () => connections.delete(socket));\n  });\n\n  // ä¼˜é›…å…³é—­å‡½æ•°\n  let isShuttingDown = false;\n\n  const shutdown = async (): Promise<void> => {\n    if (isShuttingDown) return;\n    isShuttingDown = true;\n\n    const shutdownOptions: GracefulShutdownOptions =\n      typeof gracefulShutdown === \"object\" ? gracefulShutdown : {};\n\n    const timeout = shutdownOptions.timeout ?? 30000;\n\n    // æ‰§è¡Œå…³é—­å‰å›è°ƒ\n    if (shutdownOptions.onShutdown) {\n      await shutdownOptions.onShutdown();\n    }\n\n    return new Promise<void>((resolve) => {\n      // è®¾ç½®è¶…æ—¶å¼ºåˆ¶å…³é—­\n      const forceCloseTimer = setTimeout(() => {\n        // å¼ºåˆ¶å…³é—­æ‰€æœ‰è¿æ¥\n        for (const socket of connections) {\n          socket.destroy();\n        }\n        connections.clear();\n        resolve();\n      }, timeout);\n\n      // åœæ­¢æ¥å—æ–°è¿æ¥\n      server.close(() => {\n        clearTimeout(forceCloseTimer);\n        shutdownOptions.onShutdownComplete?.();\n        resolve();\n      });\n\n      // å…³é—­ç©ºé—²è¿æ¥\n      for (const socket of connections) {\n        // å¦‚æœè¿æ¥ç©ºé—²ï¼Œç«‹å³å…³é—­\n        if (!socket.writableLength) {\n          socket.end();\n        }\n      }\n    });\n  };\n\n  // æ³¨å†Œä¿¡å·å¤„ç†\n  if (gracefulShutdown) {\n    const shutdownOptions: GracefulShutdownOptions =\n      typeof gracefulShutdown === \"object\" ? gracefulShutdown : {};\n\n    const signals = shutdownOptions.signals ?? [\"SIGINT\", \"SIGTERM\"];\n\n    for (const signal of signals) {\n      process.on(signal, () => {\n        shutdown().then(() => process.exit(0));\n      });\n    }\n  }\n\n  // å¯åŠ¨æœåŠ¡å™¨\n  server.listen(port, hostname, callback);\n\n  return {\n    server,\n    port,\n    hostname,\n    stop: () =>\n      new Promise<void>((resolve, reject) => {\n        server.close((err) => {\n          if (err) reject(err);\n          else resolve();\n        });\n      }),\n    shutdown,\n  };\n}\n\n/**\n * åˆ›å»ºé€‚é…å™¨æœåŠ¡å™¨ï¼ˆä¸è‡ªåŠ¨å¯åŠ¨ï¼‰\n * ç”¨äºéœ€è¦æ›´å¤šæ§åˆ¶çš„åœºæ™¯\n */\nexport function createAdaptorServer(\n  fetch: FetchHandler,\n  onError?: (error: Error) => Response | Promise<Response>,\n): HttpServer {\n  const handler = createRequestHandler(fetch, \"localhost\", onError);\n  return createServer(handler);\n}\n","/**\n * ä¼˜åŒ–çš„ Request ä»£ç†\n * å»¶è¿Ÿåˆ›å»ºçœŸå® Requestï¼Œå‡å°‘ä¸å¿…è¦çš„å¯¹è±¡åˆ†é…\n */\n\nimport { Readable } from \"node:stream\";\nimport type { ReadableStream as NodeReadableStream } from \"node:stream/web\";\nimport type { IncomingMessage } from \"node:http\";\n\n// å†…éƒ¨ Symbol\nconst requestCache = Symbol(\"requestCache\");\nconst incomingKey = Symbol(\"incoming\");\nconst urlKey = Symbol(\"url\");\nconst headersKey = Symbol(\"headers\");\n\n/**\n * ä» rawHeaders é«˜æ•ˆè§£æ Headers\n */\nfunction parseHeaders(rawHeaders: string[]): Headers {\n  const headers = new Headers();\n  for (let i = 0; i < rawHeaders.length; i += 2) {\n    const key = rawHeaders[i];\n    const value = rawHeaders[i + 1];\n    // è·³è¿‡ HTTP/2 ä¼ªå¤´ (ä»¥ : å¼€å¤´)\n    if (key.charCodeAt(0) !== 58) {\n      headers.append(key, value);\n    }\n  }\n  return headers;\n}\n\n/**\n * å°† Node.js ReadableStream è½¬æ¢ä¸º Web æ ‡å‡† ReadableStream\n * Node.js å’Œ Web æ ‡å‡†çš„ ReadableStream åœ¨è¿è¡Œæ—¶å…¼å®¹ï¼Œä½† TypeScript ç±»å‹ä¸åŒ\n */\nfunction toWebStream(\n  nodeStream: NodeReadableStream<Uint8Array>,\n): ReadableStream<Uint8Array> {\n  // Node.js ReadableStream å’Œ Web ReadableStream åœ¨è¿è¡Œæ—¶æ˜¯å…¼å®¹çš„\n  // è¿™é‡Œä½¿ç”¨ç±»å‹æ–­è¨€æ˜¯å®‰å…¨çš„ï¼Œå› ä¸º Node.js >= 18 çš„ stream/web å®Œå…¨å®ç°äº† WHATWG Streams æ ‡å‡†\n  return nodeStream as unknown as ReadableStream<Uint8Array>;\n}\n\n/** ä»£ç† Request å†…éƒ¨æ¥å£ */\ninterface ProxyRequestInternal {\n  [requestCache]?: Request;\n  [incomingKey]: IncomingMessage;\n  [urlKey]: string;\n  [headersKey]?: Headers;\n  _getRequest(): Request;\n}\n\n/**\n * åˆ›å»ºçœŸå®çš„ Request å¯¹è±¡\n */\nfunction createRealRequest(proxy: ProxyRequestInternal): Request {\n  const incoming = proxy[incomingKey];\n  const method = incoming.method || \"GET\";\n  const init: RequestInit & { duplex?: string } = {\n    method,\n    headers: proxy[headersKey] || parseHeaders(incoming.rawHeaders),\n  };\n\n  // åªæœ‰é GET/HEAD è¯·æ±‚æ‰æœ‰ body\n  if (method !== \"GET\" && method !== \"HEAD\") {\n    // ä½¿ç”¨ Node.js åŸç”Ÿæµè½¬æ¢ï¼Œé¿å…æ”¶é›† chunks\n    const nodeWebStream = Readable.toWeb(\n      incoming,\n    ) as NodeReadableStream<Uint8Array>;\n    init.body = toWebStream(nodeWebStream);\n    init.duplex = \"half\";\n  }\n\n  return new Request(proxy[urlKey], init);\n}\n\n/**\n * Request ä»£ç†åŸå‹\n * ä½¿ç”¨ Object.defineProperty å®šä¹‰å±æ€§ä»¥æ”¯æŒ this ç»‘å®š\n */\nconst requestPrototype: object = {};\n\n// å®šä¹‰ method å±æ€§\nObject.defineProperty(requestPrototype, \"method\", {\n  get() {\n    const self = this as ProxyRequestInternal;\n    return self[incomingKey].method || \"GET\";\n  },\n  enumerable: true,\n});\n\n// å®šä¹‰ url å±æ€§\nObject.defineProperty(requestPrototype, \"url\", {\n  get() {\n    const self = this as ProxyRequestInternal;\n    return self[urlKey];\n  },\n  enumerable: true,\n});\n\n// å®šä¹‰ headers å±æ€§ï¼ˆå»¶è¿Ÿè§£æï¼‰\nObject.defineProperty(requestPrototype, \"headers\", {\n  get() {\n    const self = this as ProxyRequestInternal;\n    if (!self[headersKey]) {\n      self[headersKey] = parseHeaders(self[incomingKey].rawHeaders);\n    }\n    return self[headersKey];\n  },\n  enumerable: true,\n});\n\n// å®šä¹‰ _getRequest æ–¹æ³•ï¼ˆè·å–æˆ–åˆ›å»ºçœŸå® Requestï¼‰\nObject.defineProperty(requestPrototype, \"_getRequest\", {\n  value: function () {\n    const self = this as ProxyRequestInternal;\n    if (!self[requestCache]) {\n      self[requestCache] = createRealRequest(self);\n    }\n    return self[requestCache]!;\n  },\n  enumerable: false,\n});\n\n// ä»£ç†éœ€è¦è®¿é—®çœŸå® Request çš„å±æ€§\nconst proxyGetters = [\n  \"body\",\n  \"bodyUsed\",\n  \"signal\",\n  \"cache\",\n  \"credentials\",\n  \"destination\",\n  \"integrity\",\n  \"mode\",\n  \"redirect\",\n  \"referrer\",\n  \"referrerPolicy\",\n  \"keepalive\",\n];\n\nproxyGetters.forEach((key) => {\n  Object.defineProperty(requestPrototype, key, {\n    get() {\n      const self = this as ProxyRequestInternal;\n      return self._getRequest()[key as keyof Request];\n    },\n    enumerable: true,\n  });\n});\n\n// ä»£ç†éœ€è¦è°ƒç”¨çœŸå® Request çš„æ–¹æ³•\nconst proxyMethods = [\n  \"arrayBuffer\",\n  \"blob\",\n  \"clone\",\n  \"formData\",\n  \"json\",\n  \"text\",\n];\n\nproxyMethods.forEach((key) => {\n  Object.defineProperty(requestPrototype, key, {\n    value: function () {\n      const self = this as ProxyRequestInternal;\n      const req = self._getRequest();\n      return (req[key as keyof Request] as () => Promise<unknown>).call(req);\n    },\n    enumerable: true,\n  });\n});\n\n// è®¾ç½®åŸå‹é“¾\nObject.setPrototypeOf(requestPrototype, Request.prototype);\n\n/**\n * åˆ›å»ºä»£ç† Request\n * @param incoming Node.js IncomingMessage\n * @param defaultHost é»˜è®¤ä¸»æœºå\n */\nexport function createProxyRequest(\n  incoming: IncomingMessage,\n  defaultHost: string,\n): Request {\n  const req = Object.create(requestPrototype) as ProxyRequestInternal;\n  req[incomingKey] = incoming;\n\n  // æ„å»º URL\n  const host = incoming.headers.host || defaultHost;\n  const protocol = (incoming.socket as { encrypted?: boolean }).encrypted\n    ? \"https\"\n    : \"http\";\n  req[urlKey] = `${protocol}://${host}${incoming.url || \"/\"}`;\n\n  return req as unknown as Request;\n}\n","/**\n * ä¼˜åŒ–çš„ Response å†™å…¥\n * æµå¼å†™å…¥ï¼Œé¿å…å†…å­˜æ‹·è´\n */\n\nimport type { ServerResponse } from \"node:http\";\n\n/**\n * æ„å»º Node.js å“åº”å¤´\n * å¤„ç† set-cookie å¤šå€¼æƒ…å†µ\n */\nfunction buildOutgoingHeaders(\n  headers: Headers,\n): Record<string, string | string[]> {\n  const result: Record<string, string | string[]> = {};\n  const cookies: string[] = [];\n\n  headers.forEach((value, key) => {\n    if (key === \"set-cookie\") {\n      cookies.push(value);\n    } else {\n      result[key] = value;\n    }\n  });\n\n  if (cookies.length > 0) {\n    result[\"set-cookie\"] = cookies;\n  }\n\n  return result;\n}\n\n/**\n * æµå¼å†™å…¥ Response body åˆ° ServerResponse\n * æ”¯æŒèƒŒå‹å¤„ç†ï¼Œé¿å…å†…å­˜æº¢å‡º\n */\nasync function writeBodyStream(\n  body: ReadableStream<Uint8Array>,\n  outgoing: ServerResponse,\n): Promise<void> {\n  const reader = body.getReader();\n\n  try {\n    while (true) {\n      const { done, value } = await reader.read();\n\n      if (done) {\n        break;\n      }\n\n      // èƒŒå‹å¤„ç†ï¼šå¦‚æœå†™å…¥è¿”å› falseï¼Œç­‰å¾… drain äº‹ä»¶\n      const canContinue = outgoing.write(value);\n      if (!canContinue) {\n        await new Promise<void>((resolve) => {\n          outgoing.once(\"drain\", resolve);\n        });\n      }\n    }\n  } finally {\n    reader.releaseLock();\n  }\n}\n\n/**\n * å°† Web Response å†™å…¥ Node.js ServerResponse\n * æµå¼å†™å…¥ï¼Œé›¶æ‹·è´\n */\nexport async function writeResponse(\n  response: Response,\n  outgoing: ServerResponse,\n): Promise<void> {\n  // è®¾ç½®çŠ¶æ€ç \n  outgoing.statusCode = response.status;\n\n  // è®¾ç½®å“åº”å¤´\n  const headers = buildOutgoingHeaders(response.headers);\n  for (const [key, value] of Object.entries(headers)) {\n    outgoing.setHeader(key, value);\n  }\n\n  const body = response.body;\n\n  // æ—  body çš„æƒ…å†µ\n  if (!body) {\n    outgoing.end();\n    return;\n  }\n\n  // æµå¼å†™å…¥ body\n  try {\n    await writeBodyStream(body, outgoing);\n    outgoing.end();\n  } catch (error) {\n    // å¤„ç†å®¢æˆ·ç«¯æå‰æ–­å¼€ç­‰æƒ…å†µ\n    if (!outgoing.destroyed) {\n      outgoing.destroy(\n        error instanceof Error ? error : new Error(String(error)),\n      );\n    }\n  }\n}\n\n/**\n * ç®€åŒ–ç‰ˆå†™å…¥ï¼ˆç”¨äºå·²çŸ¥å°ä½“ç§¯å“åº”ï¼‰\n * ç›´æ¥ arrayBuffer è½¬æ¢ï¼Œé€‚ç”¨äºç¡®å®šçš„å°å“åº”\n */\nexport async function writeResponseSimple(\n  response: Response,\n  outgoing: ServerResponse,\n): Promise<void> {\n  outgoing.statusCode = response.status;\n\n  const headers = buildOutgoingHeaders(response.headers);\n  for (const [key, value] of Object.entries(headers)) {\n    outgoing.setHeader(key, value);\n  }\n\n  const body = response.body;\n  if (!body) {\n    outgoing.end();\n    return;\n  }\n\n  // å¯¹äºå°å“åº”ï¼Œç›´æ¥è¯»å–å…¨éƒ¨å†…å®¹\n  const buffer = await response.arrayBuffer();\n  outgoing.end(Buffer.from(buffer));\n}\n","export * from \"./server\";\nexport * from \"./middleware\";\nexport * from \"./utils\";\nexport * from \"./router\";\nexport * from \"./middleware/authMiddleware\";\nexport * from \"./middleware/rateLimit\";\nexport * from \"./middleware/cors\";\nexport * from \"./auth/token\";\nexport * from \"./middleware/auth\";\nexport * from \"./defineRoute\";\nexport * from \"./types\";\n\n// ç»Ÿä¸€çš„ serve å‡½æ•°\nexport { serve } from \"./serve\";\nexport type { ServeOptions, ServeResult, FetchHandler } from \"./serve\";\n\n// é‡æ–°å¯¼å‡º TypeBox ç±»å‹\nexport { Type, FormatRegistry } from \"@sinclair/typebox\";\n\n// è‡ªåŠ¨æ³¨å†Œå†…ç½® format éªŒè¯å™¨\nimport { registerFormats } from \"./utils/formats\";\nregisterFormats();\n"],"mappings":"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","names":["route","stream","route","route","route","route","route","html","text","getCookie","stream","encoder","getCookie","refreshToken","getCookie","route","parseHeaders","Type","FormatRegistry"]}