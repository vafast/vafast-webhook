import { Server } from 'node:http';

/**
 * Node.js 服务器适配器
 * 提供类似 Bun.serve 的 API
 */

/** fetch 函数类型 */
type FetchHandler = (request: Request) => Response | Promise<Response>;
/** 优雅关闭配置 */
interface GracefulShutdownOptions {
    /** 关闭超时时间（毫秒），默认 30000 */
    timeout?: number;
    /** 关闭前回调 */
    onShutdown?: () => void | Promise<void>;
    /** 关闭完成回调 */
    onShutdownComplete?: () => void;
    /** 监听的信号，默认 ['SIGINT', 'SIGTERM'] */
    signals?: NodeJS.Signals[];
}
/** serve 配置选项 */
interface ServeOptions {
    /** fetch 处理函数 */
    fetch: FetchHandler;
    /** 端口号，默认 3000 */
    port?: number;
    /** 主机名，默认 0.0.0.0 */
    hostname?: string;
    /** 错误处理函数 */
    onError?: (error: Error) => Response | Promise<Response>;
    /** 优雅关闭配置，设置为 true 使用默认配置 */
    gracefulShutdown?: boolean | GracefulShutdownOptions;
}
/** serve 返回的服务器信息 */
interface ServeResult {
    /** Node.js HTTP Server 实例 */
    server: Server;
    /** 服务器端口 */
    port: number;
    /** 服务器主机名 */
    hostname: string;
    /** 关闭服务器 */
    stop: () => Promise<void>;
    /** 优雅关闭（等待现有请求完成） */
    shutdown: () => Promise<void>;
}
/**
 * 启动 HTTP 服务器
 *
 * @example
 * ```ts
 * import { serve } from "@vafast/node-server";
 * import { Server } from "vafast";
 *
 * const app = new Server([
 *   { method: "GET", path: "/", handler: () => "Hello World" },
 * ]);
 *
 * serve({ fetch: app.fetch, port: 3000 }, () => {
 *   console.log("Server running on http://localhost:3000");
 * });
 * ```
 */
declare function serve(options: ServeOptions, callback?: () => void): ServeResult;
/**
 * 创建适配器服务器（不自动启动）
 * 用于需要更多控制的场景
 */
declare function createAdaptorServer(fetch: FetchHandler, onError?: (error: Error) => Response | Promise<Response>): Server;

export { type FetchHandler, type GracefulShutdownOptions, type ServeOptions, type ServeResult, createAdaptorServer, serve };
