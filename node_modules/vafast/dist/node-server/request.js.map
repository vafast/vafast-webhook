{"version":3,"sources":["../../src/node-server/request.ts"],"sourcesContent":["/**\n * 优化的 Request 代理\n * 延迟创建真实 Request，减少不必要的对象分配\n */\n\nimport { Readable } from \"node:stream\";\nimport type { ReadableStream as NodeReadableStream } from \"node:stream/web\";\nimport type { IncomingMessage } from \"node:http\";\n\n// 内部 Symbol\nconst requestCache = Symbol(\"requestCache\");\nconst incomingKey = Symbol(\"incoming\");\nconst urlKey = Symbol(\"url\");\nconst headersKey = Symbol(\"headers\");\n\n/**\n * 从 rawHeaders 高效解析 Headers\n */\nfunction parseHeaders(rawHeaders: string[]): Headers {\n  const headers = new Headers();\n  for (let i = 0; i < rawHeaders.length; i += 2) {\n    const key = rawHeaders[i];\n    const value = rawHeaders[i + 1];\n    // 跳过 HTTP/2 伪头 (以 : 开头)\n    if (key.charCodeAt(0) !== 58) {\n      headers.append(key, value);\n    }\n  }\n  return headers;\n}\n\n/**\n * 将 Node.js ReadableStream 转换为 Web 标准 ReadableStream\n * Node.js 和 Web 标准的 ReadableStream 在运行时兼容，但 TypeScript 类型不同\n */\nfunction toWebStream(\n  nodeStream: NodeReadableStream<Uint8Array>,\n): ReadableStream<Uint8Array> {\n  // Node.js ReadableStream 和 Web ReadableStream 在运行时是兼容的\n  // 这里使用类型断言是安全的，因为 Node.js >= 18 的 stream/web 完全实现了 WHATWG Streams 标准\n  return nodeStream as unknown as ReadableStream<Uint8Array>;\n}\n\n/** 代理 Request 内部接口 */\ninterface ProxyRequestInternal {\n  [requestCache]?: Request;\n  [incomingKey]: IncomingMessage;\n  [urlKey]: string;\n  [headersKey]?: Headers;\n  _getRequest(): Request;\n}\n\n/**\n * 创建真实的 Request 对象\n */\nfunction createRealRequest(proxy: ProxyRequestInternal): Request {\n  const incoming = proxy[incomingKey];\n  const method = incoming.method || \"GET\";\n  const init: RequestInit & { duplex?: string } = {\n    method,\n    headers: proxy[headersKey] || parseHeaders(incoming.rawHeaders),\n  };\n\n  // 只有非 GET/HEAD 请求才有 body\n  if (method !== \"GET\" && method !== \"HEAD\") {\n    // 使用 Node.js 原生流转换，避免收集 chunks\n    const nodeWebStream = Readable.toWeb(\n      incoming,\n    ) as NodeReadableStream<Uint8Array>;\n    init.body = toWebStream(nodeWebStream);\n    init.duplex = \"half\";\n  }\n\n  return new Request(proxy[urlKey], init);\n}\n\n/**\n * Request 代理原型\n * 使用 Object.defineProperty 定义属性以支持 this 绑定\n */\nconst requestPrototype: object = {};\n\n// 定义 method 属性\nObject.defineProperty(requestPrototype, \"method\", {\n  get() {\n    const self = this as ProxyRequestInternal;\n    return self[incomingKey].method || \"GET\";\n  },\n  enumerable: true,\n});\n\n// 定义 url 属性\nObject.defineProperty(requestPrototype, \"url\", {\n  get() {\n    const self = this as ProxyRequestInternal;\n    return self[urlKey];\n  },\n  enumerable: true,\n});\n\n// 定义 headers 属性（延迟解析）\nObject.defineProperty(requestPrototype, \"headers\", {\n  get() {\n    const self = this as ProxyRequestInternal;\n    if (!self[headersKey]) {\n      self[headersKey] = parseHeaders(self[incomingKey].rawHeaders);\n    }\n    return self[headersKey];\n  },\n  enumerable: true,\n});\n\n// 定义 _getRequest 方法（获取或创建真实 Request）\nObject.defineProperty(requestPrototype, \"_getRequest\", {\n  value: function () {\n    const self = this as ProxyRequestInternal;\n    if (!self[requestCache]) {\n      self[requestCache] = createRealRequest(self);\n    }\n    return self[requestCache]!;\n  },\n  enumerable: false,\n});\n\n// 代理需要访问真实 Request 的属性\nconst proxyGetters = [\n  \"body\",\n  \"bodyUsed\",\n  \"signal\",\n  \"cache\",\n  \"credentials\",\n  \"destination\",\n  \"integrity\",\n  \"mode\",\n  \"redirect\",\n  \"referrer\",\n  \"referrerPolicy\",\n  \"keepalive\",\n];\n\nproxyGetters.forEach((key) => {\n  Object.defineProperty(requestPrototype, key, {\n    get() {\n      const self = this as ProxyRequestInternal;\n      return self._getRequest()[key as keyof Request];\n    },\n    enumerable: true,\n  });\n});\n\n// 代理需要调用真实 Request 的方法\nconst proxyMethods = [\n  \"arrayBuffer\",\n  \"blob\",\n  \"clone\",\n  \"formData\",\n  \"json\",\n  \"text\",\n];\n\nproxyMethods.forEach((key) => {\n  Object.defineProperty(requestPrototype, key, {\n    value: function () {\n      const self = this as ProxyRequestInternal;\n      const req = self._getRequest();\n      return (req[key as keyof Request] as () => Promise<unknown>).call(req);\n    },\n    enumerable: true,\n  });\n});\n\n// 设置原型链\nObject.setPrototypeOf(requestPrototype, Request.prototype);\n\n/**\n * 创建代理 Request\n * @param incoming Node.js IncomingMessage\n * @param defaultHost 默认主机名\n */\nexport function createProxyRequest(\n  incoming: IncomingMessage,\n  defaultHost: string,\n): Request {\n  const req = Object.create(requestPrototype) as ProxyRequestInternal;\n  req[incomingKey] = incoming;\n\n  // 构建 URL\n  const host = incoming.headers.host || defaultHost;\n  const protocol = (incoming.socket as { encrypted?: boolean }).encrypted\n    ? \"https\"\n    : \"http\";\n  req[urlKey] = `${protocol}://${host}${incoming.url || \"/\"}`;\n\n  return req as unknown as Request;\n}\n"],"mappings":"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","names":[]}