{"version":3,"sources":["../../src/node-server/serve.ts","../../src/node-server/request.ts","../../src/node-server/response.ts"],"sourcesContent":["/**\n * Node.js 服务器适配器\n * 提供类似 Bun.serve 的 API\n */\n\nimport {\n  createServer,\n  type Server as HttpServer,\n  type IncomingMessage,\n  type ServerResponse,\n} from \"node:http\";\nimport { createProxyRequest } from \"./request\";\nimport { writeResponse } from \"./response\";\n\n/** fetch 函数类型 */\nexport type FetchHandler = (request: Request) => Response | Promise<Response>;\n\n/** 优雅关闭配置 */\nexport interface GracefulShutdownOptions {\n  /** 关闭超时时间（毫秒），默认 30000 */\n  timeout?: number;\n  /** 关闭前回调 */\n  onShutdown?: () => void | Promise<void>;\n  /** 关闭完成回调 */\n  onShutdownComplete?: () => void;\n  /** 监听的信号，默认 ['SIGINT', 'SIGTERM'] */\n  signals?: NodeJS.Signals[];\n}\n\n/** serve 配置选项 */\nexport interface ServeOptions {\n  /** fetch 处理函数 */\n  fetch: FetchHandler;\n  /** 端口号，默认 3000 */\n  port?: number;\n  /** 主机名，默认 0.0.0.0 */\n  hostname?: string;\n  /** 错误处理函数 */\n  onError?: (error: Error) => Response | Promise<Response>;\n  /** 优雅关闭配置，设置为 true 使用默认配置 */\n  gracefulShutdown?: boolean | GracefulShutdownOptions;\n}\n\n/** serve 返回的服务器信息 */\nexport interface ServeResult {\n  /** Node.js HTTP Server 实例 */\n  server: HttpServer;\n  /** 服务器端口 */\n  port: number;\n  /** 服务器主机名 */\n  hostname: string;\n  /** 关闭服务器 */\n  stop: () => Promise<void>;\n  /** 优雅关闭（等待现有请求完成） */\n  shutdown: () => Promise<void>;\n}\n\n/**\n * 创建请求处理函数\n */\nfunction createRequestHandler(\n  fetch: FetchHandler,\n  defaultHost: string,\n  onError?: (error: Error) => Response | Promise<Response>,\n) {\n  return async (incoming: IncomingMessage, outgoing: ServerResponse) => {\n    try {\n      // 创建代理 Request（延迟创建真实 Request）\n      const request = createProxyRequest(incoming, defaultHost);\n\n      // 调用 fetch handler\n      const response = await fetch(request);\n\n      // 流式写入 Response\n      await writeResponse(response, outgoing);\n    } catch (error) {\n      // 错误处理\n      const err = error instanceof Error ? error : new Error(String(error));\n\n      if (onError) {\n        try {\n          const errorResponse = await onError(err);\n          await writeResponse(errorResponse, outgoing);\n          return;\n        } catch {\n          // onError 也失败了，返回 500\n        }\n      }\n\n      // 默认错误响应\n      if (!outgoing.headersSent) {\n        outgoing.statusCode = 500;\n        outgoing.setHeader(\"Content-Type\", \"text/plain\");\n        outgoing.end(\"Internal Server Error\");\n      }\n    }\n  };\n}\n\n/**\n * 启动 HTTP 服务器\n *\n * @example\n * ```ts\n * import { serve } from \"@vafast/node-server\";\n * import { Server } from \"vafast\";\n *\n * const app = new Server([\n *   { method: \"GET\", path: \"/\", handler: () => \"Hello World\" },\n * ]);\n *\n * serve({ fetch: app.fetch, port: 3000 }, () => {\n *   console.log(\"Server running on http://localhost:3000\");\n * });\n * ```\n */\nexport function serve(\n  options: ServeOptions,\n  callback?: () => void,\n): ServeResult {\n  const { fetch, port = 3000, hostname = \"0.0.0.0\", onError, gracefulShutdown } = options;\n\n  const defaultHost = `${hostname === \"0.0.0.0\" ? \"localhost\" : hostname}:${port}`;\n  const handler = createRequestHandler(fetch, defaultHost, onError);\n\n  const server = createServer(handler);\n\n  // 追踪活跃连接\n  const connections = new Set<import(\"node:net\").Socket>();\n\n  server.on(\"connection\", (socket) => {\n    connections.add(socket);\n    socket.on(\"close\", () => connections.delete(socket));\n  });\n\n  // 优雅关闭函数\n  let isShuttingDown = false;\n\n  const shutdown = async (): Promise<void> => {\n    if (isShuttingDown) return;\n    isShuttingDown = true;\n\n    const shutdownOptions: GracefulShutdownOptions =\n      typeof gracefulShutdown === \"object\" ? gracefulShutdown : {};\n\n    const timeout = shutdownOptions.timeout ?? 30000;\n\n    // 执行关闭前回调\n    if (shutdownOptions.onShutdown) {\n      await shutdownOptions.onShutdown();\n    }\n\n    return new Promise<void>((resolve) => {\n      // 设置超时强制关闭\n      const forceCloseTimer = setTimeout(() => {\n        // 强制关闭所有连接\n        for (const socket of connections) {\n          socket.destroy();\n        }\n        connections.clear();\n        resolve();\n      }, timeout);\n\n      // 停止接受新连接\n      server.close(() => {\n        clearTimeout(forceCloseTimer);\n        shutdownOptions.onShutdownComplete?.();\n        resolve();\n      });\n\n      // 关闭空闲连接\n      for (const socket of connections) {\n        // 如果连接空闲，立即关闭\n        if (!socket.writableLength) {\n          socket.end();\n        }\n      }\n    });\n  };\n\n  // 注册信号处理\n  if (gracefulShutdown) {\n    const shutdownOptions: GracefulShutdownOptions =\n      typeof gracefulShutdown === \"object\" ? gracefulShutdown : {};\n\n    const signals = shutdownOptions.signals ?? [\"SIGINT\", \"SIGTERM\"];\n\n    for (const signal of signals) {\n      process.on(signal, () => {\n        shutdown().then(() => process.exit(0));\n      });\n    }\n  }\n\n  // 启动服务器\n  server.listen(port, hostname, callback);\n\n  return {\n    server,\n    port,\n    hostname,\n    stop: () =>\n      new Promise<void>((resolve, reject) => {\n        server.close((err) => {\n          if (err) reject(err);\n          else resolve();\n        });\n      }),\n    shutdown,\n  };\n}\n\n/**\n * 创建适配器服务器（不自动启动）\n * 用于需要更多控制的场景\n */\nexport function createAdaptorServer(\n  fetch: FetchHandler,\n  onError?: (error: Error) => Response | Promise<Response>,\n): HttpServer {\n  const handler = createRequestHandler(fetch, \"localhost\", onError);\n  return createServer(handler);\n}\n","/**\n * 优化的 Request 代理\n * 延迟创建真实 Request，减少不必要的对象分配\n */\n\nimport { Readable } from \"node:stream\";\nimport type { ReadableStream as NodeReadableStream } from \"node:stream/web\";\nimport type { IncomingMessage } from \"node:http\";\n\n// 内部 Symbol\nconst requestCache = Symbol(\"requestCache\");\nconst incomingKey = Symbol(\"incoming\");\nconst urlKey = Symbol(\"url\");\nconst headersKey = Symbol(\"headers\");\n\n/**\n * 从 rawHeaders 高效解析 Headers\n */\nfunction parseHeaders(rawHeaders: string[]): Headers {\n  const headers = new Headers();\n  for (let i = 0; i < rawHeaders.length; i += 2) {\n    const key = rawHeaders[i];\n    const value = rawHeaders[i + 1];\n    // 跳过 HTTP/2 伪头 (以 : 开头)\n    if (key.charCodeAt(0) !== 58) {\n      headers.append(key, value);\n    }\n  }\n  return headers;\n}\n\n/**\n * 将 Node.js ReadableStream 转换为 Web 标准 ReadableStream\n * Node.js 和 Web 标准的 ReadableStream 在运行时兼容，但 TypeScript 类型不同\n */\nfunction toWebStream(\n  nodeStream: NodeReadableStream<Uint8Array>,\n): ReadableStream<Uint8Array> {\n  // Node.js ReadableStream 和 Web ReadableStream 在运行时是兼容的\n  // 这里使用类型断言是安全的，因为 Node.js >= 18 的 stream/web 完全实现了 WHATWG Streams 标准\n  return nodeStream as unknown as ReadableStream<Uint8Array>;\n}\n\n/** 代理 Request 内部接口 */\ninterface ProxyRequestInternal {\n  [requestCache]?: Request;\n  [incomingKey]: IncomingMessage;\n  [urlKey]: string;\n  [headersKey]?: Headers;\n  _getRequest(): Request;\n}\n\n/**\n * 创建真实的 Request 对象\n */\nfunction createRealRequest(proxy: ProxyRequestInternal): Request {\n  const incoming = proxy[incomingKey];\n  const method = incoming.method || \"GET\";\n  const init: RequestInit & { duplex?: string } = {\n    method,\n    headers: proxy[headersKey] || parseHeaders(incoming.rawHeaders),\n  };\n\n  // 只有非 GET/HEAD 请求才有 body\n  if (method !== \"GET\" && method !== \"HEAD\") {\n    // 使用 Node.js 原生流转换，避免收集 chunks\n    const nodeWebStream = Readable.toWeb(\n      incoming,\n    ) as NodeReadableStream<Uint8Array>;\n    init.body = toWebStream(nodeWebStream);\n    init.duplex = \"half\";\n  }\n\n  return new Request(proxy[urlKey], init);\n}\n\n/**\n * Request 代理原型\n * 使用 Object.defineProperty 定义属性以支持 this 绑定\n */\nconst requestPrototype: object = {};\n\n// 定义 method 属性\nObject.defineProperty(requestPrototype, \"method\", {\n  get() {\n    const self = this as ProxyRequestInternal;\n    return self[incomingKey].method || \"GET\";\n  },\n  enumerable: true,\n});\n\n// 定义 url 属性\nObject.defineProperty(requestPrototype, \"url\", {\n  get() {\n    const self = this as ProxyRequestInternal;\n    return self[urlKey];\n  },\n  enumerable: true,\n});\n\n// 定义 headers 属性（延迟解析）\nObject.defineProperty(requestPrototype, \"headers\", {\n  get() {\n    const self = this as ProxyRequestInternal;\n    if (!self[headersKey]) {\n      self[headersKey] = parseHeaders(self[incomingKey].rawHeaders);\n    }\n    return self[headersKey];\n  },\n  enumerable: true,\n});\n\n// 定义 _getRequest 方法（获取或创建真实 Request）\nObject.defineProperty(requestPrototype, \"_getRequest\", {\n  value: function () {\n    const self = this as ProxyRequestInternal;\n    if (!self[requestCache]) {\n      self[requestCache] = createRealRequest(self);\n    }\n    return self[requestCache]!;\n  },\n  enumerable: false,\n});\n\n// 代理需要访问真实 Request 的属性\nconst proxyGetters = [\n  \"body\",\n  \"bodyUsed\",\n  \"signal\",\n  \"cache\",\n  \"credentials\",\n  \"destination\",\n  \"integrity\",\n  \"mode\",\n  \"redirect\",\n  \"referrer\",\n  \"referrerPolicy\",\n  \"keepalive\",\n];\n\nproxyGetters.forEach((key) => {\n  Object.defineProperty(requestPrototype, key, {\n    get() {\n      const self = this as ProxyRequestInternal;\n      return self._getRequest()[key as keyof Request];\n    },\n    enumerable: true,\n  });\n});\n\n// 代理需要调用真实 Request 的方法\nconst proxyMethods = [\n  \"arrayBuffer\",\n  \"blob\",\n  \"clone\",\n  \"formData\",\n  \"json\",\n  \"text\",\n];\n\nproxyMethods.forEach((key) => {\n  Object.defineProperty(requestPrototype, key, {\n    value: function () {\n      const self = this as ProxyRequestInternal;\n      const req = self._getRequest();\n      return (req[key as keyof Request] as () => Promise<unknown>).call(req);\n    },\n    enumerable: true,\n  });\n});\n\n// 设置原型链\nObject.setPrototypeOf(requestPrototype, Request.prototype);\n\n/**\n * 创建代理 Request\n * @param incoming Node.js IncomingMessage\n * @param defaultHost 默认主机名\n */\nexport function createProxyRequest(\n  incoming: IncomingMessage,\n  defaultHost: string,\n): Request {\n  const req = Object.create(requestPrototype) as ProxyRequestInternal;\n  req[incomingKey] = incoming;\n\n  // 构建 URL\n  const host = incoming.headers.host || defaultHost;\n  const protocol = (incoming.socket as { encrypted?: boolean }).encrypted\n    ? \"https\"\n    : \"http\";\n  req[urlKey] = `${protocol}://${host}${incoming.url || \"/\"}`;\n\n  return req as unknown as Request;\n}\n","/**\n * 优化的 Response 写入\n * 流式写入，避免内存拷贝\n */\n\nimport type { ServerResponse } from \"node:http\";\n\n/**\n * 构建 Node.js 响应头\n * 处理 set-cookie 多值情况\n */\nfunction buildOutgoingHeaders(\n  headers: Headers,\n): Record<string, string | string[]> {\n  const result: Record<string, string | string[]> = {};\n  const cookies: string[] = [];\n\n  headers.forEach((value, key) => {\n    if (key === \"set-cookie\") {\n      cookies.push(value);\n    } else {\n      result[key] = value;\n    }\n  });\n\n  if (cookies.length > 0) {\n    result[\"set-cookie\"] = cookies;\n  }\n\n  return result;\n}\n\n/**\n * 流式写入 Response body 到 ServerResponse\n * 支持背压处理，避免内存溢出\n */\nasync function writeBodyStream(\n  body: ReadableStream<Uint8Array>,\n  outgoing: ServerResponse,\n): Promise<void> {\n  const reader = body.getReader();\n\n  try {\n    while (true) {\n      const { done, value } = await reader.read();\n\n      if (done) {\n        break;\n      }\n\n      // 背压处理：如果写入返回 false，等待 drain 事件\n      const canContinue = outgoing.write(value);\n      if (!canContinue) {\n        await new Promise<void>((resolve) => {\n          outgoing.once(\"drain\", resolve);\n        });\n      }\n    }\n  } finally {\n    reader.releaseLock();\n  }\n}\n\n/**\n * 将 Web Response 写入 Node.js ServerResponse\n * 流式写入，零拷贝\n */\nexport async function writeResponse(\n  response: Response,\n  outgoing: ServerResponse,\n): Promise<void> {\n  // 设置状态码\n  outgoing.statusCode = response.status;\n\n  // 设置响应头\n  const headers = buildOutgoingHeaders(response.headers);\n  for (const [key, value] of Object.entries(headers)) {\n    outgoing.setHeader(key, value);\n  }\n\n  const body = response.body;\n\n  // 无 body 的情况\n  if (!body) {\n    outgoing.end();\n    return;\n  }\n\n  // 流式写入 body\n  try {\n    await writeBodyStream(body, outgoing);\n    outgoing.end();\n  } catch (error) {\n    // 处理客户端提前断开等情况\n    if (!outgoing.destroyed) {\n      outgoing.destroy(\n        error instanceof Error ? error : new Error(String(error)),\n      );\n    }\n  }\n}\n\n/**\n * 简化版写入（用于已知小体积响应）\n * 直接 arrayBuffer 转换，适用于确定的小响应\n */\nexport async function writeResponseSimple(\n  response: Response,\n  outgoing: ServerResponse,\n): Promise<void> {\n  outgoing.statusCode = response.status;\n\n  const headers = buildOutgoingHeaders(response.headers);\n  for (const [key, value] of Object.entries(headers)) {\n    outgoing.setHeader(key, value);\n  }\n\n  const body = response.body;\n  if (!body) {\n    outgoing.end();\n    return;\n  }\n\n  // 对于小响应，直接读取全部内容\n  const buffer = await response.arrayBuffer();\n  outgoing.end(Buffer.from(buffer));\n}\n"],"mappings":"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","names":[]}