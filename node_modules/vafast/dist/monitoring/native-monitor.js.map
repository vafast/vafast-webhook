{"version":3,"sources":["../../src/router.ts","../../src/utils/response.ts","../../src/middleware.ts","../../src/server/base-server.ts","../../src/router/radix-tree.ts","../../src/utils/route-registry.ts","../../src/server/server.ts","../../src/middleware/component-router.ts","../../src/utils/path-matcher.ts","../../src/utils/html-renderer.ts","../../src/utils/dependency-manager.ts","../../src/server/component-server.ts","../../src/server/server-factory.ts","../../src/server/index.ts","../../src/monitoring/native-monitor.ts"],"sourcesContent":["/**\n * è·¯ç”±å·¥å…·å‡½æ•°\n *\n * æä¾›è·¯ç”±å¤„ç†çš„åŸºç¡€å·¥å…·\n */\n\nimport type { Route, NestedRoute, FlattenedRoute, Middleware } from \"./types\";\n\n/**\n * æ‰å¹³åŒ–åµŒå¥—è·¯ç”±\n *\n * å°†åµŒå¥—è·¯ç”±ç»“æ„è½¬æ¢ä¸ºæ‰å¹³æ•°ç»„ï¼Œè®¡ç®—å®Œæ•´è·¯å¾„å’Œä¸­é—´ä»¶é“¾\n *\n * @example\n * ```typescript\n * const routes = flattenNestedRoutes([\n *   {\n *     path: \"/api\",\n *     middleware: [authMiddleware],\n *     children: [\n *       { path: \"/users\", method: \"GET\", handler: getUsers },\n *       { path: \"/users/:id\", method: \"GET\", handler: getUser },\n *     ],\n *   },\n * ]);\n * // ç»“æœ:\n * // [\n * //   { fullPath: \"/api/users\", method: \"GET\", ... },\n * //   { fullPath: \"/api/users/:id\", method: \"GET\", ... },\n * // ]\n * ```\n */\nexport function flattenNestedRoutes(\n  routes: (Route | NestedRoute)[],\n): FlattenedRoute[] {\n  const flattened: FlattenedRoute[] = [];\n\n  function processRoute(\n    route: Route | NestedRoute,\n    parentPath = \"\",\n    parentMiddleware: Middleware[] = [],\n  ): void {\n    // è®¡ç®—å½“å‰å®Œæ•´è·¯å¾„\n    const currentPath = normalizePath(parentPath + route.path);\n    // åˆå¹¶ä¸­é—´ä»¶é“¾\n    const currentMiddleware = [\n      ...parentMiddleware,\n      ...(route.middleware || []),\n    ];\n\n    if (\"method\" in route && \"handler\" in route) {\n      // å¶å­è·¯ç”±ï¼ˆæœ‰å¤„ç†å‡½æ•°ï¼‰\n      const leafRoute = route as Route;\n      flattened.push({\n        ...leafRoute,\n        fullPath: currentPath,\n        middlewareChain: currentMiddleware,\n      });\n    } else if (\"children\" in route && route.children) {\n      // åˆ†ç»„è·¯ç”±ï¼Œé€’å½’å¤„ç†å­è·¯ç”±\n      for (const child of route.children) {\n        processRoute(child, currentPath, currentMiddleware);\n      }\n    }\n  }\n\n  for (const route of routes) {\n    processRoute(route);\n  }\n\n  return flattened;\n}\n\n/**\n * æ ‡å‡†åŒ–è·¯å¾„\n *\n * - è§£ç  URL ç¼–ç å­—ç¬¦\n * - å»é™¤é‡å¤æ–œæ \n * - å¤„ç†ç»“å°¾æ–œæ \n *\n * @example\n * ```typescript\n * normalizePath(\"//api//users/\")  // \"/api/users\"\n * normalizePath(\"/api/%20test\")   // \"/api/ test\"\n * ```\n */\nexport function normalizePath(path: string): string {\n  // è§£ç  URL ç¼–ç \n  let normalized = decodeURIComponent(path);\n\n  // å»é™¤é‡å¤æ–œæ \n  normalized = normalized.replace(/\\/+/g, \"/\");\n\n  // ç©ºè·¯å¾„è½¬ä¸ºæ ¹è·¯å¾„\n  if (normalized === \"\") return \"/\";\n\n  // å»é™¤ç»“å°¾æ–œæ ï¼ˆæ ¹è·¯å¾„é™¤å¤–ï¼‰\n  if (normalized !== \"/\" && normalized.endsWith(\"/\")) {\n    normalized = normalized.slice(0, -1);\n  }\n\n  return normalized;\n}\n","// src/response.ts\n\n/** ç”Ÿæˆ JSON å“åº” */\nexport function json(\n  data: unknown,\n  status = 200,\n  headers: HeadersInit = {},\n): Response {\n  const body = JSON.stringify(data);\n\n  // ä¼˜åŒ–ï¼šåªåœ¨æœ‰è‡ªå®šä¹‰ headers æ—¶æ‰åˆ›å»º Headers å¯¹è±¡\n  if (Object.keys(headers).length === 0) {\n    return new Response(body, {\n      status,\n      headers: { \"Content-Type\": \"application/json\" },\n    });\n  }\n\n  // æœ‰è‡ªå®šä¹‰ headers æ—¶æ‰åˆ›å»º Headers å¯¹è±¡\n  const h = new Headers({\n    \"Content-Type\": \"application/json\",\n    ...headers,\n  });\n\n  return new Response(body, {\n    status,\n    headers: h,\n  });\n}\n\n// JSON å“åº”çš„é¢„åˆ›å»º headersï¼ˆé¿å…æ¯æ¬¡åˆ›å»ºï¼‰\nconst JSON_HEADERS = { \"Content-Type\": \"application/json\" };\nconst TEXT_HEADERS = { \"Content-Type\": \"text/plain\" };\n\n/**\n * ç±»å‹ç‰¹åŒ–çš„å“åº”æ˜ å°„\n * æ ¹æ®è¿”å›å€¼ç±»å‹ç›´æ¥ç”Ÿæˆ Responseï¼Œé¿å…ä¸å¿…è¦çš„æ£€æŸ¥\n */\nexport function mapResponse(response: unknown): Response {\n  // å¿«é€Ÿè·¯å¾„ï¼šå·²ç»æ˜¯ Response\n  if (response instanceof Response) return response;\n\n  // ä½¿ç”¨ constructor.name è¿›è¡Œç±»å‹åˆ¤æ–­ï¼ˆæ¯” instanceof æ›´å¿«ï¼‰\n  switch (response?.constructor?.name) {\n    case \"String\":\n      return new Response(response as string, { headers: TEXT_HEADERS });\n\n    case \"Object\":\n    case \"Array\":\n      return new Response(JSON.stringify(response), { headers: JSON_HEADERS });\n\n    case \"Number\":\n    case \"Boolean\":\n      return new Response(String(response), { headers: TEXT_HEADERS });\n\n    case undefined:\n      // null æˆ– undefined\n      return new Response(null, { status: 204 });\n\n    case \"ReadableStream\":\n      return new Response(response as ReadableStream);\n\n    case \"Blob\":\n      return new Response(response as Blob);\n\n    case \"ArrayBuffer\":\n      return new Response(response as ArrayBuffer);\n\n    case \"Uint8Array\":\n      return new Response(response as unknown as BodyInit);\n\n    default:\n      // Promise å¤„ç†\n      if (response instanceof Promise) {\n        return response.then(mapResponse) as unknown as Response;\n      }\n      // å…¶ä»–æƒ…å†µä½¿ç”¨ JSON åºåˆ—åŒ–\n      return new Response(JSON.stringify(response), { headers: JSON_HEADERS });\n  }\n}\n\n/** ç”Ÿæˆé‡å®šå‘å“åº” */\nexport function redirect(location: string, status: 301 | 302 = 302): Response {\n  return new Response(null, {\n    status,\n    headers: {\n      Location: location,\n    },\n  });\n}\n\n/** ç”Ÿæˆçº¯æ–‡æœ¬å“åº” */\nexport function text(\n  content: string,\n  status = 200,\n  headers: HeadersInit = {},\n): Response {\n  const h = new Headers({\n    \"Content-Type\": \"text/plain; charset=utf-8\",\n    ...headers,\n  });\n\n  return new Response(content, {\n    status,\n    headers: h,\n  });\n}\n\n/** ç”ŸæˆHTMLå“åº” */\nexport function html(\n  content: string,\n  status = 200,\n  headers: HeadersInit = {},\n): Response {\n  const h = new Headers({\n    \"Content-Type\": \"text/html; charset=utf-8\",\n    ...headers,\n  });\n\n  return new Response(content, {\n    status,\n    headers: h,\n  });\n}\n\n/** ç”Ÿæˆç©ºå“åº”ï¼ˆ204 No Contentï¼‰ */\nexport function empty(status = 204, headers: HeadersInit = {}): Response {\n  return new Response(null, {\n    status,\n    headers,\n  });\n}\n\n/** ç”Ÿæˆæµå¼å“åº” */\nexport function stream(\n  stream: ReadableStream,\n  status = 200,\n  headers: HeadersInit = {},\n): Response {\n  const h = new Headers({\n    \"Content-Type\": \"application/octet-stream\",\n    ...headers,\n  });\n\n  return new Response(stream, {\n    status,\n    headers: h,\n  });\n}\n","// src/middleware.ts\n\nimport { json, mapResponse } from \"./utils/response\";\n\nimport type { Handler, Middleware } from \"./types\";\n/** ä¸­é—´ä»¶ç±»å‹ï¼šä½¿ç”¨ next() ä¼ é€’ç»™ä¸‹ä¸€ä¸ªå¤„ç† */\n\n/** Vafast è‡ªå®šä¹‰é”™è¯¯ç±»å‹ */\nexport class VafastError extends Error {\n  status: number;\n  type: string;\n  expose: boolean;\n\n  constructor(\n    message: string,\n    options: {\n      status?: number;\n      type?: string;\n      expose?: boolean;\n      cause?: unknown;\n    } = {},\n  ) {\n    super(message);\n    this.name = \"VafastError\";\n    this.status = options.status ?? 500;\n    this.type = options.type ?? \"internal_error\";\n    this.expose = options.expose ?? false;\n    if (options.cause) (this as any).cause = options.cause;\n  }\n}\n\n/**\n * ç»„åˆç±»å‹: è‡ªåŠ¨æ³¨å…¥é”™è¯¯å¤„ç†å™¨è¿›è¡Œä¸­é—´ä»¶ç»„åˆ\n */\nexport function composeMiddleware(\n  middleware: Middleware[],\n  finalHandler: Handler,\n): (req: Request) => Promise<Response> {\n  const all = [errorHandler, ...middleware];\n\n  return function composedHandler(req: Request): Promise<Response> {\n    let i = -1;\n\n    const dispatch = (index: number): Promise<Response> => {\n      if (index <= i)\n        return Promise.reject(new Error(\"next() called multiple times\"));\n      i = index;\n\n      // ä¸­é—´ä»¶é˜¶æ®µ\n      if (index < all.length) {\n        const mw = all[index];\n        return Promise.resolve(mw(req, () => dispatch(index + 1)));\n      }\n\n      // æœ€ç»ˆ handler - ä½¿ç”¨ mapResponse è½¬æ¢è¿”å›å€¼\n      return Promise.resolve(finalHandler(req)).then(mapResponse);\n    };\n\n    return dispatch(0);\n  };\n}\n\n/** é»˜è®¤åŒ…å«çš„å…¨å±€é”™è¯¯å¤„ç†å™¨ */\nconst errorHandler: Middleware = async (req, next) => {\n  try {\n    return await next();\n  } catch (err) {\n    console.error(\"æœªå¤„ç†çš„é”™è¯¯:\", err);\n\n    if (err instanceof VafastError) {\n      return json(\n        {\n          error: err.type,\n          message: err.expose ? err.message : \"å‘ç”Ÿäº†ä¸€ä¸ªé”™è¯¯\",\n        },\n        err.status,\n      );\n    }\n\n    return json({ error: \"internal_error\", message: \"å‡ºç°äº†ä¸€äº›é—®é¢˜\" }, 500);\n  }\n};\n","import type { Middleware } from \"../types\";\n\n/**\n * æœåŠ¡å™¨åŸºç±»\n * åŒ…å«æ‰€æœ‰æœåŠ¡å™¨ç±»å‹çš„å…¬å…±é€»è¾‘\n */\nexport abstract class BaseServer {\n  protected globalMiddleware: Middleware[] = [];\n\n  use(mw: Middleware) {\n    this.globalMiddleware.push(mw);\n  }\n\n  /**\n   * æ‰“å°æ‰å¹³åŒ–åçš„è·¯ç”±ä¿¡æ¯ï¼Œç”¨äºè°ƒè¯•\n   */\n  protected logFlattenedRoutes(routes: any[], type: string = \"è·¯ç”±\"): void {\n    console.log(`ğŸš€ æ‰å¹³åŒ–åçš„${type}:`);\n    for (const route of routes) {\n      const method = route.method || \"GET\";\n      const path = route.fullPath || route.path;\n      console.log(`  ${method} ${path}`);\n      if (route.middlewareChain && route.middlewareChain.length > 0) {\n        console.log(`    ä¸­é—´ä»¶é“¾: ${route.middlewareChain.length} ä¸ª`);\n      }\n    }\n    console.log(\"\");\n  }\n\n  /**\n   * æ£€æµ‹è·¯ç”±å†²çª\n   * æ£€æŸ¥æ˜¯å¦æœ‰è·¯å¾„ç›¸åŒä½†æ–¹æ³•ä¸åŒçš„è·¯ç”±ï¼Œä»¥åŠæ½œåœ¨çš„è·¯å¾„å†²çª\n   */\n  protected detectRouteConflicts(routes: any[]): void {\n    const pathGroups = new Map<string, any[]>();\n\n    // æŒ‰è·¯å¾„åˆ†ç»„\n    for (const route of routes) {\n      const path = route.fullPath || route.path;\n      const method = route.method || \"GET\";\n      if (!pathGroups.has(path)) {\n        pathGroups.set(path, []);\n      }\n      pathGroups.get(path)!.push({ ...route, method });\n    }\n\n    // æ£€æŸ¥å†²çª\n    for (const [path, routeList] of pathGroups) {\n      if (routeList.length > 1) {\n        const methods = routeList.map((r) => r.method);\n        const uniqueMethods = [...new Set(methods)];\n\n        if (uniqueMethods.length === 1) {\n          // ç›¸åŒè·¯å¾„ã€ç›¸åŒæ–¹æ³• - è¿™æ˜¯å†²çªï¼\n          console.warn(\n            `âš ï¸  è·¯ç”±å†²çª: ${uniqueMethods[0]} ${path} å®šä¹‰äº† ${routeList.length} æ¬¡`,\n          );\n          routeList.forEach((route, index) => {\n            console.warn(`   ${index + 1}. ${route.method} ${path}`);\n          });\n        } else {\n          // ç›¸åŒè·¯å¾„ã€ä¸åŒæ–¹æ³• - è¿™æ˜¯æ­£å¸¸çš„\n          console.log(`â„¹ï¸  è·¯å¾„ ${path} æ”¯æŒæ–¹æ³•: ${uniqueMethods.join(\", \")}`);\n        }\n      }\n    }\n\n    // æ£€æŸ¥æ½œåœ¨çš„è·¯å¾„å†²çªï¼ˆåŠ¨æ€è·¯ç”±å¯èƒ½å†²çªï¼‰\n    this.detectDynamicRouteConflicts(routes);\n  }\n\n  /**\n   * æ£€æµ‹åŠ¨æ€è·¯ç”±çš„æ½œåœ¨å†²çª\n   */\n  private detectDynamicRouteConflicts(routes: any[]): void {\n    const dynamicRoutes = routes.filter((r) => {\n      const path = r.fullPath || r.path;\n      return path.includes(\":\") || path.includes(\"*\");\n    });\n\n    for (let i = 0; i < dynamicRoutes.length; i++) {\n      for (let j = i + 1; j < dynamicRoutes.length; j++) {\n        const route1 = dynamicRoutes[i];\n        const route2 = dynamicRoutes[j];\n        const method1 = route1.method || \"GET\";\n        const method2 = route2.method || \"GET\";\n\n        if (method1 === method2) {\n          const path1 = route1.fullPath || route1.path;\n          const path2 = route2.fullPath || route2.path;\n          // æ£€æŸ¥è·¯å¾„æ˜¯å¦å¯èƒ½å†²çª\n          if (this.pathsMayConflict(path1, path2)) {\n            console.warn(\n              `âš ï¸  æ½œåœ¨è·¯ç”±å†²çª: ${method1} ${path1} å¯èƒ½ä¸ ${path2} å†²çª`,\n            );\n          }\n        }\n      }\n    }\n  }\n\n  /**\n   * åˆ¤æ–­ä¸¤ä¸ªè·¯å¾„æ˜¯å¦å¯èƒ½å†²çª\n   */\n  private pathsMayConflict(path1: string, path2: string): boolean {\n    const parts1 = path1.split(\"/\").filter(Boolean);\n    const parts2 = path2.split(\"/\").filter(Boolean);\n\n    if (parts1.length !== parts2.length) return false;\n\n    for (let i = 0; i < parts1.length; i++) {\n      const p1 = parts1[i];\n      const p2 = parts2[i];\n\n      // å¦‚æœä¸¤ä¸ªéƒ¨åˆ†éƒ½æ˜¯é™æ€çš„ä¸”ä¸åŒï¼Œåˆ™ä¸ä¼šå†²çª\n      if (\n        !p1.startsWith(\":\") &&\n        !p1.startsWith(\"*\") &&\n        !p2.startsWith(\":\") &&\n        !p2.startsWith(\"*\") &&\n        p1 !== p2\n      ) {\n        return false;\n      }\n\n      // å¦‚æœä¸€ä¸ªæ˜¯é€šé…ç¬¦ï¼Œå¦ä¸€ä¸ªæ˜¯åŠ¨æ€å‚æ•°ï¼Œå¯èƒ½å†²çª\n      if (\n        (p1 === \"*\" && p2.startsWith(\":\")) ||\n        (p2 === \"*\" && p1.startsWith(\":\"))\n      ) {\n        return true;\n      }\n    }\n\n    return false;\n  }\n\n  /**\n   * è·¯å¾„åŒ¹é…\n   */\n  protected matchPath(pattern: string, path: string): boolean {\n    const patternParts = pattern.split(\"/\").filter(Boolean);\n    const pathParts = path.split(\"/\").filter(Boolean);\n\n    if (patternParts.length !== pathParts.length) {\n      return false;\n    }\n\n    for (let i = 0; i < patternParts.length; i++) {\n      if (\n        patternParts[i] !== pathParts[i] &&\n        !patternParts[i].startsWith(\":\")\n      ) {\n        return false;\n      }\n    }\n\n    return true;\n  }\n\n  /**\n   * æå–è·¯å¾„å‚æ•°\n   */\n  protected extractParams(\n    pattern: string,\n    path: string,\n  ): Record<string, string> {\n    const params: Record<string, string> = {};\n    const patternParts = pattern.split(\"/\").filter(Boolean);\n    const pathParts = path.split(\"/\").filter(Boolean);\n\n    for (let i = 0; i < patternParts.length; i++) {\n      if (patternParts[i].startsWith(\":\")) {\n        const paramName = patternParts[i].slice(1);\n        params[paramName] = pathParts[i];\n      }\n    }\n\n    return params;\n  }\n}\n","/**\n * Radix Tree è·¯ç”±åŒ¹é…å™¨\n *\n * é«˜æ€§èƒ½è·¯ç”±åŒ¹é…å®ç°ï¼Œæ—¶é—´å¤æ‚åº¦ O(k)ï¼Œk ä¸ºè·¯å¾„æ®µæ•°\n *\n * æ”¯æŒçš„è·¯ç”±æ¨¡å¼:\n * - é™æ€è·¯å¾„: /users, /api/v1/health\n * - åŠ¨æ€å‚æ•°: /users/:id, /posts/:postId/comments/:commentId\n * - é€šé…ç¬¦: /files/*, /static/*filepath\n */\n\nimport type { Handler, Middleware, Method } from \"../types\";\n\n/** é¢„ç¼–è¯‘çš„å¤„ç†å™¨ç±»å‹ */\ntype CompiledHandler = (req: Request) => Promise<Response>;\n\n/** è·¯ç”±å¤„ç†ä¿¡æ¯ */\ninterface RouteHandler {\n  handler: Handler;\n  middleware: Middleware[];\n  /** é¢„ç¼–è¯‘åçš„å®Œæ•´å¤„ç†é“¾ï¼ˆåŒ…å«ä¸­é—´ä»¶ï¼‰ */\n  compiled?: CompiledHandler;\n}\n\n/** Radix Tree èŠ‚ç‚¹ */\ninterface RadixNode {\n  path: string;\n  children: Record<string, RadixNode>;\n  paramChild?: RadixNode;\n  wildcardChild?: RadixNode;\n  paramName?: string;\n  handlers: Record<Method, RouteHandler | undefined>;\n}\n\n/** è·¯ç”±åŒ¹é…ç»“æœ */\nexport interface MatchResult {\n  handler: Handler;\n  middleware: Middleware[];\n  params: Record<string, string>;\n  /** é¢„ç¼–è¯‘åçš„å®Œæ•´å¤„ç†é“¾ */\n  compiled?: CompiledHandler;\n}\n\n/**\n * Radix Tree è·¯ç”±å™¨\n *\n * @example\n * ```typescript\n * const router = new RadixRouter();\n * router.register(\"GET\", \"/users/:id\", handler);\n * const result = router.match(\"GET\", \"/users/123\");\n * // result.params = { id: \"123\" }\n * ```\n */\nexport class RadixRouter {\n  private root: RadixNode;\n\n  constructor() {\n    this.root = this.createNode(\"\");\n  }\n\n  private createNode(path: string): RadixNode {\n    return {\n      path,\n      children: Object.create(null),\n      handlers: Object.create(null),\n    };\n  }\n\n  /** åˆ†å‰²è·¯å¾„ */\n  private splitPath(path: string): string[] {\n    return path.split(\"/\").filter(Boolean);\n  }\n\n  /** ç¼–è¯‘å™¨å‡½æ•° - ç”¨äºé¢„ç¼–è¯‘ä¸­é—´ä»¶é“¾ */\n  private compiler?: (\n    middleware: Middleware[],\n    handler: Handler,\n  ) => CompiledHandler;\n\n  /** è®¾ç½®ä¸­é—´ä»¶ç¼–è¯‘å™¨ */\n  setCompiler(\n    compiler: (middleware: Middleware[], handler: Handler) => CompiledHandler,\n  ): void {\n    this.compiler = compiler;\n  }\n\n  /** æ³¨å†Œè·¯ç”± */\n  register(\n    method: Method,\n    pattern: string,\n    handler: Handler,\n    middleware: Middleware[] = [],\n  ): void {\n    const segments = this.splitPath(pattern);\n    let node = this.root;\n\n    for (const segment of segments) {\n      const firstChar = segment[0];\n\n      if (firstChar === \":\") {\n        // åŠ¨æ€å‚æ•°èŠ‚ç‚¹\n        if (!node.paramChild) {\n          node.paramChild = this.createNode(segment);\n          node.paramChild.paramName = segment.substring(1);\n        }\n        node = node.paramChild;\n      } else if (firstChar === \"*\") {\n        // é€šé…ç¬¦èŠ‚ç‚¹\n        if (!node.wildcardChild) {\n          node.wildcardChild = this.createNode(segment);\n          node.wildcardChild.paramName =\n            segment.length > 1 ? segment.substring(1) : \"*\";\n        }\n        node = node.wildcardChild;\n        break;\n      } else {\n        // é™æ€è·¯å¾„èŠ‚ç‚¹\n        if (!node.children[segment]) {\n          node.children[segment] = this.createNode(segment);\n        }\n        node = node.children[segment];\n      }\n    }\n\n    const routeHandler: RouteHandler = { handler, middleware };\n\n    // å¦‚æœæ²¡æœ‰å…¨å±€ä¸­é—´ä»¶ä¸”è®¾ç½®äº†ç¼–è¯‘å™¨ï¼Œé¢„ç¼–è¯‘å¤„ç†é“¾\n    if (this.compiler && middleware.length === 0) {\n      routeHandler.compiled = this.compiler([], handler);\n    }\n\n    node.handlers[method] = routeHandler;\n  }\n\n  /** é¢„ç¼–è¯‘æ‰€æœ‰è·¯ç”±ï¼ˆåœ¨æ·»åŠ å…¨å±€ä¸­é—´ä»¶åè°ƒç”¨ï¼‰ */\n  precompileAll(globalMiddleware: Middleware[]): void {\n    if (!this.compiler) return;\n    this.precompileNode(this.root, globalMiddleware);\n  }\n\n  private precompileNode(\n    node: RadixNode,\n    globalMiddleware: Middleware[],\n  ): void {\n    for (const method in node.handlers) {\n      const routeHandler = node.handlers[method as Method];\n      if (routeHandler) {\n        const allMiddleware = [...globalMiddleware, ...routeHandler.middleware];\n        routeHandler.compiled = this.compiler!(\n          allMiddleware,\n          routeHandler.handler,\n        );\n      }\n    }\n\n    for (const key in node.children) {\n      this.precompileNode(node.children[key], globalMiddleware);\n    }\n\n    if (node.paramChild) {\n      this.precompileNode(node.paramChild, globalMiddleware);\n    }\n\n    if (node.wildcardChild) {\n      this.precompileNode(node.wildcardChild, globalMiddleware);\n    }\n  }\n\n  /** åŒ¹é…è·¯ç”± */\n  match(method: Method, path: string): MatchResult | null {\n    const segments = this.splitPath(path);\n    const params: Record<string, string> = Object.create(null);\n\n    const node = this.matchNode(this.root, segments, 0, params);\n    if (!node) return null;\n\n    const routeHandler = node.handlers[method];\n    if (!routeHandler) return null;\n\n    return {\n      handler: routeHandler.handler,\n      middleware: routeHandler.middleware,\n      params,\n      compiled: routeHandler.compiled,\n    };\n  }\n\n  /** é€’å½’åŒ¹é…èŠ‚ç‚¹ (ä¼˜å…ˆçº§: é™æ€ > åŠ¨æ€å‚æ•° > é€šé…ç¬¦) */\n  private matchNode(\n    node: RadixNode,\n    segments: string[],\n    index: number,\n    params: Record<string, string>,\n  ): RadixNode | null {\n    if (index === segments.length) {\n      for (const method in node.handlers) {\n        if (node.handlers[method as Method]) return node;\n      }\n      return null;\n    }\n\n    const segment = segments[index];\n\n    // 1. é™æ€è·¯å¾„\n    const staticChild = node.children[segment];\n    if (staticChild) {\n      const result = this.matchNode(staticChild, segments, index + 1, params);\n      if (result) return result;\n    }\n\n    // 2. åŠ¨æ€å‚æ•°\n    if (node.paramChild) {\n      const paramName = node.paramChild.paramName!;\n      const oldValue = params[paramName];\n\n      params[paramName] = segment;\n      const result = this.matchNode(\n        node.paramChild,\n        segments,\n        index + 1,\n        params,\n      );\n\n      if (result) return result;\n\n      // å›æº¯\n      if (oldValue === undefined) {\n        delete params[paramName];\n      } else {\n        params[paramName] = oldValue;\n      }\n    }\n\n    // 3. é€šé…ç¬¦\n    if (node.wildcardChild) {\n      params[node.wildcardChild.paramName || \"*\"] = segments\n        .slice(index)\n        .join(\"/\");\n      return node.wildcardChild;\n    }\n\n    return null;\n  }\n\n  /** è·å–è·¯å¾„å…è®¸çš„ HTTP æ–¹æ³• */\n  getAllowedMethods(path: string): Method[] {\n    const segments = this.splitPath(path);\n    const node = this.findNode(segments);\n    if (!node) return [];\n\n    const methods: Method[] = [];\n    for (const method in node.handlers) {\n      if (node.handlers[method as Method]) {\n        methods.push(method as Method);\n      }\n    }\n    return methods;\n  }\n\n  /** æŸ¥æ‰¾èŠ‚ç‚¹ï¼ˆä¸æå–å‚æ•°ï¼‰ */\n  private findNode(segments: string[]): RadixNode | null {\n    let node = this.root;\n\n    for (const segment of segments) {\n      if (node.children[segment]) {\n        node = node.children[segment];\n      } else if (node.paramChild) {\n        node = node.paramChild;\n      } else if (node.wildcardChild) {\n        return node.wildcardChild;\n      } else {\n        return null;\n      }\n    }\n\n    return node;\n  }\n\n  /** è·å–æ‰€æœ‰å·²æ³¨å†Œçš„è·¯ç”± */\n  getRoutes(): Array<{ method: Method; path: string }> {\n    const routes: Array<{ method: Method; path: string }> = [];\n    this.collectRoutes(this.root, \"\", routes);\n    return routes;\n  }\n\n  private collectRoutes(\n    node: RadixNode,\n    prefix: string,\n    routes: Array<{ method: Method; path: string }>,\n  ): void {\n    const currentPath = prefix + (node.path ? \"/\" + node.path : \"\");\n\n    for (const method in node.handlers) {\n      if (node.handlers[method as Method]) {\n        routes.push({ method: method as Method, path: currentPath || \"/\" });\n      }\n    }\n\n    for (const key in node.children) {\n      this.collectRoutes(node.children[key], currentPath, routes);\n    }\n\n    if (node.paramChild) {\n      this.collectRoutes(node.paramChild, currentPath, routes);\n    }\n\n    if (node.wildcardChild) {\n      this.collectRoutes(node.wildcardChild, currentPath, routes);\n    }\n  }\n}\n","/**\n * è·¯ç”±æ³¨å†Œè¡¨\n *\n * æä¾›è·¯ç”±å…ƒä¿¡æ¯çš„æ”¶é›†å’ŒæŸ¥è¯¢èƒ½åŠ›\n * å¯ç”¨äºï¼šAPI æ–‡æ¡£ç”Ÿæˆã€Webhook äº‹ä»¶æ³¨å†Œã€æƒé™æ£€æŸ¥ã€å®¡è®¡æ—¥å¿—ç­‰\n *\n * @example\n * ```typescript\n * // åˆ›å»ºæ³¨å†Œè¡¨\n * const registry = createRouteRegistry(server.getRoutes())\n *\n * // æŸ¥è¯¢è·¯ç”±\n * const route = registry.get('POST', '/auth/signIn')\n *\n * // ç­›é€‰æœ‰ webhook é…ç½®çš„è·¯ç”±\n * const webhookRoutes = registry.filter('webhook')\n *\n * // æŒ‰åˆ†ç±»è·å–\n * const authRoutes = registry.getByCategory('auth')\n * ```\n */\n\nimport type { FlattenedRoute, Method } from '../types'\n\n/**\n * è·¯ç”±å…ƒä¿¡æ¯ï¼ˆä¸å« handler å’Œ middlewareï¼‰\n */\nexport interface RouteMeta {\n  method: Method\n  path: string\n  fullPath: string\n  name?: string\n  description?: string\n  /** æ‰©å±•å­—æ®µ */\n  [key: string]: unknown\n}\n\n/**\n * è·¯ç”±æ³¨å†Œè¡¨\n *\n * æ³›å‹ T ç”¨äºå®šä¹‰æ‰©å±•å­—æ®µçš„ç±»å‹\n */\nexport class RouteRegistry<T extends Record<string, unknown> = Record<string, unknown>> {\n  /** æ‰€æœ‰è·¯ç”±å…ƒä¿¡æ¯ */\n  private routes: RouteMeta[] = []\n\n  /** è·¯ç”±æ˜ å°„è¡¨ï¼šMETHOD:fullPath -> RouteMeta */\n  private routeMap = new Map<string, RouteMeta>()\n\n  /** åˆ†ç±»æ˜ å°„è¡¨ï¼šcategory -> RouteMeta[] */\n  private categoryMap = new Map<string, RouteMeta[]>()\n\n  constructor(routes: FlattenedRoute[]) {\n    this.buildRegistry(routes)\n  }\n\n  /**\n   * æ„å»ºæ³¨å†Œè¡¨\n   */\n  private buildRegistry(routes: FlattenedRoute[]): void {\n    for (const route of routes) {\n      // æå–å…ƒä¿¡æ¯ï¼ˆæ’é™¤ handler å’Œ middlewareï¼‰\n      const meta: RouteMeta = {\n        method: route.method,\n        path: route.path,\n        fullPath: route.fullPath,\n        name: route.name,\n        description: route.description,\n      }\n\n      // å¤åˆ¶æ‰©å±•å­—æ®µ\n      for (const key of Object.keys(route)) {\n        if (!['method', 'path', 'fullPath', 'name', 'description', 'handler', 'middleware', 'middlewareChain'].includes(key)) {\n          meta[key] = route[key as keyof FlattenedRoute]\n        }\n      }\n\n      this.routes.push(meta)\n      this.routeMap.set(`${route.method}:${route.fullPath}`, meta)\n\n      // æŒ‰åˆ†ç±»ç´¢å¼•\n      const category = this.extractCategory(route.fullPath)\n      if (!this.categoryMap.has(category)) {\n        this.categoryMap.set(category, [])\n      }\n      this.categoryMap.get(category)!.push(meta)\n    }\n  }\n\n  /**\n   * æå–åˆ†ç±»ï¼ˆç¬¬ä¸€æ®µè·¯å¾„ï¼‰\n   */\n  private extractCategory(path: string): string {\n    const segments = path.split('/').filter(Boolean)\n    return segments[0] || 'root'\n  }\n\n  // ============================================\n  // æŸ¥è¯¢æ¥å£\n  // ============================================\n\n  /**\n   * è·å–æ‰€æœ‰è·¯ç”±å…ƒä¿¡æ¯\n   */\n  getAll(): RouteMeta[] {\n    return [...this.routes]\n  }\n\n  /**\n   * æŒ‰ method + path æŸ¥è¯¢è·¯ç”±\n   */\n  get(method: string, path: string): (RouteMeta & T) | undefined {\n    return this.routeMap.get(`${method}:${path}`) as (RouteMeta & T) | undefined\n  }\n\n  /**\n   * æ£€æŸ¥è·¯ç”±æ˜¯å¦å­˜åœ¨\n   */\n  has(method: string, path: string): boolean {\n    return this.routeMap.has(`${method}:${path}`)\n  }\n\n  /**\n   * æŒ‰åˆ†ç±»è·å–è·¯ç”±\n   */\n  getByCategory(category: string): RouteMeta[] {\n    return this.categoryMap.get(category) || []\n  }\n\n  /**\n   * è·å–æ‰€æœ‰åˆ†ç±»\n   */\n  getCategories(): string[] {\n    return Array.from(this.categoryMap.keys()).sort()\n  }\n\n  /**\n   * ç­›é€‰æœ‰ç‰¹å®šå­—æ®µçš„è·¯ç”±\n   *\n   * @example\n   * ```typescript\n   * // è·å–æ‰€æœ‰é…ç½®äº† webhook çš„è·¯ç”±\n   * const webhookRoutes = registry.filter('webhook')\n   * ```\n   */\n  filter<K extends string>(field: K): (RouteMeta & Record<K, unknown>)[] {\n    return this.routes.filter((r) => field in r && r[field] !== undefined) as (RouteMeta & Record<K, unknown>)[]\n  }\n\n  /**\n   * æŒ‰æ¡ä»¶ç­›é€‰è·¯ç”±\n   *\n   * @example\n   * ```typescript\n   * // è·å–æ‰€æœ‰ POST è¯·æ±‚\n   * const postRoutes = registry.filterBy(r => r.method === 'POST')\n   * ```\n   */\n  filterBy(predicate: (route: RouteMeta) => boolean): RouteMeta[] {\n    return this.routes.filter(predicate)\n  }\n\n  /**\n   * è·å–è·¯ç”±æ•°é‡\n   */\n  get size(): number {\n    return this.routes.length\n  }\n\n  /**\n   * éå†æ‰€æœ‰è·¯ç”±\n   */\n  forEach(callback: (route: RouteMeta, index: number) => void): void {\n    this.routes.forEach(callback)\n  }\n\n  /**\n   * æ˜ å°„æ‰€æœ‰è·¯ç”±\n   */\n  map<R>(callback: (route: RouteMeta, index: number) => R): R[] {\n    return this.routes.map(callback)\n  }\n}\n\n/**\n * åˆ›å»ºè·¯ç”±æ³¨å†Œè¡¨\n *\n * @example\n * ```typescript\n * // å®šä¹‰æ‰©å±•å­—æ®µç±»å‹\n * interface MyRouteMeta {\n *   webhook?: { eventKey: string }\n *   permission?: string\n * }\n *\n * // åˆ›å»ºå¸¦ç±»å‹çš„æ³¨å†Œè¡¨\n * const registry = createRouteRegistry<MyRouteMeta>(server.getRoutes())\n *\n * // ç±»å‹å®‰å…¨çš„æŸ¥è¯¢\n * const route = registry.get('POST', '/auth/signIn')\n * if (route?.webhook) {\n *   console.log(route.webhook.eventKey)\n * }\n * ```\n */\nexport function createRouteRegistry<T extends Record<string, unknown> = Record<string, unknown>>(\n  routes: FlattenedRoute[]\n): RouteRegistry<T> {\n  return new RouteRegistry<T>(routes)\n}\n\n// ============================================\n// å…¨å±€ Registryï¼ˆå•ä¾‹æ¨¡å¼ï¼‰\n// ============================================\n\n/** å…¨å±€ registry å®ä¾‹ */\nlet globalRegistry: RouteRegistry | null = null\n\n/**\n * è®¾ç½®å…¨å±€ registryï¼ˆæ¡†æ¶å†…éƒ¨ä½¿ç”¨ï¼‰\n * @internal\n */\nexport function setGlobalRegistry(registry: RouteRegistry): void {\n  globalRegistry = registry\n}\n\n/**\n * è·å–å…¨å±€è·¯ç”±æ³¨å†Œè¡¨\n *\n * @example\n * ```typescript\n * // åœ¨ä»»æ„æ–‡ä»¶ä¸­\n * import { getRouteRegistry } from 'vafast'\n *\n * const registry = getRouteRegistry()\n * const webhookRoutes = registry.filter('webhook')\n * ```\n *\n * @throws å¦‚æœ Server å°šæœªåˆ›å»º\n */\nexport function getRouteRegistry<T extends Record<string, unknown> = Record<string, unknown>>(): RouteRegistry<T> {\n  if (!globalRegistry) {\n    throw new Error('RouteRegistry not initialized. Make sure Server is created first.')\n  }\n  return globalRegistry as RouteRegistry<T>\n}\n\n/**\n * æŒ‰ method + path è·å–å•ä¸ªè·¯ç”±\n *\n * ä¾¿æ·å‡½æ•°ï¼Œæ— éœ€å…ˆè·å– registry\n *\n * @example\n * ```typescript\n * // åœ¨ä¸­é—´ä»¶æˆ–æ¥å£ä¸­\n * import { getRoute } from 'vafast'\n *\n * const route = getRoute('POST', '/auth/signIn')\n * if (route?.webhook) {\n *   console.log('This route has webhook:', route.webhook)\n * }\n * ```\n */\nexport function getRoute<T extends Record<string, unknown> = Record<string, unknown>>(\n  method: string,\n  path: string\n): (RouteMeta & T) | undefined {\n  return getRouteRegistry<T>().get(method, path)\n}\n\n/**\n * è·å–æ‰€æœ‰è·¯ç”±\n *\n * @example\n * ```typescript\n * import { getAllRoutes } from 'vafast'\n *\n * const routes = getAllRoutes()\n * console.log(`Total ${routes.length} routes`)\n * ```\n */\nexport function getAllRoutes(): RouteMeta[] {\n  return getRouteRegistry().getAll()\n}\n\n/**\n * ç­›é€‰æœ‰ç‰¹å®šå­—æ®µçš„è·¯ç”±\n *\n * @example\n * ```typescript\n * import { filterRoutes } from 'vafast'\n *\n * // è·å–æ‰€æœ‰é…ç½®äº† webhook çš„è·¯ç”±\n * const webhookRoutes = filterRoutes('webhook')\n * ```\n */\nexport function filterRoutes<K extends string>(field: K): (RouteMeta & Record<K, unknown>)[] {\n  return getRouteRegistry().filter(field)\n}\n\n","/**\n * Vafast æ ¸å¿ƒæœåŠ¡å™¨\n *\n * åŸºäº Radix Tree çš„é«˜æ€§èƒ½è·¯ç”±åŒ¹é…\n * æ—¶é—´å¤æ‚åº¦: O(k)ï¼Œk ä¸ºè·¯å¾„æ®µæ•°\n */\n\nimport type { Route, NestedRoute, FlattenedRoute, Method } from \"../types\";\nimport { flattenNestedRoutes } from \"../router\";\nimport { composeMiddleware } from \"../middleware\";\nimport { json } from \"../utils/response\";\nimport { BaseServer } from \"./base-server\";\nimport { RadixRouter } from \"../router/radix-tree\";\nimport { RouteRegistry, setGlobalRegistry } from \"../utils/route-registry\";\n\n/**\n * Vafast æœåŠ¡å™¨\n *\n * @example\n * ```typescript\n * const server = new Server([\n *   { method: \"GET\", path: \"/\", handler: () => new Response(\"Hello\") },\n * ]);\n * export default { fetch: server.fetch };\n * ```\n */\nexport class Server extends BaseServer {\n  private router: RadixRouter;\n  private routes: FlattenedRoute[];\n  /** æ˜¯å¦å·²é¢„ç¼–è¯‘ */\n  private isCompiled = false;\n  /** é¢„ç¼–è¯‘æ—¶çš„å…¨å±€ä¸­é—´ä»¶æ•°é‡ */\n  private compiledWithMiddlewareCount = 0;\n\n  constructor(routes: (Route | NestedRoute)[] = []) {\n    super();\n    this.router = new RadixRouter();\n    this.routes = [];\n\n    // è®¾ç½®ä¸­é—´ä»¶ç¼–è¯‘å™¨\n    this.router.setCompiler((middleware, handler) =>\n      composeMiddleware(middleware, handler),\n    );\n\n    if (routes.length > 0) {\n      this.registerRoutes(routes);\n    }\n  }\n\n  /**\n   * é¢„ç¼–è¯‘æ‰€æœ‰è·¯ç”±å¤„ç†é“¾\n   * åœ¨æ·»åŠ æ‰€æœ‰è·¯ç”±å’Œå…¨å±€ä¸­é—´ä»¶åè°ƒç”¨ï¼Œå¯æå‡è¿è¡Œæ—¶æ€§èƒ½\n   */\n  compile(): this {\n    this.router.precompileAll(this.globalMiddleware);\n    this.isCompiled = true;\n    this.compiledWithMiddlewareCount = this.globalMiddleware.length;\n    return this;\n  }\n\n  private registerRoutes(routes: (Route | NestedRoute)[]): void {\n    const flattened = flattenNestedRoutes(routes);\n    this.routes.push(...flattened);\n\n    for (const route of flattened) {\n      this.router.register(\n        route.method as Method,\n        route.fullPath,\n        route.handler,\n        route.middlewareChain || [],\n      );\n    }\n\n    this.detectRouteConflicts(flattened);\n    this.logFlattenedRoutes(flattened);\n\n    // è‡ªåŠ¨é¢„ç¼–è¯‘ï¼ˆå¦‚æœæ²¡æœ‰å…¨å±€ä¸­é—´ä»¶ï¼‰\n    if (this.globalMiddleware.length === 0 && !this.isCompiled) {\n      this.compile();\n    }\n\n    // è‡ªåŠ¨è®¾ç½®å…¨å±€ RouteRegistryï¼ˆæ”¯æŒåœ¨ä»»æ„ä½ç½®é€šè¿‡ getRouteRegistry() è®¿é—®ï¼‰\n    setGlobalRegistry(new RouteRegistry(this.routes));\n  }\n\n  /** å¿«é€Ÿæå– pathname */\n  private extractPathname(url: string): string {\n    let start = url.indexOf(\"://\");\n    start = start === -1 ? 0 : start + 3;\n\n    const pathStart = url.indexOf(\"/\", start);\n    if (pathStart === -1) return \"/\";\n\n    let end = url.indexOf(\"?\", pathStart);\n    if (end === -1) end = url.indexOf(\"#\", pathStart);\n    if (end === -1) end = url.length;\n\n    return url.substring(pathStart, end) || \"/\";\n  }\n\n  /** ç”Ÿæˆ 404/405 å“åº” */\n  private createErrorResponse(method: string, pathname: string): Response {\n    const allowedMethods = this.router.getAllowedMethods(pathname);\n    if (allowedMethods.length > 0) {\n      return json(\n        {\n          success: false,\n          error: \"Method Not Allowed\",\n          message: `Method ${method} not allowed for this endpoint`,\n          allowedMethods,\n        },\n        405,\n        { Allow: allowedMethods.join(\", \") },\n      );\n    }\n    return json({ success: false, error: \"Not Found\" }, 404);\n  }\n\n  /** å¤„ç†è¯·æ±‚ */\n  fetch = async (req: Request): Promise<Response> => {\n    const pathname = this.extractPathname(req.url);\n    const method = req.method as Method;\n\n    const match = this.router.match(method, pathname);\n\n    if (match) {\n      (req as unknown as Record<string, unknown>).params = match.params;\n\n      // ä¼˜å…ˆä½¿ç”¨é¢„ç¼–è¯‘çš„å¤„ç†é“¾ï¼ˆä»…å½“å…¨å±€ä¸­é—´ä»¶æœªå˜åŒ–æ—¶ï¼‰\n      if (\n        match.compiled &&\n        this.globalMiddleware.length === this.compiledWithMiddlewareCount\n      ) {\n        return match.compiled(req);\n      }\n\n      // å›é€€ï¼šè¿è¡Œæ—¶ç»„åˆä¸­é—´ä»¶\n      const allMiddleware = [...this.globalMiddleware, ...match.middleware];\n      const handler = composeMiddleware(allMiddleware, match.handler);\n\n      return handler(req);\n    }\n\n    // OPTIONS é¢„æ£€è¯·æ±‚ç‰¹æ®Šå¤„ç†ï¼šæŸ¥æ‰¾åŒè·¯å¾„å…¶ä»–æ–¹æ³•çš„è·¯ç”±ï¼Œä½¿ç”¨å…¶ä¸­é—´ä»¶\n    // è¿™å…è®¸è·¯ç”±çº§ CORS ä¸­é—´ä»¶æ­£å¸¸å·¥ä½œ\n    if (method === \"OPTIONS\") {\n      const allowedMethods = this.router.getAllowedMethods(pathname);\n      if (allowedMethods.length > 0) {\n        // å°è¯•è·å–è¯¥è·¯å¾„ä»»æ„æ–¹æ³•çš„è·¯ç”±ä¸­é—´ä»¶\n        const anyMatch = this.router.match(\n          allowedMethods[0] as Method,\n          pathname,\n        );\n        const routeMiddleware = anyMatch?.middleware || [];\n        const allMiddleware = [...this.globalMiddleware, ...routeMiddleware];\n\n        // OPTIONS è¯·æ±‚é»˜è®¤è¿”å› 204ï¼ˆä¸­é—´ä»¶å¦‚ CORS å¯èƒ½ä¼šæå‰å“åº”ï¼‰\n        const optionsHandler = () =>\n          new Response(null, {\n            status: 204,\n            headers: { Allow: allowedMethods.join(\", \") },\n          });\n\n        const handler = composeMiddleware(allMiddleware, optionsHandler);\n        return handler(req);\n      }\n    }\n\n    // æœªåŒ¹é…è·¯ç”±æ—¶ï¼Œä»æ‰§è¡Œå…¨å±€ä¸­é—´ä»¶ï¼ˆå¦‚ CORS å¤„ç† OPTIONS é¢„æ£€ï¼‰\n    if (this.globalMiddleware.length > 0) {\n      const handler = composeMiddleware(this.globalMiddleware, () =>\n        this.createErrorResponse(method, pathname),\n      );\n      return handler(req);\n    }\n\n    return this.createErrorResponse(method, pathname);\n  };\n\n  addRoute(route: Route): void {\n    const flattenedRoute: FlattenedRoute = {\n      ...route,\n      fullPath: route.path,\n      middlewareChain: route.middleware || [],\n    };\n\n    this.routes.push(flattenedRoute);\n    this.router.register(\n      route.method as Method,\n      route.path,\n      route.handler,\n      route.middleware || [],\n    );\n  }\n\n  addRoutes(routes: (Route | NestedRoute)[]): void {\n    this.registerRoutes(routes);\n  }\n\n  getRoutes(): Array<{ method: Method; path: string }> {\n    return this.router.getRoutes();\n  }\n\n  /**\n   * è·å–å®Œæ•´çš„è·¯ç”±å…ƒä¿¡æ¯ï¼ˆä¸å« handler å’Œ middlewareï¼‰\n   *\n   * ç”¨äº API æ–‡æ¡£ç”Ÿæˆã€Webhook äº‹ä»¶æ³¨å†Œã€æƒé™æ£€æŸ¥ç­‰åœºæ™¯\n   *\n   * @example\n   * ```typescript\n   * const routes = server.getRoutesWithMeta()\n   * for (const route of routes) {\n   *   console.log(route.fullPath, route.name, route.description)\n   * }\n   * ```\n   */\n  getRoutesWithMeta(): FlattenedRoute[] {\n    return this.routes;\n  }\n}\n","import type {\n  ComponentRoute,\n  NestedComponentRoute,\n  FlattenedComponentRoute,\n} from \"../types/component-route\";\nimport { vueRenderer, reactRenderer } from \"./component-renderer\";\n\n/**\n * æ‰å¹³åŒ–åµŒå¥—ç»„ä»¶è·¯ç”±\n */\nexport function flattenComponentRoutes(\n  routes: (ComponentRoute | NestedComponentRoute)[],\n): FlattenedComponentRoute[] {\n  const flattened: FlattenedComponentRoute[] = [];\n\n  function processRoute(\n    route: ComponentRoute | NestedComponentRoute,\n    parentPath: string = \"\",\n    parentMiddleware: any[] = [],\n  ) {\n    const currentPath = parentPath + route.path;\n    const currentMiddleware = [\n      ...parentMiddleware,\n      ...(route.middleware || []),\n    ];\n\n    if (\"component\" in route) {\n      // è¿™æ˜¯ä¸€ä¸ªç»„ä»¶è·¯ç”±\n      flattened.push({\n        ...route,\n        fullPath: currentPath,\n        middlewareChain: currentMiddleware,\n      });\n    } else if (\"children\" in route && route.children) {\n      // è¿™æ˜¯ä¸€ä¸ªåµŒå¥—è·¯ç”±\n      for (const child of route.children) {\n        processRoute(child, currentPath, currentMiddleware);\n      }\n    }\n  }\n\n  for (const route of routes) {\n    processRoute(route);\n  }\n\n  return flattened;\n}\n\n/**\n * ç»„ä»¶è·¯ç”±å¤„ç†å™¨ä¸­é—´ä»¶\n * è‡ªåŠ¨æ£€æµ‹ç»„ä»¶ç±»å‹å¹¶åº”ç”¨ç›¸åº”çš„æ¸²æŸ“å™¨\n */\nexport const componentRouter = () => {\n  return async (req: Request, next: () => Promise<Response>) => {\n    // è¿™é‡Œå¯ä»¥æ·»åŠ ç»„ä»¶è·¯ç”±çš„è‡ªåŠ¨å¤„ç†é€»è¾‘\n    // æ¯”å¦‚è‡ªåŠ¨æ£€æµ‹ç»„ä»¶ç±»å‹ï¼Œåº”ç”¨ç›¸åº”çš„æ¸²æŸ“å™¨\n    return next();\n  };\n};\n","/**\n * è·¯å¾„åŒ¹é…å·¥å…·ç±»\n * æä¾›ç»Ÿä¸€çš„è·¯å¾„åŒ¹é…å’Œå‚æ•°æå–åŠŸèƒ½\n */\nexport class PathMatcher {\n  /**\n   * è·¯å¾„åŒ¹é…\n   */\n  static matchPath(pattern: string, path: string): boolean {\n    const patternParts = pattern.split(\"/\").filter(Boolean);\n    const pathParts = path.split(\"/\").filter(Boolean);\n\n    if (patternParts.length !== pathParts.length) {\n      return false;\n    }\n\n    for (let i = 0; i < patternParts.length; i++) {\n      if (\n        patternParts[i] !== pathParts[i] &&\n        !patternParts[i].startsWith(\":\")\n      ) {\n        return false;\n      }\n    }\n\n    return true;\n  }\n\n  /**\n   * æå–è·¯å¾„å‚æ•°\n   */\n  static extractParams(pattern: string, path: string): Record<string, string> {\n    const params: Record<string, string> = {};\n    const patternParts = pattern.split(\"/\").filter(Boolean);\n    const pathParts = path.split(\"/\").filter(Boolean);\n\n    for (let i = 0; i < patternParts.length; i++) {\n      if (patternParts[i].startsWith(\":\")) {\n        const paramName = patternParts[i].slice(1);\n        params[paramName] = pathParts[i];\n      }\n    }\n\n    return params;\n  }\n\n  /**\n   * è®¡ç®—è·¯å¾„ç‰¹å¼‚æ€§åˆ†æ•°\n   * ç”¨äºè·¯ç”±æ’åºï¼šé™æ€ > åŠ¨æ€(:param) > é€šé…ç¬¦(*)\n   */\n  static calculatePathScore(path: string): number {\n    const parts = path.split(\"/\").filter(Boolean);\n    let score = 0;\n    for (const p of parts) {\n      if (p === \"*\")\n        score += 1; // æœ€å¼±\n      else if (p.startsWith(\":\"))\n        score += 2; // ä¸­ç­‰\n      else score += 3; // é™æ€æœ€å¼º\n    }\n    // æ›´é•¿çš„è·¯å¾„æ›´å…·ä½“ï¼Œç•¥å¾®æå‡\n    return score * 10 + parts.length;\n  }\n\n  /**\n   * åˆ¤æ–­ä¸¤ä¸ªè·¯å¾„æ˜¯å¦å¯èƒ½å†²çª\n   */\n  static pathsMayConflict(path1: string, path2: string): boolean {\n    const parts1 = path1.split(\"/\").filter(Boolean);\n    const parts2 = path2.split(\"/\").filter(Boolean);\n\n    if (parts1.length !== parts2.length) return false;\n\n    for (let i = 0; i < parts1.length; i++) {\n      const p1 = parts1[i];\n      const p2 = parts2[i];\n\n      // å¦‚æœä¸¤ä¸ªéƒ¨åˆ†éƒ½æ˜¯é™æ€çš„ä¸”ä¸åŒï¼Œåˆ™ä¸ä¼šå†²çª\n      if (\n        !p1.startsWith(\":\") &&\n        !p1.startsWith(\"*\") &&\n        !p2.startsWith(\":\") &&\n        !p2.startsWith(\"*\") &&\n        p1 !== p2\n      ) {\n        return false;\n      }\n\n      // å¦‚æœä¸€ä¸ªæ˜¯é€šé…ç¬¦ï¼Œå¦ä¸€ä¸ªæ˜¯åŠ¨æ€å‚æ•°ï¼Œå¯èƒ½å†²çª\n      if (\n        (p1 === \"*\" && p2.startsWith(\":\")) ||\n        (p2 === \"*\" && p1.startsWith(\":\"))\n      ) {\n        return true;\n      }\n    }\n\n    return false;\n  }\n}\n","/**\n * HTMLæ¸²æŸ“å·¥å…·ç±»\n * æä¾›ç»Ÿä¸€çš„HTMLæ¨¡æ¿ç”ŸæˆåŠŸèƒ½\n */\nexport class HtmlRenderer {\n  /**\n   * ç”ŸæˆåŸºç¡€HTMLæ¨¡æ¿\n   */\n  static generateBaseHtml(\n    content: string,\n    context: any,\n    clientScriptPath: string = \"/client.js\",\n  ): string {\n    return `\n      <!doctype html>\n      <html>\n        <head>\n          <meta charset=\"utf-8\">\n          <title>Vafast SSR App</title>\n          <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">\n        </head>\n        <body>\n          <div id=\"app\">${content}</div>\n          <script>\n            window.__ROUTE_INFO__ = {\n              params: ${JSON.stringify(context.params || {})},\n              query: ${JSON.stringify(context.query || {})},\n              pathname: '${context.pathname}'\n            };\n          </script>\n          <script type=\"module\" src=\"${clientScriptPath}\"></script>\n        </body>\n      </html>\n    `;\n  }\n\n  /**\n   * ç”ŸæˆVueç»„ä»¶HTML\n   */\n  static generateVueHtml(\n    content: string,\n    context: any,\n    clientScriptPath: string = \"/client.js\",\n  ): string {\n    return this.generateBaseHtml(content, context, clientScriptPath);\n  }\n\n  /**\n   * ç”ŸæˆReactç»„ä»¶HTML\n   */\n  static generateReactHtml(\n    content: string,\n    context: any,\n    clientScriptPath: string = \"/client.js\",\n  ): string {\n    return `\n      <!doctype html>\n      <html>\n        <head>\n          <meta charset=\"utf-8\">\n          <title>Vafast SSR App</title>\n          <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">\n        </head>\n        <body>\n          <div id=\"root\">${content}</div>\n          <script>\n            window.__ROUTE_INFO__ = {\n              params: ${JSON.stringify(context.params || {})},\n              query: ${JSON.stringify(context.query || {})},\n              pathname: '${context.pathname}'\n            };\n          </script>\n          <script type=\"module\" src=\"${clientScriptPath}\"></script>\n        </body>\n      </html>\n    `;\n  }\n}\n","/**\n * ä¾èµ–ç®¡ç†å™¨\n * è´Ÿè´£æŒ‰éœ€åŠ è½½å’Œç®¡ç†æ¡†æ¶ä¾èµ–\n */\nexport class DependencyManager {\n  private dependencyCache = new Map<string, any>();\n\n  /**\n   * æŒ‰éœ€è·å–æ¡†æ¶ä¾èµ–\n   */\n  async getFrameworkDeps(framework: \"vue\" | \"react\") {\n    if (this.dependencyCache.has(framework)) {\n      return this.dependencyCache.get(framework);\n    }\n\n    console.log(`ğŸ“¦ æŒ‰éœ€åŠ è½½ ${framework} ä¾èµ–...`);\n\n    try {\n      let deps;\n      switch (framework) {\n        case \"vue\":\n          deps = await Promise.all([\n            import(\"vue\"),\n            import(\"@vue/server-renderer\"),\n          ]);\n          break;\n        case \"react\":\n          deps = await Promise.all([\n            import(\"react\"),\n            import(\"react-dom/server\"),\n          ]);\n          break;\n        default:\n          throw new Error(`ä¸æ”¯æŒçš„æ¡†æ¶: ${framework}`);\n      }\n\n      this.dependencyCache.set(framework, deps);\n      console.log(`âœ… ${framework} ä¾èµ–åŠ è½½å®Œæˆ`);\n      return deps;\n    } catch (error) {\n      console.error(`âŒ ${framework} ä¾èµ–åŠ è½½å¤±è´¥:`, error);\n      throw error;\n    }\n  }\n\n  /**\n   * æ£€æµ‹ç»„ä»¶ç±»å‹\n   */\n  detectComponentType(component: any): \"vue\" | \"react\" {\n    // ç®€å•çš„ç»„ä»¶ç±»å‹æ£€æµ‹\n    if (component.render && typeof component.render === \"function\") {\n      return \"vue\";\n    }\n    if (component.$$typeof) {\n      return \"react\";\n    }\n    // é»˜è®¤ä½¿ç”¨ Vue\n    return \"vue\";\n  }\n\n  /**\n   * æ¸…é™¤ç¼“å­˜\n   */\n  clearCache(): void {\n    this.dependencyCache.clear();\n    console.log(\"ğŸ§¹ ä¾èµ–ç¼“å­˜å·²æ¸…é™¤\");\n  }\n\n  /**\n   * è·å–ç¼“å­˜çŠ¶æ€\n   */\n  getCacheStatus(): Record<string, boolean> {\n    const status: Record<string, boolean> = {};\n    for (const [framework] of this.dependencyCache) {\n      status[framework] = true;\n    }\n    return status;\n  }\n}\n","import type {\n  ComponentRoute,\n  NestedComponentRoute,\n  FlattenedComponentRoute,\n} from \"../types/component-route\";\nimport { flattenComponentRoutes } from \"../middleware/component-router\";\nimport { BaseServer } from \"./base-server\";\nimport { PathMatcher } from \"../utils/path-matcher\";\nimport { HtmlRenderer } from \"../utils/html-renderer\";\nimport { DependencyManager } from \"../utils/dependency-manager\";\n\n/**\n * ç»„ä»¶è·¯ç”±æœåŠ¡å™¨\n * ä¸“é—¨å¤„ç†å£°æ˜å¼ç»„ä»¶è·¯ç”±\n */\nexport class ComponentServer extends BaseServer {\n  private routes: FlattenedComponentRoute[];\n  private dependencyManager: DependencyManager;\n\n  constructor(routes: (ComponentRoute | NestedComponentRoute)[]) {\n    super();\n    this.routes = flattenComponentRoutes(routes);\n    this.dependencyManager = new DependencyManager();\n\n    // æ£€æµ‹è·¯ç”±å†²çª\n    this.detectRouteConflicts(this.routes);\n    this.logFlattenedRoutes(this.routes, \"ç»„ä»¶è·¯ç”±\");\n    console.log(\"ğŸš€ ä¾èµ–æŒ‰éœ€åŠ è½½ï¼ŒæœåŠ¡å™¨å¯åŠ¨å®Œæˆ\");\n  }\n\n  /**\n   * å¤„ç†è¯·æ±‚\n   */\n  async fetch(req: Request): Promise<Response> {\n    const url = new URL(req.url);\n    const pathname = url.pathname;\n    const method = req.method;\n\n    // åªæ”¯æŒ GET è¯·æ±‚\n    if (method !== \"GET\") {\n      return new Response(\"Method Not Allowed\", { status: 405 });\n    }\n\n    // æŸ¥æ‰¾åŒ¹é…çš„è·¯ç”±\n    let matchedRoute: FlattenedComponentRoute | null = null;\n    for (const route of this.routes) {\n      if (PathMatcher.matchPath(route.fullPath, pathname)) {\n        matchedRoute = route;\n        break;\n      }\n    }\n\n    if (!matchedRoute) {\n      return new Response(\"Not Found\", { status: 404 });\n    }\n\n    try {\n      // åˆ›å»ºä¸­é—´ä»¶ä¸Šä¸‹æ–‡\n      const context = {\n        req,\n        params: PathMatcher.extractParams(matchedRoute.fullPath, pathname),\n        query: Object.fromEntries(url.searchParams),\n        pathname,\n      };\n\n      // æ‰§è¡Œä¸­é—´ä»¶é“¾ï¼Œä¸­é—´ä»¶ä¼šå¤„ç†ç»„ä»¶æ¸²æŸ“\n      return await this.executeMiddlewareChain(\n        matchedRoute.middlewareChain,\n        context,\n        matchedRoute.component,\n      );\n    } catch (error) {\n      console.error(\"ç»„ä»¶æ¸²æŸ“å¤±è´¥:\", error);\n      return new Response(\"Internal Server Error\", { status: 500 });\n    }\n  }\n\n  /**\n   * æ‰§è¡Œä¸­é—´ä»¶é“¾\n   */\n  private async executeMiddlewareChain(\n    middlewareChain: any[],\n    context: any,\n    componentImport: () => Promise<any>,\n  ): Promise<Response> {\n    // åˆ›å»ºæœ€ç»ˆçš„æ¸²æŸ“å‡½æ•°\n    const renderComponent = async () => {\n      const componentModule = await componentImport();\n      const component = componentModule.default || componentModule;\n\n      // è‡ªåŠ¨æ£€æµ‹ç»„ä»¶ç±»å‹\n      const componentType =\n        this.dependencyManager.detectComponentType(component);\n\n      // æŒ‰éœ€åŠ è½½ä¾èµ–\n      const deps = await this.dependencyManager.getFrameworkDeps(componentType);\n\n      // æ ¹æ®ç»„ä»¶ç±»å‹æ¸²æŸ“\n      if (componentType === \"vue\") {\n        return await this.renderVueComponent(component, context, deps);\n      } else if (componentType === \"react\") {\n        return await this.renderReactComponent(component, context, deps);\n      } else {\n        throw new Error(`ä¸æ”¯æŒçš„ç»„ä»¶ç±»å‹: ${componentType}`);\n      }\n    };\n\n    // æ‰§è¡Œä¸­é—´ä»¶é“¾\n    let index = 0;\n    const next = async (): Promise<Response> => {\n      if (index >= middlewareChain.length) {\n        return await renderComponent();\n      }\n\n      const middleware = middlewareChain[index++];\n      return await middleware(context.req, next);\n    };\n\n    return await next();\n  }\n\n  /**\n   * æ¸²æŸ“ Vue ç»„ä»¶\n   */\n  private async renderVueComponent(\n    component: any,\n    context: any,\n    deps: any,\n  ): Promise<Response> {\n    try {\n      const [vue, renderer] = deps;\n      const app = vue.createSSRApp(component);\n\n      // æä¾›è·¯ç”±ä¿¡æ¯\n      app.provide(\"routeInfo\", {\n        params: context.params || {},\n        query: context.query || {},\n        pathname: context.pathname,\n      });\n\n      const html = await renderer.renderToString(app);\n      const fullHtml = HtmlRenderer.generateVueHtml(html, context);\n\n      return new Response(fullHtml, {\n        headers: { \"Content-Type\": \"text/html; charset=utf-8\" },\n      });\n    } catch (error) {\n      console.error(\"Vue ç»„ä»¶æ¸²æŸ“å¤±è´¥:\", error);\n      return new Response(\"Vue Component Render Error\", { status: 500 });\n    }\n  }\n\n  /**\n   * æ¸²æŸ“ React ç»„ä»¶\n   */\n  private async renderReactComponent(\n    component: any,\n    context: any,\n    deps: any,\n  ): Promise<Response> {\n    try {\n      const [react, renderer] = deps;\n      const content = react.createElement(component, {\n        req: context.req,\n        params: context.params || {},\n        query: context.query || {},\n      });\n\n      const html = renderer.renderToString(content);\n      const fullHtml = HtmlRenderer.generateReactHtml(html, context);\n\n      return new Response(fullHtml, {\n        headers: { \"Content-Type\": \"text/html; charset=utf-8\" },\n      });\n    } catch (error) {\n      console.error(\"React ç»„ä»¶æ¸²æŸ“å¤±è´¥:\", error);\n      return new Response(\"React Component Render Error\", { status: 500 });\n    }\n  }\n\n  /**\n   * è·å–ä¾èµ–ç®¡ç†å™¨ï¼ˆç”¨äºå¤–éƒ¨è®¿é—®ï¼‰\n   */\n  getDependencyManager(): DependencyManager {\n    return this.dependencyManager;\n  }\n}\n","import type { Route, NestedRoute } from \"../types\";\nimport type {\n  ComponentRoute,\n  NestedComponentRoute,\n} from \"../types/component-route\";\nimport { Server } from \"../server\";\nimport { ComponentServer } from \"./component-server\";\n\n/**\n * æœåŠ¡å™¨å·¥å‚ç±»\n * ç”¨äºåˆ›å»ºå’Œç®¡ç†ä¸åŒç±»å‹çš„æœåŠ¡å™¨\n */\nexport class ServerFactory {\n  private servers: Map<string, Server | ComponentServer> = new Map();\n\n  /**\n   * åˆ›å»ºæ ‡å‡†REST APIæœåŠ¡å™¨\n   */\n  createRestServer(routes: (Route | NestedRoute)[]): Server {\n    const server = new Server(routes);\n    this.servers.set(\"rest\", server);\n    return server;\n  }\n\n  /**\n   * åˆ›å»ºç»„ä»¶æœåŠ¡å™¨\n   */\n  createComponentServer(\n    routes: (ComponentRoute | NestedComponentRoute)[],\n  ): ComponentServer {\n    const server = new ComponentServer(routes);\n    this.servers.set(\"component\", server);\n    return server;\n  }\n\n  /**\n   * è·å–æŒ‡å®šç±»å‹çš„æœåŠ¡å™¨\n   */\n  getServer(type: \"rest\" | \"component\"): Server | ComponentServer | undefined {\n    return this.servers.get(type);\n  }\n\n  /**\n   * è·å–æ‰€æœ‰æœåŠ¡å™¨\n   */\n  getAllServers(): Map<string, Server | ComponentServer> {\n    return this.servers;\n  }\n\n  /**\n   * ç§»é™¤æŒ‡å®šç±»å‹çš„æœåŠ¡å™¨\n   */\n  removeServer(type: string): boolean {\n    return this.servers.delete(type);\n  }\n\n  /**\n   * æ¸…é™¤æ‰€æœ‰æœåŠ¡å™¨\n   */\n  clearServers(): void {\n    this.servers.clear();\n  }\n\n  /**\n   * è·å–æœåŠ¡å™¨çŠ¶æ€ä¿¡æ¯\n   */\n  getServerStatus(): Record<string, { type: string; routes: number }> {\n    const status: Record<string, { type: string; routes: number }> = {};\n\n    for (const [name, server] of this.servers) {\n      if (server instanceof Server) {\n        status[name] = {\n          type: \"REST API\",\n          routes: (server as any).routes?.length || 0,\n        };\n      } else if (server instanceof ComponentServer) {\n        status[name] = {\n          type: \"Component\",\n          routes: (server as any).routes?.length || 0,\n        };\n      }\n    }\n\n    return status;\n  }\n}\n","/**\n * æœåŠ¡å™¨æ¨¡å—å¯¼å‡º\n */\n\n// ä¸»æœåŠ¡å™¨ç±»\nexport { Server } from \"./server\";\n\n// ç»„ä»¶æœåŠ¡å™¨ (SSR)\nexport { ComponentServer } from \"./component-server\";\n\n// æœåŠ¡å™¨å·¥å‚\nexport { ServerFactory } from \"./server-factory\";\n\n// åŸºç±» (ä»…ç”¨äºæ‰©å±•)\nexport { BaseServer } from \"./base-server\";\n","/**\n * åŸç”Ÿç›‘æ§è£…é¥°å™¨\n *\n * é€šè¿‡è£…é¥°å™¨æ¨¡å¼ä¸º Server æ·»åŠ ç›‘æ§èƒ½åŠ›ï¼Œå®Œå…¨ä¸å…¥ä¾µåŸç±»\n *\n * @author Framework Team\n * @version 2.0.0\n * @license MIT\n */\n\nimport type { Server } from \"../server\";\n\n// ç›‘æ§é…ç½®æ¥å£\nexport interface NativeMonitoringConfig {\n  enabled?: boolean;\n  console?: boolean;\n  slowThreshold?: number; // æ¯«ç§’\n  errorThreshold?: number;\n  tags?: Record<string, string>;\n}\n\n// ç›‘æ§æŒ‡æ ‡æ¥å£\nexport interface NativeMonitoringMetrics {\n  requestId: string;\n  method: string;\n  path: string;\n  statusCode: number;\n  totalTime: number;\n  timestamp: number;\n  memoryUsage: {\n    heapUsed: number;\n    heapTotal: number;\n  };\n}\n\n// å¸¦ç›‘æ§çš„ Server æ¥å£\nexport interface MonitoredServer extends Server {\n  // ç›‘æ§ç›¸å…³æ–¹æ³•\n  getMonitoringStatus(): any;\n  getMonitoringMetrics(): NativeMonitoringMetrics[];\n  resetMonitoring(): void;\n\n  // åŸå§‹æ–¹æ³•ä¿æŒä¸å˜\n  fetch: (req: Request) => Promise<Response>;\n  use: (mw: any) => void;\n}\n\n// åŸç”Ÿç›‘æ§å™¨\nclass NativeMonitor {\n  private config: NativeMonitoringConfig;\n  private metrics: NativeMonitoringMetrics[] = [];\n  private isEnabled = false;\n\n  constructor(config: NativeMonitoringConfig = {}) {\n    this.config = {\n      enabled: true,\n      console: true,\n      slowThreshold: 1000,\n      errorThreshold: 0.05,\n      tags: { framework: \"vafast\" },\n      ...config,\n    };\n\n    this.isEnabled = this.config.enabled ?? true;\n\n    if (this.isEnabled && this.config.console) {\n      console.log(\"âœ… åŸç”Ÿç›‘æ§å·²å¯ç”¨\");\n      console.log(`ğŸ“Š ç›‘æ§é…ç½®:`, {\n        æ…¢è¯·æ±‚é˜ˆå€¼: `${this.config.slowThreshold}ms`,\n        é”™è¯¯ç‡é˜ˆå€¼: `${(this.config.errorThreshold! * 100).toFixed(1)}%`,\n        æ ‡ç­¾: this.config.tags,\n      });\n    }\n  }\n\n  // è®°å½•ç›‘æ§æŒ‡æ ‡\n  recordMetrics(metrics: NativeMonitoringMetrics): void {\n    if (!this.isEnabled) return;\n\n    this.metrics.push(metrics);\n\n    // ä¿æŒæœ€è¿‘1000æ¡è®°å½•\n    if (this.metrics.length > 1000) {\n      this.metrics = this.metrics.slice(-1000);\n    }\n\n    // æ§åˆ¶å°è¾“å‡º\n    if (this.config.console) {\n      const status = metrics.statusCode < 400 ? \"âœ…\" : \"âŒ\";\n      const timeColor =\n        metrics.totalTime > this.config.slowThreshold! ? \"ğŸŒ\" : \"âš¡\";\n\n      console.log(\n        `${status} ${metrics.method} ${metrics.path} - ${\n          metrics.statusCode\n        } (${timeColor} ${metrics.totalTime.toFixed(2)}ms)`,\n      );\n\n      // æ…¢è¯·æ±‚è­¦å‘Š\n      if (metrics.totalTime > this.config.slowThreshold!) {\n        console.warn(\n          `ğŸŒ æ…¢è¯·æ±‚è­¦å‘Š: ${metrics.path} è€—æ—¶ ${metrics.totalTime.toFixed(\n            2,\n          )}ms`,\n        );\n      }\n    }\n  }\n\n  // è·å–ç›‘æ§çŠ¶æ€\n  getStatus() {\n    if (!this.isEnabled) {\n      return { enabled: false, message: \"ç›‘æ§æœªå¯ç”¨\" };\n    }\n\n    const totalRequests = this.metrics.length;\n    const successfulRequests = this.metrics.filter(\n      (m) => m.statusCode < 400,\n    ).length;\n    const failedRequests = totalRequests - successfulRequests;\n    const avgResponseTime =\n      totalRequests > 0\n        ? this.metrics.reduce((sum, m) => sum + m.totalTime, 0) / totalRequests\n        : 0;\n\n    return {\n      enabled: true,\n      totalRequests,\n      successfulRequests,\n      failedRequests,\n      errorRate: totalRequests > 0 ? failedRequests / totalRequests : 0,\n      avgResponseTime: avgResponseTime.toFixed(2) + \"ms\",\n      memoryUsage: this.getMemoryUsage(),\n      recentRequests: this.metrics.slice(-5),\n    };\n  }\n\n  // è·å–ç›‘æ§æŒ‡æ ‡\n  getMetrics() {\n    return this.metrics;\n  }\n\n  // é‡ç½®ç›‘æ§æ•°æ®\n  reset() {\n    this.metrics = [];\n    console.log(\"ğŸ”„ ç›‘æ§æ•°æ®å·²é‡ç½®\");\n  }\n\n  // è·å–å†…å­˜ä½¿ç”¨æƒ…å†µ\n  private getMemoryUsage() {\n    if (typeof process !== \"undefined\" && process.memoryUsage) {\n      const mem = process.memoryUsage();\n      return {\n        heapUsed: (mem.heapUsed / 1024 / 1024).toFixed(2) + \"MB\",\n        heapTotal: (mem.heapTotal / 1024 / 1024).toFixed(2) + \"MB\",\n        external: (mem.external / 1024 / 1024).toFixed(2) + \"MB\",\n      };\n    }\n    return { message: \"å†…å­˜ä¿¡æ¯ä¸å¯ç”¨\" };\n  }\n}\n\n// çº¯å‡½æ•°ï¼šä¸º Server æ·»åŠ ç›‘æ§èƒ½åŠ›\nexport function withMonitoring(\n  server: Server,\n  config: NativeMonitoringConfig = {},\n): MonitoredServer {\n  const monitor = new NativeMonitor(config);\n\n  // ä¿å­˜åŸå§‹çš„ fetch æ–¹æ³•\n  const originalFetch = server.fetch.bind(server);\n\n  // åˆ›å»ºå¸¦ç›‘æ§çš„ fetch æ–¹æ³•\n  const monitoredFetch = async (req: Request): Promise<Response> => {\n    const startTime = performance.now();\n    const requestId = `req_${Date.now()}_${Math.random()\n      .toString(36)\n      .substr(2, 9)}`;\n    const { pathname } = new URL(req.url);\n    const method = req.method;\n\n    try {\n      // è°ƒç”¨åŸå§‹ fetch\n      const response = await originalFetch(req);\n\n      // è®°å½•ç›‘æ§æŒ‡æ ‡\n      const totalTime = performance.now() - startTime;\n      monitor.recordMetrics({\n        requestId,\n        method,\n        path: pathname,\n        statusCode: response.status,\n        totalTime,\n        timestamp: Date.now(),\n        memoryUsage: (() => {\n          if (typeof process !== \"undefined\" && process.memoryUsage) {\n            const mem = process.memoryUsage();\n            return {\n              heapUsed: mem.heapUsed,\n              heapTotal: mem.heapTotal,\n            };\n          }\n          return { heapUsed: 0, heapTotal: 0 };\n        })(),\n      });\n\n      return response;\n    } catch (error) {\n      // è®°å½•é”™è¯¯ç›‘æ§æŒ‡æ ‡\n      const totalTime = performance.now() - startTime;\n      monitor.recordMetrics({\n        requestId,\n        method,\n        path: pathname,\n        statusCode: 500,\n        totalTime,\n        timestamp: Date.now(),\n        memoryUsage: (() => {\n          if (typeof process !== \"undefined\" && process.memoryUsage) {\n            const mem = process.memoryUsage();\n            return {\n              heapUsed: mem.heapUsed,\n              heapTotal: mem.heapTotal,\n            };\n          }\n          return { heapUsed: 0, heapTotal: 0 };\n        })(),\n      });\n\n      throw error;\n    }\n  };\n\n  // åˆ›å»ºå¸¦ç›‘æ§çš„ Server å¯¹è±¡\n  const monitoredServer = {\n    ...server,\n    fetch: monitoredFetch,\n\n    // ç›‘æ§æ–¹æ³•\n    getMonitoringStatus: () => monitor.getStatus(),\n    getMonitoringMetrics: () => monitor.getMetrics(),\n    resetMonitoring: () => monitor.reset(),\n  } as MonitoredServer;\n\n  return monitoredServer;\n}\n\n// ä¾¿æ·å‡½æ•°ï¼šåˆ›å»ºå¸¦ç›‘æ§çš„ Server\nexport function createMonitoredServer(\n  routes: any[],\n  config?: NativeMonitoringConfig,\n): MonitoredServer {\n  const { Server } = require(\"../server\");\n  const server = new Server(routes);\n  return withMonitoring(server, config);\n}\n"],"mappings":"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","names":["init_server","init_server","Server"]}