{"version":3,"sources":["../../../src/utils/validators/validators.ts"],"sourcesContent":["/**\n * Schema 验证器 - 简洁版\n *\n * 特点：\n * - WeakMap 缓存避免内存泄漏\n * - TypeCompiler JIT 编译，性能最佳\n * - 支持 FormatRegistry（需确保同一实例）\n *\n * @version 7.0.0\n */\n\nimport { Type } from \"@sinclair/typebox\";\nimport type { Static, TSchema } from \"@sinclair/typebox\";\nimport { TypeCompiler, type TypeCheck } from \"@sinclair/typebox/compiler\";\nimport { Value } from \"@sinclair/typebox/value\";\n\n// ============== 类型定义 ==============\n\n/** Schema 配置接口 */\nexport interface SchemaConfig {\n  body?: TSchema;\n  query?: TSchema;\n  params?: TSchema;\n  headers?: TSchema;\n  cookies?: TSchema;\n}\n\n/** 验证错误接口 */\nexport interface ValidationError {\n  path: string;\n  message: string;\n  code: string;\n  value?: unknown;\n}\n\n/** 验证结果 */\nexport type ValidationResult<T = unknown> =\n  | { success: true; data: T }\n  | { success: false; errors: ValidationError[] };\n\n// ============== 缓存 ==============\n\n/** 编译器缓存 - WeakMap 避免内存泄漏 */\nconst compilerCache = new WeakMap<TSchema, TypeCheck<TSchema>>();\n\n// ============== 核心函数 ==============\n\n/**\n * 获取或创建编译后的验证器\n */\nfunction getCompiledValidator<T extends TSchema>(schema: T): TypeCheck<T> {\n  let compiler = compilerCache.get(schema);\n  if (!compiler) {\n    compiler = TypeCompiler.Compile(schema);\n    compilerCache.set(schema, compiler);\n  }\n  return compiler as TypeCheck<T>;\n}\n\n/**\n * 验证单个 Schema（返回结果对象）\n */\nexport function validateSchema<T extends TSchema>(\n  schema: T,\n  data: unknown,\n): ValidationResult<Static<T>> {\n  try {\n    const compiler = getCompiledValidator(schema);\n\n    if (compiler.Check(data)) {\n      return { success: true, data: data as Static<T> };\n    }\n\n    // 收集错误\n    const errors: ValidationError[] = [];\n    for (const error of compiler.Errors(data)) {\n      errors.push({\n        path: error.path,\n        message: error.message,\n        code: \"VALIDATION_FAILED\",\n        value: error.value,\n      });\n    }\n    return { success: false, errors };\n  } catch (error) {\n    return {\n      success: false,\n      errors: [\n        {\n          path: \"\",\n          message: error instanceof Error ? error.message : \"验证异常\",\n          code: \"VALIDATION_EXCEPTION\",\n        },\n      ],\n    };\n  }\n}\n\n/**\n * 验证 Schema（抛出异常版本，用于框架内部）\n */\nexport function validateSchemaOrThrow<T extends TSchema>(\n  schema: T,\n  data: unknown,\n  context: string,\n): Static<T> {\n  const compiler = getCompiledValidator(schema);\n\n  if (!compiler.Check(data)) {\n    throw new Error(`${context}验证失败`);\n  }\n\n  return data as Static<T>;\n}\n\n/**\n * 快速验证（只返回布尔值）\n */\nexport function validateFast<T extends TSchema>(\n  schema: T,\n  data: unknown,\n): data is Static<T> {\n  const compiler = getCompiledValidator(schema);\n  return compiler.Check(data);\n}\n\n/**\n * 批量验证所有 Schema（用于请求验证）\n */\nexport function validateAllSchemas(\n  config: SchemaConfig,\n  data: {\n    body: unknown;\n    query: unknown;\n    params: unknown;\n    headers: unknown;\n    cookies: unknown;\n  },\n): typeof data {\n  if (config.body) {\n    validateSchemaOrThrow(config.body, data.body, \"请求体\");\n  }\n  if (config.query) {\n    validateSchemaOrThrow(config.query, data.query, \"Query参数\");\n  }\n  if (config.params) {\n    validateSchemaOrThrow(config.params, data.params, \"路径参数\");\n  }\n  if (config.headers) {\n    validateSchemaOrThrow(config.headers, data.headers, \"请求头\");\n  }\n  if (config.cookies) {\n    validateSchemaOrThrow(config.cookies, data.cookies, \"Cookie\");\n  }\n  return data;\n}\n\n/**\n * 预编译 Schema（启动时调用，避免首次请求开销）\n */\nexport function precompileSchemas(config: SchemaConfig): void {\n  if (config.body) getCompiledValidator(config.body);\n  if (config.query) getCompiledValidator(config.query);\n  if (config.params) getCompiledValidator(config.params);\n  if (config.headers) getCompiledValidator(config.headers);\n  if (config.cookies) getCompiledValidator(config.cookies);\n}\n\n/**\n * 创建类型特化的验证器（高频使用场景）\n */\nexport function createValidator<T extends TSchema>(\n  schema: T,\n): (data: unknown) => ValidationResult<Static<T>> {\n  return (data: unknown) => validateSchema(schema, data);\n}\n\n/**\n * 获取缓存统计（调试用）\n */\nexport function getValidatorCacheStats(): { cacheType: string; note: string } {\n  return {\n    cacheType: \"WeakMap\",\n    note: \"WeakMap 缓存会随 Schema 对象自动清理，无内存泄漏风险\",\n  };\n}\n\n// 导出 TypeBox 类型\nexport { Type, Static, TSchema };\n"],"mappings":";AAWA,SAAS,YAAY;AAErB,SAAS,oBAAoC;AA8B7C,IAAM,gBAAgB,oBAAI,QAAqC;AAO/D,SAAS,qBAAwC,QAAyB;AACxE,MAAI,WAAW,cAAc,IAAI,MAAM;AACvC,MAAI,CAAC,UAAU;AACb,eAAW,aAAa,QAAQ,MAAM;AACtC,kBAAc,IAAI,QAAQ,QAAQ;AAAA,EACpC;AACA,SAAO;AACT;AAKO,SAAS,eACd,QACA,MAC6B;AAC7B,MAAI;AACF,UAAM,WAAW,qBAAqB,MAAM;AAE5C,QAAI,SAAS,MAAM,IAAI,GAAG;AACxB,aAAO,EAAE,SAAS,MAAM,KAAwB;AAAA,IAClD;AAGA,UAAM,SAA4B,CAAC;AACnC,eAAW,SAAS,SAAS,OAAO,IAAI,GAAG;AACzC,aAAO,KAAK;AAAA,QACV,MAAM,MAAM;AAAA,QACZ,SAAS,MAAM;AAAA,QACf,MAAM;AAAA,QACN,OAAO,MAAM;AAAA,MACf,CAAC;AAAA,IACH;AACA,WAAO,EAAE,SAAS,OAAO,OAAO;AAAA,EAClC,SAAS,OAAO;AACd,WAAO;AAAA,MACL,SAAS;AAAA,MACT,QAAQ;AAAA,QACN;AAAA,UACE,MAAM;AAAA,UACN,SAAS,iBAAiB,QAAQ,MAAM,UAAU;AAAA,UAClD,MAAM;AAAA,QACR;AAAA,MACF;AAAA,IACF;AAAA,EACF;AACF;AAKO,SAAS,sBACd,QACA,MACA,SACW;AACX,QAAM,WAAW,qBAAqB,MAAM;AAE5C,MAAI,CAAC,SAAS,MAAM,IAAI,GAAG;AACzB,UAAM,IAAI,MAAM,GAAG,OAAO,0BAAM;AAAA,EAClC;AAEA,SAAO;AACT;AAKO,SAAS,aACd,QACA,MACmB;AACnB,QAAM,WAAW,qBAAqB,MAAM;AAC5C,SAAO,SAAS,MAAM,IAAI;AAC5B;AAKO,SAAS,mBACd,QACA,MAOa;AACb,MAAI,OAAO,MAAM;AACf,0BAAsB,OAAO,MAAM,KAAK,MAAM,oBAAK;AAAA,EACrD;AACA,MAAI,OAAO,OAAO;AAChB,0BAAsB,OAAO,OAAO,KAAK,OAAO,mBAAS;AAAA,EAC3D;AACA,MAAI,OAAO,QAAQ;AACjB,0BAAsB,OAAO,QAAQ,KAAK,QAAQ,0BAAM;AAAA,EAC1D;AACA,MAAI,OAAO,SAAS;AAClB,0BAAsB,OAAO,SAAS,KAAK,SAAS,oBAAK;AAAA,EAC3D;AACA,MAAI,OAAO,SAAS;AAClB,0BAAsB,OAAO,SAAS,KAAK,SAAS,QAAQ;AAAA,EAC9D;AACA,SAAO;AACT;AAKO,SAAS,kBAAkB,QAA4B;AAC5D,MAAI,OAAO,KAAM,sBAAqB,OAAO,IAAI;AACjD,MAAI,OAAO,MAAO,sBAAqB,OAAO,KAAK;AACnD,MAAI,OAAO,OAAQ,sBAAqB,OAAO,MAAM;AACrD,MAAI,OAAO,QAAS,sBAAqB,OAAO,OAAO;AACvD,MAAI,OAAO,QAAS,sBAAqB,OAAO,OAAO;AACzD;AAKO,SAAS,gBACd,QACgD;AAChD,SAAO,CAAC,SAAkB,eAAe,QAAQ,IAAI;AACvD;AAKO,SAAS,yBAA8D;AAC5E,SAAO;AAAA,IACL,WAAW;AAAA,IACX,MAAM;AAAA,EACR;AACF;","names":[]}