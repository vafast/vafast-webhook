import { RouteSchema, HandlerContext } from '../types/schema.js';
import '@sinclair/typebox';

/**
 * Server-Sent Events (SSE) 支持
 *
 * 用于实现流式响应，如 AI 聊天、实时通知等
 *
 * @example
 * ```typescript
 * import { createSSEHandler, Type } from 'vafast'
 *
 * const streamHandler = createSSEHandler(
 *   { query: Type.Object({ prompt: Type.String() }) },
 *   async function* ({ query }) {
 *     yield { event: 'start', data: { message: 'Starting...' } }
 *
 *     for await (const chunk of aiStream(query.prompt)) {
 *       yield { data: chunk }
 *     }
 *
 *     yield { event: 'end', data: { message: 'Done!' } }
 *   }
 * )
 * ```
 */

/**
 * SSE 事件类型
 */
interface SSEEvent<T = unknown> {
    /** 事件名称（可选，默认为 message） */
    event?: string;
    /** 事件数据 */
    data: T;
    /** 事件 ID（可选） */
    id?: string;
    /** 重试间隔（毫秒，可选） */
    retry?: number;
}
/**
 * SSE 生成器函数类型
 */
type SSEGenerator<T extends RouteSchema = RouteSchema> = (ctx: HandlerContext<T>) => AsyncGenerator<SSEEvent<unknown>, void, unknown>;
/**
 * SSE 标记类型 - 使用字面量品牌类型
 */
type SSEMarker = {
    readonly __brand: 'SSE';
};
/**
 * SSE Handler 类型标记
 */
interface SSEHandler<TSchema extends RouteSchema = RouteSchema> {
    (req: Request): Promise<Response>;
    /** 返回类型标记 - SSE 流的数据类型 */
    readonly __returnType: unknown;
    /** Schema 类型标记 */
    readonly __schema: TSchema;
    /** SSE 标记 - 使用品牌类型确保不被扩展 */
    readonly __sse: SSEMarker;
}
/**
 * 创建 SSE 流式响应处理器
 *
 * @example
 * ```typescript
 * // 基础用法
 * const streamChat = createSSEHandler(
 *   { query: Type.Object({ message: Type.String() }) },
 *   async function* ({ query }) {
 *     const response = await ai.chat(query.message);
 *
 *     for await (const chunk of response) {
 *       yield { data: { text: chunk } };
 *     }
 *   }
 * );
 *
 * // 使用路由
 * route('GET', '/chat/stream', streamChat)
 * ```
 */
declare function createSSEHandler<const T extends RouteSchema>(schema: T, generator: SSEGenerator<T>): SSEHandler<T>;
declare function createSSEHandler(generator: SSEGenerator<RouteSchema>): SSEHandler<RouteSchema>;

export { type SSEEvent, type SSEGenerator, type SSEHandler, type SSEMarker, createSSEHandler };
