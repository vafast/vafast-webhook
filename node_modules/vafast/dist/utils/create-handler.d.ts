import { RouteSchema, HandlerContext, HandlerContextWithExtra } from '../types/schema.js';
import '@sinclair/typebox';

/**
 * 类型安全的路由处理器工厂
 *
 * 非柯里化设计，API 更简洁
 *
 * @author Framework Team
 * @version 3.0.0
 * @license MIT
 */

/** 空 schema 的上下文类型 */
type EmptySchemaContext = {
    req: Request;
    body: unknown;
    query: Record<string, string>;
    params: Record<string, string>;
    headers: Record<string, string>;
    cookies: Record<string, string>;
};
/**
 * 创建类型安全的路由处理器
 *
 * @example
 * ```typescript
 * // 无 schema - 直接传入 handler
 * createHandler(({ params }) => `User: ${params.id}`)
 *
 * // 有 schema - 传入 schema 和 handler
 * createHandler(
 *   { body: Type.Object({ name: Type.String() }) },
 *   ({ body }) => ({ hello: body.name })
 * )
 * ```
 */
/**
 * 带类型推断的 Handler - 保留返回类型信息用于客户端类型推断
 */
type InferableHandler<TReturn, TSchema extends RouteSchema = RouteSchema> = ((req: Request) => Promise<Response>) & {
    /** 返回类型标记（仅用于类型推断，运行时不存在） */
    __returnType: TReturn;
    /** Schema 类型标记 */
    __schema: TSchema;
};
declare function createHandler<R>(handler: (ctx: EmptySchemaContext) => R | Promise<R>): InferableHandler<R>;
declare function createHandler<const T extends RouteSchema, R>(schema: T, handler: (ctx: HandlerContext<T>) => R | Promise<R>): InferableHandler<R, T>;
/**
 * 创建带额外上下文的路由处理器
 *
 * 用于中间件注入额外数据的场景
 *
 * @example
 * ```typescript
 * // 定义中间件注入的类型
 * type AuthContext = { user: { id: string; role: string } };
 *
 * // 无 schema
 * createHandlerWithExtra<AuthContext>(({ user }) => {
 *   return { userId: user.id };
 * })
 *
 * // 有 schema
 * createHandlerWithExtra<AuthContext>(
 *   { body: Type.Object({ action: Type.String() }) },
 *   ({ body, user }) => ({ success: true, userId: user.id })
 * )
 * ```
 */
declare function createHandlerWithExtra<TExtra extends Record<string, unknown> = Record<string, never>, R = unknown>(handler: (ctx: EmptySchemaContext & TExtra) => R | Promise<R>): (req: Request) => Promise<Response>;
declare function createHandlerWithExtra<TExtra extends Record<string, unknown> = Record<string, never>, const T extends RouteSchema = RouteSchema, R = unknown>(schema: T, handler: (ctx: HandlerContextWithExtra<T, TExtra>) => R | Promise<R>): (req: Request) => Promise<Response>;
/**
 * 简单的路由处理器 (无 schema 验证，只有 req)
 *
 * @example
 * ```typescript
 * simpleHandler(({ req }) => {
 *   return { message: "Hello World" };
 * })
 * ```
 */
declare function simpleHandler<R>(handler: (ctx: {
    req: Request;
}) => R | Promise<R>): (req: Request) => Promise<Response>;

export { type InferableHandler, createHandler, createHandlerWithExtra, simpleHandler };
